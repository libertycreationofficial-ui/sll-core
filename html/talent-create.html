<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - タレント登録</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.95)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 22px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff8ff, #b0d9ff);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 14px rgba(154,123,255,0.45);
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-main {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11px;
    }

    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--danger);
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible { display: block; }

    .success-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--success);
      background: #e6f4ea;
      border: 1px solid #c8e6c9;
      margin-top: 4px;
    }

    .success-banner.visible { display: block; }

    .form-card {
      background: var(--sl-card);
      border-radius: 22px;
      padding: 18px 18px 20px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 24px rgba(186,199,255,0.45);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 18px;
    }

    /* プラットフォームID用のグリッド */
    .platform-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }

    @media (max-width: 860px) {
      .page { padding: 16px 12px 24px; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .form-grid { grid-template-columns: 1fr; }
      .platform-grid { grid-template-columns: 1fr; }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 12px;
      color: var(--sl-text);
    }

    label span {
      font-size: 10px;
      color: var(--sl-muted);
      margin-left: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #fdfdff;
      color: var(--sl-text);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    textarea {
      border-radius: 14px;
      min-height: 70px;
      resize: vertical;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 2px rgba(195,130,255,0.25);
      background: #ffffff;
    }

    .links-block {
      margin-top: 8px;
      border-radius: 16px;
      padding: 10px 10px 8px;
      background: #f7f5ff;
      border: 1px dashed #d8cef7;
    }

    .links-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .links-row input {
      flex: 1;
      border-radius: 999px;
    }

    .btn-link-remove {
      padding: 5px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #e0d5ff;
      background: #ffffff;
      cursor: pointer;
    }

    .links-hint {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 4px;
    }

    .helper-text {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 2px;
    }

    .password-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .password-row input { flex: 1; }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    .footer-actions {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .loading-text {
      font-size: 11px;
      color: var(--sl-muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <!-- ロゴ画像のパスは環境に合わせて変更 -->
          <div class="brand-logo">
            <img src="../assets/sll-logo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-main">Star Little Luna</div>
            <div class="brand-text-sub">New Talent Registration</div>
          </div>
        </div>
        <div class="tag">Management / New Talent</div>
        <div class="page-title">タレント登録フォーム</div>
        <div class="page-subtitle">
          Firebase Auth アカウントとタレントマスタ情報を同時に作成します。
        </div>
      </div>

      <div class="user-block">
        <button class="btn btn-sm" id="back-management-btn">マネジメントメニューへ</button>
        <button class="btn btn-sm" id="back-dashboard-btn">ダッシュボードへ</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn btn-sm" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <div id="error-banner" class="error-banner"></div>
    <div id="success-banner" class="success-banner"></div>

    <div class="form-card">
      <form id="talent-form">
        <div class="form-grid">
          <!-- ID -->
          <div class="field">
            <label for="talentId">
              タレントID <span>(空なら自動採番)</span>
            </label>
            <input id="talentId" type="text" placeholder="例: TL-0001" />
            <div class="helper-text">
              社内で管理するID。未入力の場合は「TL-」＋タイムスタンプで自動生成。
            </div>
          </div>

          <!-- タレント名 -->
          <div class="field">
            <label for="talentName">タレント名 <span>※必須</span></label>
            <input id="talentName" type="text" required placeholder="例: 綺星ルナ" />
          </div>

          <!-- 本名 -->
          <div class="field">
            <label for="realName">本名 <span>※管理者のみ閲覧</span></label>
            <input id="realName" type="text" placeholder="例: 山田 花子" />
          </div>

          <!-- ふりがな -->
          <div class="field">
            <label for="furigana">ふりがな</label>
            <input id="furigana" type="text" placeholder="例: やまだ はなこ" />
          </div>

          <!-- 生年月日 -->
          <div class="field">
            <label for="birthday">生年月日</label>
            <input id="birthday" type="date" />
          </div>

          <!-- 住所 -->
          <div class="field">
            <label for="address">住所</label>
            <textarea id="address" placeholder="例: 東京都渋谷区道玄坂…"></textarea>
          </div>

          <!-- メインカテゴリ -->
          <div class="field">
            <label for="mainCategory">メインカテゴリ <span>※必須</span></label>
            <select id="mainCategory" required>
              <option value="">選択してください</option>
              <option value="Vtuber">Vtuber</option>
              <option value="Streamer">ストリーマー</option>
              <option value="MixChannel">ミクチャ</option>
              <option value="TikTok">TikTok</option>
              <option value="IRIAM">IRIAM</option>
              <option value="Creator">Creator</option>
              <option value="palmu">palmu</option>
              <option value="Mirrativ">Mirrativ</option>
            </select>
          </div>

          <!-- メールアドレス -->
          <div class="field">
            <label for="email">メールアドレス <span>※ログインID</span></label>
            <input id="email" type="email" required placeholder="talent@example.com" />
          </div>

          <!-- 初期パスワード -->
          <div class="field">
            <label for="password">初期パスワード <span>※6文字以上</span></label>
            <div class="password-row">
              <input id="password" type="password" required minlength="6" />
              <button type="button" class="btn btn-sm" id="toggle-password">表示</button>
              <button type="button" class="btn btn-sm" id="generate-password">自動生成</button>
            </div>
            <div class="helper-text">
              6文字以上。タレント本人には別途安全な手段で共有してください。
            </div>
          </div>
        </div>

        <!-- 担当マネージャー（プルダウン） -->
        <div class="field" style="margin-top:14px;">
          <label for="managerUserId">
            担当マネージャー <span>※任意／プルダウン</span>
          </label>
          <select id="managerUserId">
            <option value="">担当未設定（あとから変更可）</option>
          </select>
          <div class="helper-text">
            Firestore の <code>users</code> コレクションから
            <strong>マネージャー権限（isManager）を持つ staff / executive</strong> を自動で取得して表示します。
          </div>
        </div>

        <!-- 配信プラットフォームID（platformIds） -->
        <div class="field" style="margin-top:14px;">
          <label>配信プラットフォームID <span>※API連携用／任意</span></label>
          <div class="helper-text">
            Cloud Functions から各プラットフォームAPIを叩くときに利用します。未入力のものは取得対象外になります。
          </div>
          <div class="platform-grid">
            <div class="field">
              <label for="platformYoutube">YouTube チャンネルID</label>
              <input id="platformYoutube" type="text" placeholder="例: UCxxxxxxxxxxxx" />
            </div>
            <div class="field">
              <label for="platformX">X（Twitter）ユーザー名</label>
              <input id="platformX" type="text" placeholder="例: luna_official" />
            </div>
            <div class="field">
              <label for="platformInstagram">Instagram ユーザー名</label>
              <input id="platformInstagram" type="text" placeholder="例: luna_insta" />
            </div>
            <div class="field">
              <label for="platformTikTok">TikTok ユーザー名</label>
              <input id="platformTikTok" type="text" placeholder="例: luna_tiktok" />
            </div>
            <div class="field">
              <label for="platformTwitch">Twitch ログイン名</label>
              <input id="platformTwitch" type="text" placeholder="例: lunalive" />
            </div>
            <div class="field">
              <label for="platformIRIAM">IRIAM ID</label>
              <input id="platformIRIAM" type="text" placeholder="例: xxxx" />
            </div>
            <div class="field">
              <label for="platformPalmu">palmu ID</label>
              <input id="platformPalmu" type="text" placeholder="例: xxxx" />
            </div>
            <div class="field">
              <label for="platformMirrativ">Mirrativ ID</label>
              <input id="platformMirrativ" type="text" placeholder="例: xxxx" />
            </div>
            <div class="field">
              <label for="platformMixch">ミクチャ ID</label>
              <input id="platformMixch" type="text" placeholder="例: xxxx" />
            </div>
          </div>
        </div>

        <!-- 各種リンク -->
        <div class="field" style="margin-top:16px;">
          <label>各種リンク <span>※任意／追加可</span></label>
          <div class="links-block">
            <div id="links-container"></div>
            <button type="button" class="btn btn-sm" id="add-link-btn">＋リンクを追加</button>
            <div class="links-hint">
              YouTubeチャンネル、X（Twitter）、Instagram、各配信プラットフォームURLなど。
            </div>
          </div>
        </div>

        <!-- メモ -->
        <div class="field" style="margin-top:14px;">
          <label for="note">メモ（任意）</label>
          <textarea id="note" placeholder="得意ジャンル・注意事項など"></textarea>
        </div>

        <div class="footer-actions">
          <span id="loading-text" class="loading-text"></span>
          <button type="submit" class="btn btn-primary" id="submit-btn">
            タレント登録を実行する
          </button>
        </div>

        <div class="helper-text" style="margin-top:6px;">
          <span class="badge-pill">作成内容</span>
          Firebase Authユーザー（roleType: "talent"）と Firestore:
          users/{uid}, talents/{talentId} を同時に作成します。
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase + ロジック -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp,
      collection,
      getDocs,
      query,
      where,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ==== Firebase初期化（1回だけ） ====
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    // メイン（ログイン中の管理者）用 Auth / DB
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 新規タレント作成用にセカンダリApp（管理者がログアウトされないように）
    const secondaryApp = initializeApp(firebaseConfig, "secondary");
    const secondaryAuth = getAuth(secondaryApp);

    // ==== DOM取得 ====
    const errorBanner = document.getElementById("error-banner");
    const successBanner = document.getElementById("success-banner");
    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");

    const logoutBtn = document.getElementById("logout-btn");
    const backDashboardBtn = document.getElementById("back-dashboard-btn");
    const backManagementBtn = document.getElementById("back-management-btn");

    const talentForm = document.getElementById("talent-form");
    const submitBtn = document.getElementById("submit-btn");
    const loadingText = document.getElementById("loading-text");

    const talentIdInput = document.getElementById("talentId");
    const talentNameInput = document.getElementById("talentName");
    const realNameInput = document.getElementById("realName");
    const furiganaInput = document.getElementById("furigana");
    const birthdayInput = document.getElementById("birthday");
    const addressInput = document.getElementById("address");
    const mainCategorySelect = document.getElementById("mainCategory");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const noteInput = document.getElementById("note");

    const togglePasswordBtn = document.getElementById("toggle-password");
    const generatePasswordBtn = document.getElementById("generate-password");

    const linksContainer = document.getElementById("links-container");
    const addLinkBtn = document.getElementById("add-link-btn");

    // プラットフォームID入力
    const platformYoutubeInput = document.getElementById("platformYoutube");
    const platformXInput = document.getElementById("platformX");
    const platformInstagramInput = document.getElementById("platformInstagram");
    const platformTikTokInput = document.getElementById("platformTikTok");
    const platformTwitchInput = document.getElementById("platformTwitch");
    const platformIRIAMInput = document.getElementById("platformIRIAM");
    const platformPalmuInput = document.getElementById("platformPalmu");
    const platformMirrativInput = document.getElementById("platformMirrativ");
    const platformMixchInput = document.getElementById("platformMixch");

    // 担当マネージャー（プルダウン）
    const managerUserIdSelect = document.getElementById("managerUserId");

    // ==== 共通関数 ====
    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }
    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }
    function showSuccess(msg) {
      successBanner.textContent = msg;
      successBanner.classList.add("visible");
    }
    function hideSuccess() {
      successBanner.textContent = "";
      successBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    // リンク入力行の追加
    function addLinkRow(initialValue = "") {
      const row = document.createElement("div");
      row.className = "links-row";

      const input = document.createElement("input");
      input.type = "url";
      input.placeholder = "https://...";
      input.value = initialValue;

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "btn-link-remove";
      removeBtn.textContent = "削除";
      removeBtn.addEventListener("click", () => row.remove());

      row.appendChild(input);
      row.appendChild(removeBtn);
      linksContainer.appendChild(row);
    }
    addLinkBtn.addEventListener("click", () => addLinkRow());
    // 初期1行
    addLinkRow();

    // パスワード表示切替
    togglePasswordBtn.addEventListener("click", () => {
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        togglePasswordBtn.textContent = "非表示";
      } else {
        passwordInput.type = "password";
        togglePasswordBtn.textContent = "表示";
      }
    });

    // パスワード自動生成
    function generateRandomPassword(length = 12) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    generatePasswordBtn.addEventListener("click", () => {
      passwordInput.value = generateRandomPassword();
    });

    // 戻る・ログアウト
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });
    backDashboardBtn.addEventListener("click", () => {
      window.location.href = "./dashboard.html";
    });
    backManagementBtn.addEventListener("click", () => {
      window.location.href = "./management.html";
    });

    // 担当マネージャー一覧の読み込み
    async function loadManagers() {
      // 初期化
      managerUserIdSelect.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = "担当未設定（あとから変更可）";
      managerUserIdSelect.appendChild(defaultOpt);

      try {
        // roleType: staff / executive かつ isManager == true
        const qManagers = query(
          collection(db, "users"),
          where("roleType", "in", ["staff", "executive"]),
          where("isManager", "==", true)
        );
        const snap = await getDocs(qManagers);

        const list = [];
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          list.push({
            uid: docSnap.id,
            name: d.displayName || d.realName || "No Name",
            dept: d.dept || "",
          });
        });

        // 名前順（日本語対応）
        list.sort((a, b) => a.name.localeCompare(b.name, "ja"));

        for (const m of list) {
          const opt = document.createElement("option");
          opt.value = m.uid;
          const deptPart = m.dept ? ` / ${m.dept}` : "";
          opt.textContent = `${m.name}${deptPart}`;
          managerUserIdSelect.appendChild(opt);
        }
      } catch (err) {
        console.error("loadManagers error:", err);
        showError("担当マネージャー一覧の取得中にエラーが発生しました。");
      }
    }

    // ==== ログインユーザー情報 ====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../login.html";
        return;
      }
      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          return;
        }
        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        // タレントはこのページNG
        if (roleType === "talent") {
          showError("このページはタレントアカウントからは利用できません。");
          setTimeout(() => {
            window.location.href = "./dashboard.html";
          }, 1500);
          return;
        }

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        // ログインチェックが通ったらマネージャー一覧をロード
        await loadManagers();
      } catch (err) {
        console.error(err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
      }
    });

    // ==== タレント登録処理 ====
    talentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();
      hideSuccess();

      const talentName = talentNameInput.value.trim();
      const mainCategory = mainCategorySelect.value;
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!talentName || !mainCategory || !email || !password) {
        showError("必須項目（タレント名／メインカテゴリ／メールアドレス／初期パスワード）を入力してください。");
        return;
      }
      if (password.length < 6) {
        showError("初期パスワードは6文字以上にしてください。");
        return;
      }

      submitBtn.disabled = true;
      loadingText.textContent = "タレントアカウントを作成しています…";

      try {
        // 1. セカンダリAuthで新規ユーザー作成（管理者ログインは維持）
        const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
        const uid = cred.user.uid;

        // 2. タレントID決定
        let talentId = talentIdInput.value.trim();
        if (!talentId) talentId = "TL-" + Date.now();

        // 3. リンク配列
        const links = [];
        linksContainer.querySelectorAll("input[type='url']").forEach(input => {
          const v = input.value.trim();
          if (v) links.push(v);
        });

        // 4. platformIds オブジェクト構築（空文字は含めない）
        const platformIds = {};
        const yt = platformYoutubeInput.value.trim();
        const x = platformXInput.value.trim();
        const ig = platformInstagramInput.value.trim();
        const tt = platformTikTokInput.value.trim();
        const tw = platformTwitchInput.value.trim();
        const ir = platformIRIAMInput.value.trim();
        const pm = platformPalmuInput.value.trim();
        const mr = platformMirrativInput.value.trim();
        const mx = platformMixchInput.value.trim();

        if (yt) platformIds.youtube = yt;
        if (x) platformIds.x = x;
        if (ig) platformIds.instagram = ig;
        if (tt) platformIds.tiktok = tt;
        if (tw) platformIds.twitch = tw;
        if (ir) platformIds.iriam = ir;
        if (pm) platformIds.palmu = pm;
        if (mr) platformIds.mirrativ = mr;
        if (mx) platformIds.mixch = mx;

        // プルダウンで選択された担当マネージャーUID
        const managerUserId = managerUserIdSelect.value || null;

        // 5. Firestore: users/{uid}
        await setDoc(doc(db, "users", uid), {
          uid,
          talentId,
          displayName: talentName,
          realName: realNameInput.value.trim() || null,
          furigana: furiganaInput.value.trim() || null,
          birthday: birthdayInput.value || null,
          address: addressInput.value.trim() || null,
          mainCategory,
          email,
          roleType: "talent",
          isManager: false,
          isAdmin: false,
          links,
          note: noteInput.value.trim() || null,
          // 追加情報
          managerUserId: managerUserId,
          platformIds: Object.keys(platformIds).length ? platformIds : null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });

        // 6. Firestore: talents/{talentId}
        await setDoc(doc(db, "talents", talentId), {
          talentId,
          uid,
          name: talentName,
          realName: realNameInput.value.trim() || null,
          furigana: furiganaInput.value.trim() || null,
          birthday: birthdayInput.value || null,
          address: addressInput.value.trim() || null,
          mainCategory,
          email,
          links,
          note: noteInput.value.trim() || null,
          status: "active",
          // 追加: API連携・マネージャー情報
          platformIds: Object.keys(platformIds).length ? platformIds : null,
          managerId: managerUserId,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });

        showSuccess("タレントアカウントの作成が完了しました。初期パスワードをタレント本人に共有してください。");
        loadingText.textContent = "";
        passwordInput.value = "";
      } catch (err) {
        console.error(err);
        let msg = "タレントアカウントの作成中にエラーが発生しました。";
        if (err.code === "auth/email-already-in-use") {
          msg = "このメールアドレスは既に別のアカウントで使用されています。";
        } else if (err.code === "auth/invalid-email") {
          msg = "メールアドレスの形式が正しくありません。";
        } else if (err.code === "auth/weak-password") {
          msg = "パスワードが弱すぎます。6文字以上かつ推測されにくいものにしてください。";
        }
        showError(msg);
        loadingText.textContent = "";
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
