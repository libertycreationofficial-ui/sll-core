<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna - ãƒã‚¤é¢è«‡ãƒ»å‹¤æ€ ãƒ»ã‚·ãƒ•ãƒˆ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      background: #f5f7ff;
      padding: 20px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    h2 {
      margin-top: 26px;
      padding-left: 8px;
      border-left: 5px solid #c382ff;
      font-size: 16px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .top-right {
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #c382ff, #ff8ad8);
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.secondary {
      background: #e1e4ff;
      color: #333;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    label {
      display: block;
      font-size: 12px;
      margin-top: 8px;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #d0d4ea;
      font-size: 13px;
      box-sizing: border-box;
      background: #fafbff;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3f0;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f2f3ff;
      font-weight: 600;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .msg {
      font-size: 12px;
      margin-top: 6px;
      color: #555;
    }
    .error { color: #d32f2f; }
    .success { color: #0f9d58; }

    .status-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }
    .status-pending { background: #ffb74d; }
    .status-accepted { background: #4caf50; }
    .status-rejected { background: #e53935; }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>ğŸŒ™ Star Little Luna - ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆé¢è«‡ãƒ»å‹¤æ€ ãƒ»ã‚·ãƒ•ãƒˆï¼‰</h1>
      <div class="small" id="userInfo">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
    </div>
    <div class="top-right">
      <button id="backDashboardBtn" class="secondary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</button>
      <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- â‘  é¢è«‡ï¼šæ–°è¦äºˆç´„ ï¼‹ è‡ªåˆ†ã¸ã®è¿”ç­”ä¸€è¦§ -->
  <h2>â‘  é¢è«‡äºˆç´„ã¨è¿”ç­”</h2>
  <div class="section">
    <div class="small">
      ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ»ç¤¾å“¡ã¸ã®é¢è«‡ã‚’äºˆç´„ã§ãã¾ã™ã€‚<br />
      ä¸‹ã«è‡ªåˆ†ã®é¢è«‡å±¥æ­´ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆä¿ç•™ï¼æ‰¿èªï¼å´ä¸‹ï¼‰ãƒ»è¿”ä¿¡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>

    <label>å¸Œæœ›æ—¥</label>
    <input type="date" id="interviewDate" />

    <label>å¸Œæœ›æ™‚é–“</label>
    <input type="time" id="interviewTime" />

    <label>é¢è«‡ã®å†…å®¹ãƒ»ç›¸è«‡ã—ãŸã„ã“ã¨</label>
    <textarea id="interviewReason" placeholder="ä¾‹ï¼šä»Šå¾Œã®æ´»å‹•æ–¹é‡ã«ã¤ã„ã¦ç›¸è«‡ã—ãŸã„ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´ãªã©"></textarea>

    <button id="sendInterviewBtn">é¢è«‡ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹</button>
    <div id="interviewMsg" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th style="width:18%;">å¸Œæœ›æ—¥æ™‚</th>
          <th style="width:36%;">å†…å®¹</th>
          <th style="width:12%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th style="width:34%;">é‹å–¶ã‹ã‚‰ã®ãƒ¡ãƒ¢ãƒ»è¿”ç­”</th>
        </tr>
      </thead>
      <tbody id="meetingHistoryBody">
        <tr><td colspan="4" class="small">é¢è«‡å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘¡ å‹¤æ€ ï¼šä»Šæ—¥ã®æ‰“åˆ» ï¼‹ æœ€è¿‘ã®å±¥æ­´ -->
  <h2>â‘¡ å‹¤æ€ ï¼ˆå‡ºå‹¤ãƒ»é€€å‹¤ï¼‰</h2>
  <div class="section">
    <div class="small" id="attendanceToday">æœ¬æ—¥ã®å‹¤æ€ ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    <button id="startWorkBtn">å‡ºå‹¤</button>
    <button id="endWorkBtn" class="secondary">é€€å‹¤</button>
    <div id="attendanceMsg" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>å‡ºå‹¤</th>
          <th>é€€å‹¤</th>
        </tr>
      </thead>
      <tbody id="attendanceHistoryBody">
        <tr><td colspan="3" class="small">ç›´è¿‘ã®å‹¤æ€ å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘¢ ä»Šæœˆã®ã‚·ãƒ•ãƒˆ -->
  <h2>â‘¢ ä»Šæœˆã®ã‚·ãƒ•ãƒˆ</h2>
  <div class="section">
    <div class="small">
      ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒç™»éŒ²ã—ãŸã€ã‚ãªãŸã®ä»Šæœˆã®ã‚·ãƒ•ãƒˆã§ã™ã€‚
    </div>
    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>é–‹å§‹</th>
          <th>çµ‚äº†</th>
        </tr>
      </thead>
      <tbody id="shiftTableBody">
        <tr><td colspan="3" class="small">ã‚·ãƒ•ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘£ ã‚·ãƒ•ãƒˆå¸Œæœ› -->
  <h2>â‘£ ã‚·ãƒ•ãƒˆå¸Œæœ›</h2>
  <div class="section">
    <div class="small">
      å¸Œæœ›ã‚·ãƒ•ãƒˆã‚’é‹å–¶ã«æå‡ºã§ãã¾ã™ï¼ˆè¤‡æ•°æ—¥åˆ†ã‚’é€ä¿¡å¯èƒ½ï¼‰ã€‚<br />
      ä¸‹ã«é€ä¿¡æ¸ˆã¿ã®å¸Œæœ›ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>

    <label>å¸Œæœ›æ—¥</label>
    <input type="date" id="shiftWishDate" />

    <label>å¸Œæœ›æ™‚é–“å¸¯</label>
    <div style="display:flex; gap:8px;">
      <div style="flex:1;">
        <span class="small">é–‹å§‹</span>
        <input type="time" id="shiftWishStart" />
      </div>
      <div style="flex:1;">
        <span class="small">çµ‚äº†</span>
        <input type="time" id="shiftWishEnd" />
      </div>
    </div>

    <label>è£œè¶³ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="shiftWishNote" placeholder="ä¾‹ï¼šã“ã®æ—¥ã¯21æ™‚ã¾ã§ãªã‚‰å¯¾å¿œå¯èƒ½ã§ã™"></textarea>

    <button id="sendShiftWishBtn">ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã™ã‚‹</button>
    <div id="shiftWishMsg" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th style="width:18%;">æ—¥ä»˜</th>
          <th style="width:26%;">å¸Œæœ›æ™‚é–“</th>
          <th style="width:24%;">ãƒ¡ãƒ¢</th>
          <th style="width:16%;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th style="width:16%;">ä½œæˆæ—¥æ™‚</th>
        </tr>
      </thead>
      <tbody id="shiftWishBody">
        <tr><td colspan="5" class="small">é€ä¿¡æ¸ˆã¿ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- ================== JS / Firebase ================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      addDoc,
      collection,
      serverTimestamp,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---- Firebase config ----
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---- DOM ----
    const userInfoEl            = document.getElementById("userInfo");
    const backDashboardBtn      = document.getElementById("backDashboardBtn");
    const logoutBtn             = document.getElementById("logoutBtn");

    // é¢è«‡
    const interviewDateEl       = document.getElementById("interviewDate");
    const interviewTimeEl       = document.getElementById("interviewTime");
    const interviewReasonEl     = document.getElementById("interviewReason");
    const sendInterviewBtn      = document.getElementById("sendInterviewBtn");
    const interviewMsgEl        = document.getElementById("interviewMsg");
    const meetingHistoryBody    = document.getElementById("meetingHistoryBody");

    // å‹¤æ€ 
    const attendanceTodayEl     = document.getElementById("attendanceToday");
    const startWorkBtn          = document.getElementById("startWorkBtn");
    const endWorkBtn            = document.getElementById("endWorkBtn");
    const attendanceMsgEl       = document.getElementById("attendanceMsg");
    const attendanceHistoryBody = document.getElementById("attendanceHistoryBody");

    // ã‚·ãƒ•ãƒˆ
    const shiftTableBody        = document.getElementById("shiftTableBody");

    // ã‚·ãƒ•ãƒˆå¸Œæœ›
    const shiftWishDateEl       = document.getElementById("shiftWishDate");
    const shiftWishStartEl      = document.getElementById("shiftWishStart");
    const shiftWishEndEl        = document.getElementById("shiftWishEnd");
    const shiftWishNoteEl       = document.getElementById("shiftWishNote");
    const sendShiftWishBtn      = document.getElementById("sendShiftWishBtn");
    const shiftWishMsgEl        = document.getElementById("shiftWishMsg");
    const shiftWishBody         = document.getElementById("shiftWishBody");

    let currentUser = null;

    function setMsg(el, text, type = "") {
      el.textContent = text;
      el.className = "msg";
      if (type === "error")   el.classList.add("error");
      if (type === "success") el.classList.add("success");
    }

    function formatTimestamp(ts) {
      if (!ts || !ts.toDate) return "-";
      const d = ts.toDate();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const h = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}/${m}/${day} ${h}:${mm}`;
    }

    // ---- Auth çŠ¶æ…‹ ----
    onAuthStateChanged(auth, async (user) => {
      // ã“ã“ã§ã¯ã€Œãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªãã¦ã‚‚ç”»é¢ã¯è¡¨ç¤ºã™ã‚‹ã€
      if (!user) {
        currentUser = null;
        userInfoEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ï¼ˆæ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
        return;
      }

      currentUser = user;
      userInfoEl.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email || "ãƒ¦ãƒ¼ã‚¶ãƒ¼"}`;

      await Promise.all([
        loadMeetingHistory(),
        loadTodayAttendance(),
        loadAttendanceHistory(),
        loadShiftsThisMonth(),
        loadShiftWishes()
      ]);
    });

    // æˆ»ã‚‹ï¼†ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    backDashboardBtn.addEventListener("click", () => {
      location.href = "dashboard.html";
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      location.href = "login.html";
    });

    // ================= é¢è«‡ =================
    sendInterviewBtn.addEventListener("click", async () => {
      if (!currentUser) {
        setMsg(interviewMsgEl, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }
      const date   = interviewDateEl.value;
      const time   = interviewTimeEl.value;
      const reason = interviewReasonEl.value.trim();

      if (!date || !time || !reason) {
        setMsg(interviewMsgEl, "å¸Œæœ›æ—¥ãƒ»æ™‚é–“ãƒ»å†…å®¹ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }

      try {
        await addDoc(collection(db, "meetingRequests"), {
          uid: currentUser.uid,
          talentName: currentUser.displayName || currentUser.email || null,
          date,
          time,
          reason,
          status: "pending",
          managerNote: "",
          createdAt: serverTimestamp()
        });
        interviewDateEl.value = "";
        interviewTimeEl.value = "";
        interviewReasonEl.value = "";
        setMsg(interviewMsgEl, "é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚", "success");
        await loadMeetingHistory();
      } catch (e) {
        console.error(e);
        setMsg(interviewMsgEl, "é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    async function loadMeetingHistory() {
      if (!currentUser) return;
      try {
        const q = query(
          collection(db, "meetingRequests"),
          where("uid", "==", currentUser.uid)
        );
        const snap = await getDocs(q);
        const rows = [];
        snap.forEach((docSnap) => {
          rows.push(docSnap.data());
        });

        // æ—¥ä»˜ï¼‹æ™‚é–“ã§ã–ã£ãã‚Šé™é †ã‚½ãƒ¼ãƒˆ
        rows.sort((a, b) => {
          const keyA = (a.date || "") + " " + (a.time || "");
          const keyB = (b.date || "") + " " + (b.time || "");
          return keyA < keyB ? 1 : -1;
        });

        meetingHistoryBody.innerHTML = "";
        if (rows.length === 0) {
          meetingHistoryBody.innerHTML =
            '<tr><td colspan="4" class="small">ã¾ã é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
          return;
        }

        for (const d of rows) {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = `${d.date || "-"} ${d.time || ""}`;

          const tdReason = document.createElement("td");
          tdReason.textContent = d.reason || "";

          const tdStatus = document.createElement("td");
          const pill = document.createElement("span");
          pill.classList.add("status-pill");
          const s = d.status || "pending";
          if (s === "accepted") {
            pill.classList.add("status-accepted");
            pill.textContent = "æ‰¿èª";
          } else if (s === "rejected") {
            pill.classList.add("status-rejected");
            pill.textContent = "å´ä¸‹";
          } else {
            pill.classList.add("status-pending");
            pill.textContent = "ä¿ç•™";
          }
          tdStatus.appendChild(pill);

          const tdNote = document.createElement("td");
          tdNote.textContent = d.managerNote || "-";

          tr.appendChild(tdDate);
          tr.appendChild(tdReason);
          tr.appendChild(tdStatus);
          tr.appendChild(tdNote);
          meetingHistoryBody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        meetingHistoryBody.innerHTML =
          '<tr><td colspan="4" class="small">é¢è«‡å±¥æ­´ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }

    // ================= å‹¤æ€  =================
    async function loadTodayAttendance() {
      if (!currentUser) return;
      const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
      try {
        const ref  = doc(db, "attendance", currentUser.uid, "records", today);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          attendanceTodayEl.textContent = `æœ¬æ—¥ã®å‹¤æ€ ï¼ˆ${today}ï¼‰ï¼šæœªç™»éŒ²`;
        } else {
          const d = snap.data();
          attendanceTodayEl.textContent =
            `æœ¬æ—¥ã®å‹¤æ€ ï¼ˆ${today}ï¼‰ï¼šå‡ºå‹¤ ${d.start || "-"} / é€€å‹¤ ${d.end || "-"}`;
        }
      } catch (e) {
        console.error(e);
        attendanceTodayEl.textContent = "æœ¬æ—¥ã®å‹¤æ€ ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      }
    }

    async function loadAttendanceHistory() {
      if (!currentUser) return;
      try {
        const colRef = collection(db, "attendance", currentUser.uid, "records");
        const snap   = await getDocs(colRef);
        const items = [];
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          items.push({
            date: docSnap.id,
            start: d.start || "-",
            end: d.end || "-"
          });
        });
        // æ—¥ä»˜é€†é †
        items.sort((a, b) => (a.date < b.date ? 1 : -1));

        attendanceHistoryBody.innerHTML = "";
        if (items.length === 0) {
          attendanceHistoryBody.innerHTML =
            '<tr><td colspan="3" class="small">ã¾ã å‹¤æ€ ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
          return;
        }

        for (const item of items.slice(0, 14)) { // ç›´è¿‘14æ—¥åˆ†
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.date}</td>
            <td>${item.start}</td>
            <td>${item.end}</td>
          `;
          attendanceHistoryBody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        attendanceHistoryBody.innerHTML =
          '<tr><td colspan="3" class="small">å‹¤æ€ å±¥æ­´ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }

    startWorkBtn.addEventListener("click", async () => {
      if (!currentUser) {
        setMsg(attendanceMsgEl, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }
      const today = new Date().toISOString().slice(0, 10);
      const now   = new Date().toLocaleTimeString("ja-JP", { hour12: false });

      try {
        const ref = doc(db, "attendance", currentUser.uid, "records", today);
        await setDoc(ref, { start: now, updatedAt: serverTimestamp() }, { merge: true });
        setMsg(attendanceMsgEl, "å‡ºå‹¤ã‚’æ‰“åˆ»ã—ã¾ã—ãŸã€‚", "success");
        await loadTodayAttendance();
        await loadAttendanceHistory();
      } catch (e) {
        console.error(e);
        setMsg(attendanceMsgEl, "å‡ºå‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    endWorkBtn.addEventListener("click", async () => {
      if (!currentUser) {
        setMsg(attendanceMsgEl, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }
      const today = new Date().toISOString().slice(0, 10);
      const now   = new Date().toLocaleTimeString("ja-JP", { hour12: false });

      try {
        const ref = doc(db, "attendance", currentUser.uid, "records", today);
        await setDoc(ref, { end: now, updatedAt: serverTimestamp() }, { merge: true });
        setMsg(attendanceMsgEl, "é€€å‹¤ã‚’æ‰“åˆ»ã—ã¾ã—ãŸã€‚", "success");
        await loadTodayAttendance();
        await loadAttendanceHistory();
      } catch (e) {
        console.error(e);
        setMsg(attendanceMsgEl, "é€€å‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    // ================= ã‚·ãƒ•ãƒˆï¼ˆä»Šæœˆï¼‰ =================
    async function loadShiftsThisMonth() {
      if (!currentUser) return;
      const ym = new Date().toISOString().slice(0, 7); // "YYYY-MM"

      try {
        const colRef = collection(db, "shifts", currentUser.uid, "items");
        const snap   = await getDocs(colRef);
        const rows = [];
        snap.forEach((docSnap) => {
          const d = docSnap.data();
          if (!d.date || !d.date.startsWith(ym)) return;
          rows.push(d);
        });
        rows.sort((a, b) => (a.date > b.date ? 1 : -1));

        shiftTableBody.innerHTML = "";
        if (rows.length === 0) {
          shiftTableBody.innerHTML =
            '<tr><td colspan="3" class="small">ä»Šæœˆã®ã‚·ãƒ•ãƒˆã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>';
          return;
        }

        for (const r of rows) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.start || "-"}</td>
            <td>${r.end || "-"}</td>
          `;
          shiftTableBody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        shiftTableBody.innerHTML =
          '<tr><td colspan="3" class="small">ã‚·ãƒ•ãƒˆå–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }

    // ================= ã‚·ãƒ•ãƒˆå¸Œæœ› =================
    sendShiftWishBtn.addEventListener("click", async () => {
      if (!currentUser) {
        setMsg(shiftWishMsgEl, "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }
      const date  = shiftWishDateEl.value;
      const start = shiftWishStartEl.value;
      const end   = shiftWishEndEl.value;
      const note  = shiftWishNoteEl.value.trim();

      if (!date || !start || !end) {
        setMsg(shiftWishMsgEl, "å¸Œæœ›æ—¥ã¨é–‹å§‹ãƒ»çµ‚äº†æ™‚é–“ã¯å¿…é ˆã§ã™ã€‚", "error");
        return;
      }

      try {
        const colRef = collection(db, "shiftRequests", currentUser.uid, "items");
        await addDoc(colRef, {
          date,
          desiredStart: start,
          desiredEnd: end,
          note,
          status: "requested",
          createdAt: serverTimestamp()
        });

        shiftWishDateEl.value = "";
        shiftWishStartEl.value = "";
        shiftWishEndEl.value = "";
        shiftWishNoteEl.value = "";
        setMsg(shiftWishMsgEl, "ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚", "success");
        await loadShiftWishes();
      } catch (e) {
        console.error(e);
        setMsg(shiftWishMsgEl, "ã‚·ãƒ•ãƒˆå¸Œæœ›é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    async function loadShiftWishes() {
      if (!currentUser) return;
      try {
        const colRef = collection(db, "shiftRequests", currentUser.uid, "items");
        const snap   = await getDocs(colRef);
        const rows = [];
        snap.forEach((docSnap) => {
          rows.push(docSnap.data());
        });

        // æ—¥ä»˜é™é †
        rows.sort((a, b) => {
          const da = a.date || "";
          const dbv = b.date || "";
          return da < dbv ? 1 : -1;
        });

        shiftWishBody.innerHTML = "";
        if (rows.length === 0) {
          shiftWishBody.innerHTML =
            '<tr><td colspan="5" class="small">ã¾ã ã‚·ãƒ•ãƒˆå¸Œæœ›ã¯é€ä¿¡ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>';
          return;
        }

        for (const r of rows) {
          const statusLabel =
            r.status === "approved" ? "æ‰¿èª"
            : r.status === "rejected" ? "å´ä¸‹"
            : "ç”³è«‹ä¸­";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date || "-"}</td>
            <td>${(r.desiredStart || "-") + " ã€œ " + (r.desiredEnd || "-")}</td>
            <td>${r.note || "-"}</td>
            <td>${statusLabel}</td>
            <td>${formatTimestamp(r.createdAt)}</td>
          `;
          shiftWishBody.appendChild(tr);
        }
      } catch (e) {
        console.error(e);
        shiftWishBody.innerHTML =
          '<tr><td colspan="5" class="small">ã‚·ãƒ•ãƒˆå¸Œæœ›ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }
  </script>
</body>
</html>
