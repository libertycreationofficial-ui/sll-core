<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna - ã‚¿ãƒ¬ãƒ³ãƒˆé‹å–¶ãƒ»AIåˆ†æ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      background: #f5f7ff;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 6px;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .top-right {
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #8a9dff;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.secondary {
      background: #e1e4ff;
      color: #333;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .msg {
      font-size: 12px;
      margin-top: 6px;
      color: #555;
    }
    .error { color: #d32f2f; }
    .success { color: #0f9d58; }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"],
    select,
    input[type="date"] {
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d0d4ea;
      background: #fafbff;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 260px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3f0;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f2f3ff;
      font-weight: 600;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 700px) {
      .metric-grid {
        grid-template-columns: 1fr;
      }
    }
    .metric-card {
      border-radius: 10px;
      border: 1px solid #dde1ff;
      padding: 8px 10px;
      background: #fafbff;
    }
    .metric-title {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
    }
    .metric-main {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .metric-sub {
      font-size: 11px;
      color: #777;
    }
    .pill {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
    }
    .pill-star {
      background: #e0e7ff;
      color: #1d2f80;
    }
    .pill-rival {
      background: #ffe3e0;
      color: #7a1818;
    }
    .pill-good {
      background: #e0f7e9;
      color: #0f5132;
    }
    .pill-bad {
      background: #ffebee;
      color: #b71c1c;
    }

    .bar-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #edf0ff;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8a9dff, #c382ff);
    }

    .ai-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fafbff;
      border: 1px solid #dde1ff;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>ğŸ›° Star Little Luna - ã‚¿ãƒ¬ãƒ³ãƒˆé‹å–¶ãƒ»AIåˆ†æ</h1>
      <div class="small" id="staffInfo">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
    </div>
    <div class="top-right">
      <button id="backDashboardBtn" class="secondary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</button>
      <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚·ãƒ¼ãƒˆã«ã ã‘è½ã¨ã™ï¼‰ -->
  <div class="section">
    <h2>â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•åˆ†æç”¨ã‚·ãƒ¼ãƒˆé€£æº</h2>
    <div class="small">
      ãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆã®é…ä¿¡å®Ÿç¸¾ã‚„å¿œæ´ãƒã‚¤ãƒ³ãƒˆãªã©ã®CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br>
      ã€€Apps Script çµŒç”±ã§ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆä¾‹ï¼š<b>raw</b> ã‚·ãƒ¼ãƒˆï¼‰ã«è‡ªå‹•ã§è¿½è¨˜ã•ã‚Œã¾ã™ã€‚<br>
      ãƒ»ç”»é¢ä¸Šã«ã¯CSVã®ä¸­èº«ã¯è¡¨ç¤ºã›ãšã€ã‚·ãƒ¼ãƒˆå´ã§ Star / ç«¶åˆãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
    </div>

    <div style="margin-top:8px;">
      <label for="csvFileInput">ã‚¿ãƒ¬ãƒ³ãƒˆé›†è¨ˆCSVãƒ•ã‚¡ã‚¤ãƒ«</label>
      <input type="file" id="csvFileInput" accept=".csv" />
      <button id="uploadCsvBtn" style="margin-left:6px;">ã‚·ãƒ¼ãƒˆã«é€ä¿¡</button>
    </div>

    <div id="csvMsg" class="msg"></div>
  </div>

  <!-- â‘¡ ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ ï¼† æœŸé–“åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
  <div class="section">
    <h2>â‘¡ ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ï¼†æœŸé–“åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆStar vs ç«¶åˆï¼‰</h2>
    <div class="row">
      <div class="col">
        <div class="small">
          ãƒ»Apps Script ã® <code>?mode=metrics</code> ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã€<br>
          ã€€StarLittleLuna ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã¨ç«¶åˆä»–ç¤¾ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
          ãƒ»é…ä¿¡å›æ•°ãŒ 0 ã®ã‚¿ãƒ¬ãƒ³ãƒˆã¯ã€ã‚·ãƒ¼ãƒˆå´ã®è¨ˆç®—ã§é™¤å¤–ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚<br>
          ãƒ»å‰æ—¥ï¼å‰é€±ï¼å‰æœˆï¼ä»»æ„æœŸé–“ã®æ¯”è¼ƒã‚‚ã“ã“ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
        </div>
        <div style="margin-top:8px;">
          <button id="reloadMetricsBtn" class="secondary">ãƒ¡ãƒˆãƒªã‚¯ã‚¹å†èª­ã¿è¾¼ã¿</button>
          <div id="metricsMsg" class="msg"></div>
        </div>
      </div>
      <div class="col">
        <div class="small">
          è¡¨ç¤ºã‚¤ãƒ¡ãƒ¼ã‚¸ï¼š<br>
          å¿œæ´ãƒã‚¤ãƒ³ãƒˆå¹³å‡ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ•°ãƒ»30åˆ†ã‚ãŸã‚Šã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç·é…ä¿¡æ™‚é–“ãƒ»å¹³å‡è¦–è´è€…æ•°ãªã©ã€‚
        </div>
      </div>
    </div>

    <div class="metric-grid" id="metricGrid">
      <!-- JSã§ã‚«ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚€ -->
    </div>

    <div style="margin-top:10px;">
      <div class="small">æœŸé–“åˆ¥ã®å¤‰åŒ–ï¼ˆä¾‹ï¼šå‰æ—¥ / å‰é€± / å‰æœˆ / ä»»æ„æœŸé–“ï¼‰</div>
      <table>
        <thead>
          <tr>
            <th>æŒ‡æ¨™</th>
            <th>å‰æ—¥æ¯”(%)</th>
            <th>å‰é€±æ¯”(%)</th>
            <th>å‰æœˆæ¯”(%)</th>
            <th>ä»»æ„æœŸé–“(%)</th>
          </tr>
        </thead>
        <tbody id="periodBody">
          <tr><td colspan="5" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â‘¢ ã‚¿ãƒ¬ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <div class="section">
    <h2>â‘¢ ã‚¿ãƒ¬ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆäº‹å‹™æ‰€å†…å…¨ä½“ï¼‰</h2>
    <div class="small">
      ãƒ»ã‚·ãƒ¼ãƒˆå´ã§ userId ã”ã¨ã«é›†è¨ˆã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ JSON ã¨ã—ã¦è¿”ã—ã€<br>
      ã€€å¿œæ´ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼ˆ30åˆ†ã‚ãŸã‚Šï¼‰ãƒ»ç·é…ä¿¡æ™‚é–“ãƒ»å¹³å‡è¦–è´è€…æ•°ãƒ»ãƒãƒƒãƒç²å¾—æ•°ãƒ»æœˆæœ«å¿œæ´ãƒ€ã‚¤ãƒ¤åˆè¨ˆãªã©ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      ãƒ»ãƒãƒ¼ã®é•·ã•ã§ç›¸å¯¾çš„ãªä½ç½®ã‚’ã–ã£ãã‚Šæ¯”è¼ƒã§ãã¾ã™ã€‚
    </div>

    <table>
      <thead>
        <tr>
          <th>é †ä½</th>
          <th>ã‚¿ãƒ¬ãƒ³ãƒˆ</th>
          <th>å¿œæ´Pt</th>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ/30åˆ†</th>
          <th>ç·é…ä¿¡æ™‚é–“(min)</th>
          <th>å¹³å‡è¦–è´è€…æ•°</th>
          <th>ãƒãƒƒã‚¸</th>
          <th>æœˆæœ«ãƒ€ã‚¤ãƒ¤</th>
          <th>æ¯”è¼ƒãƒãƒ¼</th>
        </tr>
      </thead>
      <tbody id="rankingBody">
        <tr><td colspan="9" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘£ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥ï¼šæ‹…å½“ãƒ©ã‚¤ãƒãƒ¼æ¯”è¼ƒï¼†çµ¦ä¸ç›®å®‰ -->
  <div class="section">
    <h2>â‘£ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥æ¯”è¼ƒï¼ˆæ‹…å½“ãƒ€ã‚¤ãƒ¤ï¼†çµ¦ä¸ç›®å®‰ï¼‰</h2>
    <div class="small">
      ãƒ»æ‹…å½“ãƒ©ã‚¤ãƒãƒ¼ã®å¿œæ´ãƒ€ã‚¤ãƒ¤åˆè¨ˆã® 10% ã‚’ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®çµ¦ä¸ç›®å®‰ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      ãƒ»managerId ã¨ userId ã®ç´ä»˜ã‘ã¯ã€ã‚·ãƒ¼ãƒˆå´ã§ userId ç®¡ç†ã—ã¦ãŠãã¾ã™ã€‚
    </div>

    <table>
      <thead>
        <tr>
          <th>ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ID</th>
          <th>åå‰</th>
          <th>æ‹…å½“ã‚¿ãƒ¬ãƒ³ãƒˆæ•°</th>
          <th>æ‹…å½“ãƒ€ã‚¤ãƒ¤åˆè¨ˆ</th>
          <th>10% çµ¦ä¸ç›®å®‰</th>
        </tr>
      </thead>
      <tbody id="managerBody">
        <tr><td colspan="5" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘¤ AIåˆ†æ -->
  <div class="section">
    <h2>â‘¤ Gemini ãªã©ã«ã‚ˆã‚‹ AIã‚¿ãƒ¬ãƒ³ãƒˆåˆ†æ</h2>
    <div class="small">
      ãƒ»Apps Script å´ã§ <code>?mode=ai</code> ã‚’å—ã‘å–ã‚Šã€Gemini ãªã©ã®AIã«<br>
      ã€€StarLittleLuna ã¨ç«¶åˆãƒ¬ãƒ¼ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»æœŸé–“åˆ¥æ¨ç§»ã‚’æŠ•ã’ã¦åˆ†æã—ã¾ã™ã€‚<br>
      ãƒ»ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®AIãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚ï¼ˆAIé¢¨ã§ã¯ãªãã€å®Ÿéš›ã«APIã‚’å©ãå‰æï¼‰
    </div>

    <button id="aiAnalyzeBtn" style="margin-top:8px;">AIã§åˆ†æã™ã‚‹</button>
    <div id="aiMsg" class="msg"></div>
    <div id="aiResult" class="ai-box">
      ã¾ã AIåˆ†æã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    </div>
  </div>

  <script type="module">
    // â˜…â˜…â˜…â˜…â˜… ã“ã“ã‚’ã‚ãªãŸã® Apps Script Webã‚¢ãƒ—ãƒªURL(/exec) ã«å·®ã—æ›¿ãˆã‚‹ â˜…â˜…â˜…â˜…â˜…
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCzrfMT0pL2z_BWVeu587ZlMal5xxZj17dxrTEAeXnH8riCTuz6-pSUWxMUGVrI4Xg/exec";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // ===== Firebase è¨­å®š =====
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ===== DOM =====
    const staffInfoEl      = document.getElementById("staffInfo");
    const backDashboardBtn = document.getElementById("backDashboardBtn");
    const logoutBtn        = document.getElementById("logoutBtn");

    const csvFileInput = document.getElementById("csvFileInput");
    const uploadCsvBtn = document.getElementById("uploadCsvBtn");
    const csvMsg       = document.getElementById("csvMsg");

    const reloadMetricsBtn = document.getElementById("reloadMetricsBtn");
    const metricsMsg       = document.getElementById("metricsMsg");
    const metricGrid       = document.getElementById("metricGrid");
    const periodBody       = document.getElementById("periodBody");
    const rankingBody      = document.getElementById("rankingBody");
    const managerBody      = document.getElementById("managerBody");

    const aiAnalyzeBtn = document.getElementById("aiAnalyzeBtn");
    const aiMsg        = document.getElementById("aiMsg");
    const aiResult     = document.getElementById("aiResult");

    let currentUser = null;

    function setMsg(el, text, type = "") {
      el.textContent = text;
      el.className = "msg";
      if (type === "error")   el.classList.add("error");
      if (type === "success") el.classList.add("success");
    }

    // ===== Auth çŠ¶æ…‹ç›£è¦– =====
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      currentUser = user;
      staffInfoEl.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email || "ã‚¹ã‚¿ãƒƒãƒ•"}`;
      // ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿
      loadMetrics();
    });

    backDashboardBtn.addEventListener("click", () => {
      location.href = "dashboard.html";
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
      location.href = "login.html";
    });

    // ===== CSV â†’ Apps Script â†’ ã‚·ãƒ¼ãƒˆ =====
    function parseCsvToRows(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
      return lines.map(line => line.split(",").map(c => c.trim()));
    }

    uploadCsvBtn.addEventListener("click", async () => {
      const file = csvFileInput.files[0];
      if (!file) {
        setMsg(csvMsg, "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }

      try {
        setMsg(csvMsg, "ã‚·ãƒ¼ãƒˆã«é€ä¿¡ä¸­â€¦");
        uploadCsvBtn.disabled = true;

        const text = await file.text();
        const rows = parseCsvToRows(text);
        if (!rows.length) {
          setMsg(csvMsg, "CSVã«æœ‰åŠ¹ãªè¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "error");
          uploadCsvBtn.disabled = false;
          return;
        }

        const payload = {
          rows,
          uploadedBy: currentUser ? currentUser.uid : null
        };

        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let json;
        try {
          json = JSON.parse(raw);
        } catch (e) {
          console.error("CSV response JSON parse error:", raw);
          setMsg(csvMsg, "ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚", "error");
          return;
        }

        if (json.status !== "ok") {
          console.error("CSV server error:", json);
          setMsg(csvMsg, "ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          return;
        }

        setMsg(csvMsg, `ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã—ã¾ã—ãŸã€‚ï¼ˆ${json.imported || rows.length} è¡Œï¼‰`, "success");
      } catch (e) {
        console.error("CSV upload error:", e);
        setMsg(csvMsg, "é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç­‰ï¼‰", "error");
      } finally {
        uploadCsvBtn.disabled = false;
      }
    });

    // ===== ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿ =====
    reloadMetricsBtn.addEventListener("click", () => {
      loadMetrics();
    });

    async function loadMetrics() {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes("YOUR_APPS_SCRIPT_WEB_APP_URL_HERE")) {
        setMsg(metricsMsg, "APPS_SCRIPT_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
        return;
      }
      try {
        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸­â€¦");
        metricGrid.innerHTML = "";
        periodBody.innerHTML =
          '<tr><td colspan="5" class="small">èª­è¾¼ä¸­...</td></tr>';
        rankingBody.innerHTML =
          '<tr><td colspan="9" class="small">èª­è¾¼ä¸­...</td></tr>';
        managerBody.innerHTML =
          '<tr><td colspan="5" class="small">èª­è¾¼ä¸­...</td></tr>';

        const res  = await fetch(APPS_SCRIPT_URL + "?mode=metrics");
        const text = await res.text();

        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          console.error("metrics JSON parse error:", text);
          setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
          return;
        }

        if (json.status !== "ok") {
          setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          return;
        }

        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸã€‚", "success");
        const metricsData = json.data || {};
        renderLabelMetrics(metricsData.labelMetrics || []);
        renderPeriodMetrics(metricsData.periodDiff || {});
        renderRanking(metricsData.rankings || []);
        renderManagerTable(metricsData.managers || []);
      } catch (e) {
        console.error("loadMetrics error:", e);
        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    }

    // ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚«ãƒ¼ãƒ‰
    function renderLabelMetrics(list) {
      metricGrid.innerHTML = "";
      if (!Array.isArray(list) || list.length === 0) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒˆå´ã§è¨ˆç®—çµæœã‚’APIã«è¿”ã™ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚";
        metricGrid.appendChild(div);
        return;
      }

      list.forEach((m) => {
        const star = Number(m.starValue || 0);
        const rival = Number(m.rivalValue || 0);
        const diff = star - rival;
        const card = document.createElement("div");
        card.className = "metric-card";

        const diffClass =
          diff > 0 ? "pill pill-good" :
          diff < 0 ? "pill pill-bad" : "pill";

        card.innerHTML = `
          <div class="metric-title">${m.label || m.metricName || "æŒ‡æ¨™"}</div>
          <div class="metric-main">${star.toFixed ? star.toFixed(1) : star}</div>
          <div class="metric-sub">
            <span class="pill pill-star">Star: ${star}</span>
            <span class="pill pill-rival">ç«¶åˆ: ${rival}</span>
            <span class="${diffClass}">
              å·®åˆ†: ${diff >= 0 ? "+" : ""}${diff.toFixed ? diff.toFixed(1) : diff}
            </span>
            ${m.period ? `<span class="pill">${m.period}</span>` : ""}
          </div>
        `;
        metricGrid.appendChild(card);
      });
    }

    // æœŸé–“åˆ¥%å¤‰åŒ–
    function renderPeriodMetrics(diff) {
      periodBody.innerHTML = "";
      const rows = diff.rows || []; // ä¾‹: [{metric:"å¿œæ´ãƒã‚¤ãƒ³ãƒˆ", day:5, week:12, month:30, custom:-3}, ...]
      if (!Array.isArray(rows) || rows.length === 0) {
        periodBody.innerHTML =
          '<tr><td colspan="5" class="small">æœŸé–“åˆ¥ã®å¤‰åŒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.metric || "-"}</td>
          <td>${fmtPercent(r.day)}</td>
          <td>${fmtPercent(r.week)}</td>
          <td>${fmtPercent(r.month)}</td>
          <td>${fmtPercent(r.custom)}</td>
        `;
        periodBody.appendChild(tr);
      });
    }

    function fmtPercent(v) {
      const num = Number(v);
      if (isNaN(num)) return "-";
      const s = num.toFixed(1);
      return (num >= 0 ? "+" + s : s) + "%";
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
    function renderRanking(list) {
      rankingBody.innerHTML = "";
      if (!Array.isArray(list) || list.length === 0) {
        rankingBody.innerHTML =
          '<tr><td colspan="9" class="small">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      const maxSupport = Math.max(...list.map(t => Number(t.supportPoints || 0)), 1);

      list.forEach((t, idx) => {
        const support   = Number(t.supportPoints || 0);
        const comments  = Number(t.commentsPer30 || 0);
        const minutes   = Number(t.totalMinutes || 0);
        const avgView   = Number(t.avgViewers || 0);
        const badges    = Number(t.badges || 0);
        const diamonds  = Number(t.diamonds || 0);
        const barWidth  = Math.round((support / maxSupport) * 100);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${t.displayName || t.name || t.userId || "-"}</td>
          <td>${support}</td>
          <td>${comments.toFixed ? comments.toFixed(1) : comments}</td>
          <td>${minutes}</td>
          <td>${avgView.toFixed ? avgView.toFixed(1) : avgView}</td>
          <td>${badges}</td>
          <td>${diamonds}</td>
          <td>
            <div class="bar-track">
              <div class="bar-fill" style="width:${barWidth}%;"></div>
            </div>
          </td>
        `;
        rankingBody.appendChild(tr);
      });
    }

    // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¯”è¼ƒ
    function renderManagerTable(list) {
      managerBody.innerHTML = "";
      if (!Array.isArray(list) || list.length === 0) {
        managerBody.innerHTML =
          '<tr><td colspan="5" class="small">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      list.forEach((m) => {
        const diamonds = Number(m.totalDiamonds || 0);
        const salary   = Number(m.salary10pct || (diamonds * 0.1));
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.managerId || "-"}</td>
          <td>${m.managerName || "-"}</td>
          <td>${m.talentCount || 0}</td>
          <td>${diamonds}</td>
          <td>${salary.toFixed ? salary.toFixed(1) : salary}</td>
        `;
        managerBody.appendChild(tr);
      });
    }

    // ===== AIåˆ†æ =====
    aiAnalyzeBtn.addEventListener("click", async () => {
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes("YOUR_APPS_SCRIPT_WEB_APP_URL_HERE")) {
        setMsg(aiMsg, "APPS_SCRIPT_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
        return;
      }
      try {
        setMsg(aiMsg, "AIãŒåˆ†æä¸­ã§ã™â€¦");
        aiAnalyzeBtn.disabled = true;
        aiResult.textContent = "";

        const res  = await fetch(APPS_SCRIPT_URL + "?mode=ai");
        const text = await res.text();

        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          console.error("AI JSON parse error:", text);
          setMsg(aiMsg, "AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
          return;
        }

        if (json.status !== "ok") {
          setMsg(aiMsg, "AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          return;
        }

        setMsg(aiMsg, "AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "success");
        aiResult.textContent = json.aiText || "AIã‹ã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã—ãŸã€‚";
      } catch (e) {
        console.error("AI analyze error:", e);
        setMsg(aiMsg, "AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      } finally {
        aiAnalyzeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
