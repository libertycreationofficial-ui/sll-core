<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna - ã‚¿ãƒ¬ãƒ³ãƒˆé‹å–¶ãƒ»AIåˆ†æ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      background: #f5f7ff;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 16px;
      margin: 16px 0 6px;
    }
    .small {
      font-size: 12px;
      color: #666;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .top-right {
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #8a9dff;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.secondary {
      background: #e1e4ff;
      color: #333;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .msg {
      font-size: 12px;
      margin-top: 6px;
      color: #555;
    }
    .error { color: #d32f2f; }
    .success { color: #0f9d58; }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    input[type="file"],
    select,
    input[type="date"],
    input[type="text"] {
      font-size: 13px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d0d4ea;
      background: #fafbff;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .col {
      flex: 1;
      min-width: 260px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3f0;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f2f3ff;
      font-weight: 600;
      cursor: default;
      user-select: none;
    }
    th.sortable {
      cursor: pointer;
      position: relative;
    }
    th.sortable::after {
      content: "â‡…";
      font-size: 10px;
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.3;
    }
    th.sortable[data-sort-dir="asc"]::after {
      content: "â–²";
      opacity: 0.8;
    }
    th.sortable[data-sort-dir="desc"]::after {
      content: "â–¼";
      opacity: 0.8;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 700px) {
      .metric-grid {
        grid-template-columns: 1fr;
      }
    }
    .metric-card {
      border-radius: 10px;
      border: 1px solid #dde1ff;
      padding: 8px 10px;
      background: #fafbff;
    }
    .metric-title {
      font-size: 12px;
      color: #555;
      margin-bottom: 4px;
    }
    .metric-main {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .metric-sub {
      font-size: 11px;
      color: #777;
    }
    .pill {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 11px;
      margin-right: 4px;
      margin-top: 2px;
    }
    .pill-star {
      background: #e0e7ff;
      color: #1d2f80;
    }
    .pill-rival {
      background: #ffe3e0;
      color: #7a1818;
    }
    .pill-good {
      background: #e0f7e9;
      color: #0f5132;
    }
    .pill-bad {
      background: #ffebee;
      color: #b71c1c;
    }

    .bar-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #edf0ff;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #8a9dff, #c382ff);
    }

    .ai-box {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fafbff;
      border: 1px solid #dde1ff;
      font-size: 13px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }
    .filter-row label {
      margin-bottom: 0;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    @media (max-width: 800px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (max-width: 600px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }
    }
    .kpi-card {
      border-radius: 10px;
      border: 1px solid #dde1ff;
      padding: 8px 10px;
      background: #ffffff;
    }
    .kpi-label {
      font-size: 11px;
      color: #777;
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 16px;
      font-weight: 600;
    }
    .kpi-sub {
      font-size: 11px;
      color: #999;
    }

    .alert-list {
      margin-top: 6px;
      padding-left: 18px;
    }
    .alert-list li {
      margin-bottom: 2px;
    }

    .talent-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }
    .talent-detail-name {
      font-size: 16px;
      font-weight: 600;
    }
    .talent-detail-id {
      font-size: 11px;
      color: #777;
    }
    .talent-detail-badges {
      font-size: 11px;
      text-align: right;
      color: #555;
    }
    .talent-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }
    @media (max-width: 700px) {
      .talent-detail-grid {
        grid-template-columns: 1fr;
      }
    }
    .talent-detail-item {
      font-size: 12px;
    }
    .talent-detail-item-title {
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }
    .talent-detail-item-main {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .talent-detail-item-sub {
      font-size: 11px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>ğŸ›° Star Little Luna - ã‚¿ãƒ¬ãƒ³ãƒˆé‹å–¶ãƒ»AIåˆ†æ</h1>
      <div class="small" id="staffInfo">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
    </div>
    <div class="top-right">
      <button id="backDashboardBtn" class="secondary">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</button>
      <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <!-- â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚·ãƒ¼ãƒˆã«ã ã‘è½ã¨ã™ï¼‰ -->
  <div class="section">
    <h2>â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ è‡ªå‹•åˆ†æç”¨ã‚·ãƒ¼ãƒˆé€£æº</h2>
    <div class="small">
      ãƒ»ã‚¿ãƒ¬ãƒ³ãƒˆã®é…ä¿¡å®Ÿç¸¾ã‚„å¿œæ´ãƒã‚¤ãƒ³ãƒˆãªã©ã®CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br>
      ã€€Apps Script çµŒç”±ã§ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼ˆä¾‹ï¼š<b>raw</b> ã‚·ãƒ¼ãƒˆï¼‰ã«è‡ªå‹•ã§è¿½è¨˜ã•ã‚Œã¾ã™ã€‚<br>
      ãƒ»ç”»é¢ä¸Šã«ã¯CSVã®ä¸­èº«ã¯è¡¨ç¤ºã›ãšã€ã‚·ãƒ¼ãƒˆå´ã§ Star / ç«¶åˆãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¾ã™ã€‚<br>
      ãƒ»å…¨ã¦ <b>User ID</b> ãƒ™ãƒ¼ã‚¹ã§ç®¡ç†ã™ã‚‹å‰æã§ã™ã€‚
    </div>

    <div style="margin-top:8px;">
      <label for="csvFileInput">ã‚¿ãƒ¬ãƒ³ãƒˆé›†è¨ˆCSVãƒ•ã‚¡ã‚¤ãƒ«</label>
      <input type="file" id="csvFileInput" accept=".csv" />
      <button id="uploadCsvBtn" style="margin-left:6px;">ã‚·ãƒ¼ãƒˆã«é€ä¿¡</button>
    </div>

    <div id="csvMsg" class="msg"></div>
  </div>

  <!-- â‘¡ ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ ï¼† æœŸé–“åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
  <div class="section">
    <h2>â‘¡ ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ï¼†æœŸé–“åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆStar vs ç«¶åˆï¼‰</h2>
    <div class="row">
      <div class="col">
        <div class="small">
          ãƒ»Apps Script ã® <code>?mode=metrics</code> ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã€<br>
          ã€€StarLittleLuna ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã¨ç«¶åˆä»–ç¤¾ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
          ãƒ»é…ä¿¡å›æ•°ãŒ 0 ã®ã‚¿ãƒ¬ãƒ³ãƒˆã¯ã€ã‚·ãƒ¼ãƒˆå´ã®è¨ˆç®—ã§é™¤å¤–ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚<br>
          ãƒ»å‰æ—¥ï¼å‰é€±ï¼å‰æœˆï¼ä»»æ„æœŸé–“ã®æ¯”è¼ƒã‚‚ã“ã“ã«ã¾ã¨ã‚ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
        </div>
      </div>
      <div class="col">
        <div class="small">
          å¿œæ´ãƒã‚¤ãƒ³ãƒˆå¹³å‡ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ•°ãƒ»30åˆ†ã‚ãŸã‚Šã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç·é…ä¿¡æ™‚é–“ãƒ»å¹³å‡è¦–è´è€…æ•°ãªã©ã€<br>
          Star ã¨ç«¶åˆãƒ¬ãƒ¼ãƒ™ãƒ«ã‚’æ¨ªä¸¦ã³ã§æ¯”è¼ƒã§ãã¾ã™ã€‚
        </div>
      </div>
    </div>

    <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="filter-row">
      <div>
        <label for="periodPreset">æœŸé–“ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
        <select id="periodPreset">
          <option value="">è‡ªå‹•ï¼ˆã‚·ãƒ¼ãƒˆå´ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</option>
          <option value="yesterday">å‰æ—¥</option>
          <option value="last7">ç›´è¿‘7æ—¥</option>
          <option value="last30">ç›´è¿‘30æ—¥</option>
          <option value="custom">ä»»æ„æœŸé–“</option>
        </select>
      </div>
      <div>
        <label for="fromDate">é–‹å§‹æ—¥</label>
        <input type="date" id="fromDate">
      </div>
      <div>
        <label for="toDate">çµ‚äº†æ—¥</label>
        <input type="date" id="toDate">
      </div>
      <button id="reloadMetricsBtn" class="secondary">ãƒ¡ãƒˆãƒªã‚¯ã‚¹å†èª­ã¿è¾¼ã¿</button>
      <div id="metricsMsg" class="msg"></div>
    </div>

    <div class="metric-grid" id="metricGrid">
      <!-- JSã§ã‚«ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚€ -->
    </div>

    <div style="margin-top:10px;">
      <div class="small">æœŸé–“åˆ¥ã®å¤‰åŒ–ï¼ˆå‰æ—¥ / å‰é€± / å‰æœˆ / ä»»æ„æœŸé–“ï¼‰</div>
      <table>
        <thead>
          <tr>
            <th>æŒ‡æ¨™</th>
            <th>å‰æ—¥æ¯”(%)</th>
            <th>å‰é€±æ¯”(%)</th>
            <th>å‰æœˆæ¯”(%)</th>
            <th>ä»»æ„æœŸé–“(%)</th>
          </tr>
        </thead>
        <tbody id="periodBody">
          <tr><td colspan="5" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â‘¢ ã‚¿ãƒ¬ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <div class="section">
    <h2>â‘¢ ã‚¿ãƒ¬ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆäº‹å‹™æ‰€å†…å…¨ä½“ï¼‰</h2>
    <div class="small">
      ãƒ»ã‚·ãƒ¼ãƒˆå´ã§ User ID ã”ã¨ã«é›†è¨ˆã—ãŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ JSON ã¨ã—ã¦è¿”ã—ã€<br>
      ã€€å¿œæ´ãƒã‚¤ãƒ³ãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆæ•°ï¼ˆ30åˆ†ã‚ãŸã‚Šï¼‰ãƒ»ç·é…ä¿¡æ™‚é–“ãƒ»å¹³å‡è¦–è´è€…æ•°ãƒ»ãƒãƒƒã‚¸ç²å¾—æ•°ãƒ»æœˆæœ«å¿œæ´ãƒ€ã‚¤ãƒ¤åˆè¨ˆãªã©ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      ãƒ»ãƒãƒ¼ã®é•·ã•ã§ç›¸å¯¾çš„ãªä½ç½®ã‚’ã–ã£ãã‚Šæ¯”è¼ƒã§ãã¾ã™ã€‚<br>
      ãƒ»ä¸‹ã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã‚„ã‚½ãƒ¼ãƒˆã§ã€è¦‹ãŸã„ã‚¿ãƒ¬ãƒ³ãƒˆã‚’ã™ãã«æ¢ã›ã¾ã™ã€‚
    </div>

    <div class="filter-row" style="margin-top:6px;">
      <label for="rankingSearch">ã‚¿ãƒ¬ãƒ³ãƒˆæ¤œç´¢</label>
      <input type="text" id="rankingSearch" placeholder="ã‚¿ãƒ¬ãƒ³ãƒˆå or User ID ã§çµã‚Šè¾¼ã¿" />
    </div>

    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort-key="rank">é †ä½</th>
          <th class="sortable" data-sort-key="name">ã‚¿ãƒ¬ãƒ³ãƒˆ</th>
          <th class="sortable" data-sort-key="support">å¿œæ´Pt</th>
          <th class="sortable" data-sort-key="comments">ã‚³ãƒ¡ãƒ³ãƒˆ/30åˆ†</th>
          <th class="sortable" data-sort-key="minutes">ç·é…ä¿¡æ™‚é–“(min)</th>
          <th class="sortable" data-sort-key="viewers">å¹³å‡è¦–è´è€…æ•°</th>
          <th class="sortable" data-sort-key="badges">ãƒãƒƒã‚¸</th>
          <th class="sortable" data-sort-key="diamonds">æœˆæœ«ãƒ€ã‚¤ãƒ¤</th>
          <th>æ¯”è¼ƒãƒãƒ¼</th>
        </tr>
      </thead>
      <tbody id="rankingBody">
        <tr><td colspan="9" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘£ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥ï¼šæ‹…å½“ãƒ©ã‚¤ãƒãƒ¼æ¯”è¼ƒï¼†çµ¦ä¸ç›®å®‰ -->
  <div class="section">
    <h2>â‘£ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥æ¯”è¼ƒï¼ˆæ‹…å½“ãƒ€ã‚¤ãƒ¤ï¼†çµ¦ä¸ç›®å®‰ï¼‰</h2>
    <div class="small">
      ãƒ»æ‹…å½“ãƒ©ã‚¤ãƒãƒ¼ã®å¿œæ´ãƒ€ã‚¤ãƒ¤åˆè¨ˆã® 10% ã‚’ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®çµ¦ä¸ç›®å®‰ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      ãƒ»managerId ã¨ User ID ã®ç´ä»˜ã‘ã¯ã€ã‚·ãƒ¼ãƒˆå´ã§ User ID ç®¡ç†ã—ã¦ãŠãã¾ã™ã€‚<br>
      ãƒ»ã“ã“ã‹ã‚‰ã€Œã©ã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒã©ã®ã‚¿ãƒ¬ãƒ³ãƒˆã‚’ä½•åæ‹…å½“ã—ã¦ã„ã‚‹ã‹ã€ã®ãƒãƒ©ãƒ³ã‚¹ç®¡ç†ãŒã§ãã¾ã™ã€‚
    </div>

    <table>
      <thead>
        <tr>
          <th>ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ID</th>
          <th>åå‰</th>
          <th>æ‹…å½“ã‚¿ãƒ¬ãƒ³ãƒˆæ•°</th>
          <th>æ‹…å½“ãƒ€ã‚¤ãƒ¤åˆè¨ˆ</th>
          <th>10% çµ¦ä¸ç›®å®‰</th>
        </tr>
      </thead>
      <tbody id="managerBody">
        <tr><td colspan="5" class="small">ã¾ã ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
      </tbody>
    </table>
  </div>

  <!-- â‘¤ AIåˆ†æ -->
  <div class="section">
    <h2>â‘¤ Gemini ãªã©ã«ã‚ˆã‚‹ AIã‚¿ãƒ¬ãƒ³ãƒˆåˆ†æ</h2>
    <div class="small">
      ãƒ»Apps Script å´ã§ <code>?mode=ai</code> ã‚’å—ã‘å–ã‚Šã€Gemini ãªã©ã®AIã«<br>
      ã€€StarLittleLuna ã¨ç«¶åˆãƒ¬ãƒ¼ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»æœŸé–“åˆ¥æ¨ç§»ã‚’æŠ•ã’ã¦åˆ†æã—ã¾ã™ã€‚<br>
      ãƒ»ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®AIãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚<br>
      ãƒ»ã€ŒAIé¢¨ã€ã®å›ºå®šæ–‡ã§ã¯ãªãã€å®Ÿéš›ã«APIã‚’å©ã„ã¦çµæœã‚’è¿”ã™å‰æã§ã™ã€‚
    </div>

    <button id="aiAnalyzeBtn" style="margin-top:8px;">AIã§åˆ†æã™ã‚‹</button>
    <div id="aiMsg" class="msg"></div>
    <div id="aiResult" class="ai-box">
      ã¾ã AIåˆ†æã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    </div>
  </div>

  <!-- â‘¥ äº‹å‹™æ‰€å…¨ä½“ã‚µãƒãƒªãƒ¼ & ã‚¢ãƒ©ãƒ¼ãƒˆ -->
  <div class="section">
    <h2>â‘¥ äº‹å‹™æ‰€å…¨ä½“ã‚µãƒãƒªãƒ¼ & ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
    <div class="small">
      ãƒ»ç¾åœ¨ã® Star Little Luna æ‰€å±ã‚¿ãƒ¬ãƒ³ãƒˆã®çŠ¶æ³ã‚’ã–ã£ãã‚Šä¸€ç›®ã§æŠŠæ¡ã™ã‚‹ãŸã‚ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚<br>
      ãƒ»å…¨ä½“ã®å¿œæ´ãƒã‚¤ãƒ³ãƒˆè¦æ¨¡ï¼å¹³å‡å€¤ï¼ã‚³ãƒ¡ãƒ³ãƒˆã®æ´»ç™ºã•ï¼è¦–è´è€…æ•°ã®æ°´æº–ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™ã€‚<br>
      ãƒ»ã€Œå¿œæ´ãƒã‚¤ãƒ³ãƒˆ0ã®ã‚¿ãƒ¬ãƒ³ãƒˆã€ã‚„ã€Œé…ä¿¡æ™‚é–“ãŒé•·ã„ã®ã«ãƒã‚¤ãƒ³ãƒˆãŒä¼¸ã³ã¦ã„ãªã„ã‚¿ãƒ¬ãƒ³ãƒˆã€ãªã©ã‚’è‡ªå‹•ã§ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚
    </div>

    <div id="orgSummaryKpi" class="kpi-grid">
      <!-- JSã§KPIã‚«ãƒ¼ãƒ‰ã‚’å·®ã—è¾¼ã‚€ -->
    </div>

    <ul id="orgAlertList" class="alert-list small">
      <!-- JSã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å·®ã—è¾¼ã‚€ -->
    </ul>
  </div>

  <!-- â‘¦ ã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ãƒ“ãƒ¥ãƒ¼ & ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ -->
  <div class="section">
    <h2>â‘¦ ã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ãƒ“ãƒ¥ãƒ¼ & ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯</h2>
    <div class="small">
      ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰ã‚¿ãƒ¬ãƒ³ãƒˆã‚’1äººé¸ã¶ã¨ã€äº‹å‹™æ‰€å†…ã§ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚<br>
      ãƒ»å¿œæ´ãƒã‚¤ãƒ³ãƒˆï¼ã‚³ãƒ¡ãƒ³ãƒˆé »åº¦ï¼è¦–è´è€…æ•°ãªã©ãŒã€äº‹å‹™æ‰€å†…ã§ã©ã®ãã‚‰ã„ã®ä½ç½®ã«ã„ã‚‹ã‹ï¼ˆ%ï¼‰ã‚’ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚
    </div>

    <div class="filter-row">
      <label for="talentSelect">ã‚¿ãƒ¬ãƒ³ãƒˆé¸æŠ</label>
      <select id="talentSelect">
        <option value="">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰1äººé¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>

    <div id="talentDetailPanel" class="ai-box" style="margin-top:8px;">
      ã‚¿ãƒ¬ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </div>
  </div>

  <script type="module">
    // â˜…â˜…â˜…â˜…â˜… ã“ã“ã‚’ã‚ãªãŸã® Apps Script Webã‚¢ãƒ—ãƒªURL(/exec) ã«å·®ã—æ›¿ãˆã‚‹ â˜…â˜…â˜…â˜…â˜…
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbydNosInT2vBUkxYikZybzTVSKii6Kkikx0dn6OwZFLU8Fp47iAkMNhJ5U-DerS064/exec";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // ===== Firebase è¨­å®š =====
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ===== DOM =====
    const staffInfoEl      = document.getElementById("staffInfo");
    const backDashboardBtn = document.getElementById("backDashboardBtn");
    const logoutBtn        = document.getElementById("logoutBtn");

    const csvFileInput = document.getElementById("csvFileInput");
    const uploadCsvBtn = document.getElementById("uploadCsvBtn");
    const csvMsg       = document.getElementById("csvMsg");

    const periodPreset   = document.getElementById("periodPreset");
    const fromDateInput  = document.getElementById("fromDate");
    const toDateInput    = document.getElementById("toDate");
    const reloadMetricsBtn = document.getElementById("reloadMetricsBtn");
    const metricsMsg       = document.getElementById("metricsMsg");
    const metricGrid       = document.getElementById("metricGrid");
    const periodBody       = document.getElementById("periodBody");
    const rankingBody      = document.getElementById("rankingBody");
    const managerBody      = document.getElementById("managerBody");
    const rankingSearch    = document.getElementById("rankingSearch");

    const aiAnalyzeBtn = document.getElementById("aiAnalyzeBtn");
    const aiMsg        = document.getElementById("aiMsg");
    const aiResult     = document.getElementById("aiResult");

    // æ–°è¦ï¼šå…¨ä½“ã‚µãƒãƒªãƒ¼ & ã‚¢ãƒ©ãƒ¼ãƒˆ
    const orgSummaryKpi  = document.getElementById("orgSummaryKpi");
    const orgAlertList   = document.getElementById("orgAlertList");

    // æ–°è¦ï¼šã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ãƒ“ãƒ¥ãƒ¼
    const talentSelect       = document.getElementById("talentSelect");
    const talentDetailPanel  = document.getElementById("talentDetailPanel");

    let currentUser = null;
    let rankingData = []; // å…¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦æ¤œç´¢ãƒ»è©³ç´°ã§å†åˆ©ç”¨
    let currentSort = { key: "rank", dir: "asc" }; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚½ãƒ¼ãƒˆçŠ¶æ…‹

    function setMsg(el, text, type = "") {
      el.textContent = text;
      el.className = "msg";
      if (type === "error")   el.classList.add("error");
      if (type === "success") el.classList.add("success");
    }

    // ===== Auth çŠ¶æ…‹ç›£è¦– =====
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      currentUser = user;
      staffInfoEl.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email || "ã‚¹ã‚¿ãƒƒãƒ•"}`;
      // ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿
      loadMetrics();
    });

    backDashboardBtn.addEventListener("click", () => {
      location.href = "dashboard.html";
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
      } catch (e) {
        console.error(e);
      }
      location.href = "login.html";
    });

    // ===== CSV â†’ Apps Script â†’ ã‚·ãƒ¼ãƒˆ =====
    function parseCsvToRows(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
      return lines.map(line => line.split(",").map(c => c.trim()));
    }

    uploadCsvBtn.addEventListener("click", async () => {
      const file = csvFileInput.files[0];
      if (!file) {
        setMsg(csvMsg, "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }

      try {
        setMsg(csvMsg, "ã‚·ãƒ¼ãƒˆã«é€ä¿¡ä¸­â€¦");
        uploadCsvBtn.disabled = true;

        const text = await file.text();
        const rows = parseCsvToRows(text);
        if (!rows.length) {
          setMsg(csvMsg, "CSVã«æœ‰åŠ¹ãªè¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "error");
          uploadCsvBtn.disabled = false;
          return;
        }

        const payload = {
          rows,
          uploadedBy: currentUser ? currentUser.uid : null
        };

        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let json;
        try {
          json = JSON.parse(raw);
        } catch (e) {
          console.error("CSV response JSON parse error:", raw);
          setMsg(csvMsg, "ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰JSONå½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸã€‚", "error");
          return;
        }

        if (json.status !== "ok") {
          console.error("CSV server error:", json);
          setMsg(csvMsg, "ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          return;
        }

        setMsg(csvMsg, `ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã—ã¾ã—ãŸã€‚ï¼ˆ${json.imported || rows.length} è¡Œï¼‰`, "success");
      } catch (e) {
        console.error("CSV upload error:", e);
        setMsg(csvMsg, "é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç­‰ï¼‰", "error");
      } finally {
        uploadCsvBtn.disabled = false;
      }
    });

    // ===== ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿ =====
    reloadMetricsBtn.addEventListener("click", () => {
      loadMetrics();
    });

    function buildMetricsUrl() {
      let url = APPS_SCRIPT_URL + "?mode=metrics";
      const preset = periodPreset.value;
      if (preset) {
        url += "&preset=" + encodeURIComponent(preset);
      }
      const from = fromDateInput.value;
      const to   = toDateInput.value;
      if (from) url += "&from=" + encodeURIComponent(from);
      if (to)   url += "&to=" + encodeURIComponent(to);
      return url;
    }

    async function loadMetrics() {
      if (!APPS_SCRIPT_URL) {
        setMsg(metricsMsg, "APPS_SCRIPT_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
        return;
      }

      try {
        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸­â€¦");
        metricGrid.innerHTML = "";
        periodBody.innerHTML =
          '<tr><td colspan="5" class="small">èª­è¾¼ä¸­...</td></tr>';
        rankingBody.innerHTML =
          '<tr><td colspan="9" class="small">èª­è¾¼ä¸­...</td></tr>';
        managerBody.innerHTML =
          '<tr><td colspan="5" class="small">èª­è¾¼ä¸­...</td></tr>';
        orgSummaryKpi.innerHTML = "";
        orgAlertList.innerHTML =
          '<li>ãƒ¡ãƒˆãƒªã‚¯ã‚¹èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦</li>';

        const url = buildMetricsUrl();
        const res  = await fetch(url);
        const text = await res.text();

        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          console.error("metrics JSON parse error:", text);
          setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
          return;
        }

        if (json.status !== "ok") {
          setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          return;
        }

        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¾ã—ãŸã€‚", "success");
        const metricsData = json.data || {};
        renderLabelMetrics(metricsData.labelMetrics || []);
        renderPeriodMetrics(metricsData.periodDiff || {});
        rankingData = metricsData.rankings || [];
        currentSort = { key: "rank", dir: "asc" };
        renderRankingFiltered();
        renderManagerTable(metricsData.managers || []);

        // æ–°è¦ï¼šå…¨ä½“ã‚µãƒãƒªãƒ¼ & ã‚¢ãƒ©ãƒ¼ãƒˆã€ã‚¿ãƒ¬ãƒ³ãƒˆé¸æŠ
        updateOrgSummaryAndAlerts();
        populateTalentSelect();
      } catch (e) {
        console.error("loadMetrics error:", e);
        setMsg(metricsMsg, "ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    }

    // ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ã‚«ãƒ¼ãƒ‰
    function renderLabelMetrics(list) {
      metricGrid.innerHTML = "";
      if (!Array.isArray(list) || list.length === 0) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "ãƒ¬ãƒ¼ãƒ™ãƒ«å¹³å‡ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ãƒ¼ãƒˆå´ã§è¨ˆç®—çµæœã‚’APIã«è¿”ã™ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚";
        metricGrid.appendChild(div);
        return;
      }

      list.forEach((m) => {
        const star = Number(m.starValue || 0);
        const rival = Number(m.rivalValue || 0);
        const diff = star - rival;
        const card = document.createElement("div");
        card.className = "metric-card";

        const diffClass =
          diff > 0 ? "pill pill-good" :
          diff < 0 ? "pill pill-bad" : "pill";

        const starText  = star.toFixed ? star.toFixed(1) : star;
        const rivalText = rival.toFixed ? rival.toFixed(1) : rival;
        const diffText  = diff.toFixed ? diff.toFixed(1) : diff;

        card.innerHTML = `
          <div class="metric-title">${m.label || m.metricName || "æŒ‡æ¨™"}</div>
          <div class="metric-main">${starText}</div>
          <div class="metric-sub">
            <span class="pill pill-star">Star: ${starText}</span>
            <span class="pill pill-rival">ç«¶åˆ: ${rivalText}</span>
            <span class="${diffClass}">
              å·®åˆ†: ${diff >= 0 ? "+" : ""}${diffText}
            </span>
            ${m.period ? `<span class="pill">${m.period}</span>` : ""}
          </div>
        `;
        metricGrid.appendChild(card);
      });
    }

    // æœŸé–“åˆ¥%å¤‰åŒ–
    function renderPeriodMetrics(diff) {
      periodBody.innerHTML = "";
      const rows = diff.rows || [];
      if (!Array.isArray(rows) || rows.length === 0) {
        periodBody.innerHTML =
          '<tr><td colspan="5" class="small">æœŸé–“åˆ¥ã®å¤‰åŒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.metric || "-"}</td>
          <td>${fmtPercent(r.day)}</td>
          <td>${fmtPercent(r.week)}</td>
          <td>${fmtPercent(r.month)}</td>
          <td>${fmtPercent(r.custom)}</td>
        `;
        periodBody.appendChild(tr);
      });
    }

    function fmtPercent(v) {
      const num = Number(v);
      if (isNaN(num)) return "-";
      const s = num.toFixed(1);
      return (num >= 0 ? "+" + s : s) + "%";
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ¤œç´¢ & ã‚½ãƒ¼ãƒˆä»˜ãï¼‰
    function renderRankingFiltered() {
      rankingBody.innerHTML = "";
      if (!Array.isArray(rankingData) || rankingData.length === 0) {
        rankingBody.innerHTML =
          '<tr><td colspan="9" class="small">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      const keyword = (rankingSearch.value || "").toLowerCase();
      let filtered = rankingData.map((t, idx) => ({
        ...t,
        _rank: idx + 1
      }));

      if (keyword) {
        filtered = filtered.filter((t) => {
          const name = (t.displayName || t.name || "").toLowerCase();
          const id   = (t.userId || "").toLowerCase();
          return name.includes(keyword) || id.includes(keyword);
        });
      }

      if (filtered.length === 0) {
        rankingBody.innerHTML =
          '<tr><td colspan="9" class="small">è©²å½“ã™ã‚‹ã‚¿ãƒ¬ãƒ³ãƒˆãŒã„ã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      // ã‚½ãƒ¼ãƒˆ
      const { key, dir } = currentSort;
      const factor = dir === "desc" ? -1 : 1;

      filtered.sort((a, b) => {
        let av, bv;
        switch (key) {
          case "support":
            av = Number(a.supportPoints || 0);
            bv = Number(b.supportPoints || 0);
            break;
          case "comments":
            av = Number(a.commentsPer30 || 0);
            bv = Number(b.commentsPer30 || 0);
            break;
          case "minutes":
            av = Number(a.totalMinutes || 0);
            bv = Number(b.totalMinutes || 0);
            break;
          case "viewers":
            av = Number(a.avgViewers || 0);
            bv = Number(b.avgViewers || 0);
            break;
          case "badges":
            av = Number(a.badges || 0);
            bv = Number(b.badges || 0);
            break;
          case "diamonds":
            av = Number(a.diamonds || 0);
            bv = Number(b.diamonds || 0);
            break;
          case "name":
            av = (a.displayName || a.name || "").toLowerCase();
            bv = (b.displayName || b.name || "").toLowerCase();
            if (av < bv) return -1 * factor;
            if (av > bv) return  1 * factor;
            return 0;
          case "rank":
          default:
            av = Number(a._rank);
            bv = Number(b._rank);
            break;
        }
        if (av < bv) return -1 * factor;
        if (av > bv) return  1 * factor;
        return 0;
      });

      const maxSupport = Math.max(...filtered.map(t => Number(t.supportPoints || 0)), 1);

      filtered.forEach((t, idx) => {
        const support   = Number(t.supportPoints || 0);
        const comments  = Number(t.commentsPer30 || 0);
        const minutes   = Number(t.totalMinutes || 0);
        const avgView   = Number(t.avgViewers || 0);
        const badges    = Number(t.badges || 0);
        const diamonds  = Number(t.diamonds || 0);
        const barWidth  = Math.round((support / maxSupport) * 100);

        const commentsText = comments.toFixed ? comments.toFixed(1) : comments;
        const avgViewText  = avgView.toFixed ? avgView.toFixed(1) : avgView;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t._rank}</td>
          <td>${t.displayName || t.name || t.userId || "-"}</td>
          <td>${support}</td>
          <td>${commentsText}</td>
          <td>${minutes}</td>
          <td>${avgViewText}</td>
          <td>${badges}</td>
          <td>${diamonds}</td>
          <td>
            <div class="bar-track">
              <div class="bar-fill" style="width:${barWidth}%;"></div>
            </div>
          </td>
        `;
        // è¡Œã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ã¸
        tr.addEventListener("click", () => {
          if (t.userId) {
            talentSelect.value = t.userId;
            renderTalentDetail(t.userId);
          }
        });
        rankingBody.appendChild(tr);
      });
    }

    rankingSearch.addEventListener("input", () => {
      renderRankingFiltered();
    });

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ã®ã‚½ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll("th.sortable").forEach((th) => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort-key");
        if (!key) return;

        // åŒã˜åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰æ˜‡é †â‡”é™é †ã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (currentSort.key === key) {
          currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = key;
          currentSort.dir = "desc"; // ãƒ‡ãƒ•ã‚©ã¯é™é †ï¼ˆã‚¹ã‚³ã‚¢é«˜ã„é †ï¼‰
        }

        // è¦‹ãŸç›®æ›´æ–°
        document.querySelectorAll("th.sortable").forEach((el) => {
          el.removeAttribute("data-sort-dir");
        });
        th.setAttribute("data-sort-dir", currentSort.dir);

        renderRankingFiltered();
      });
    });

    // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ¯”è¼ƒ
    function renderManagerTable(list) {
      managerBody.innerHTML = "";
      if (!Array.isArray(list) || list.length === 0) {
        managerBody.innerHTML =
          '<tr><td colspan="5" class="small">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      list.forEach((m) => {
        const diamonds = Number(m.totalDiamonds || 0);
        const salary   = Number(
          typeof m.salary10pct !== "undefined" ? m.salary10pct : diamonds * 0.1
        );
        const salaryText = salary.toFixed ? salary.toFixed(1) : salary;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.managerId || "-"}</td>
          <td>${m.managerName || "-"}</td>
          <td>${m.talentCount || 0}</td>
          <td>${diamonds}</td>
          <td>${salaryText}</td>
        `;
        managerBody.appendChild(tr);
      });
    }

    // ===== å…¨ä½“ã‚µãƒãƒªãƒ¼ & ã‚¢ãƒ©ãƒ¼ãƒˆ =====
    function updateOrgSummaryAndAlerts() {
      orgSummaryKpi.innerHTML = "";
      orgAlertList.innerHTML = "";

      if (!Array.isArray(rankingData) || rankingData.length === 0) {
        orgSummaryKpi.innerHTML =
          '<div class="small">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ã‚µãƒãƒªãƒ¼ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚</div>';
        orgAlertList.innerHTML =
          '<li>CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚</li>';
        return;
      }

      const n = rankingData.length;
      let totalSupport = 0;
      let totalComments = 0;
      let totalViewers = 0;
      let totalMinutes = 0;
      let zeroSupportCount = 0;

      rankingData.forEach((t) => {
        const s = Number(t.supportPoints || 0);
        const c = Number(t.commentsPer30   || 0);
        const v = Number(t.avgViewers      || 0);
        const m = Number(t.totalMinutes    || 0);
        totalSupport += s;
        totalComments += c;
        totalViewers += v;
        totalMinutes += m;
        if (s === 0) zeroSupportCount++;
      });

      const avgSupport   = totalSupport / n;
      const avgComments  = totalComments / n;
      const avgViewers   = totalViewers / n;
      const avgMinutes   = totalMinutes / n;
      const totalHours   = totalMinutes / 60;

      const kpis = [
        {
          label: "æ‰€å±ã‚¿ãƒ¬ãƒ³ãƒˆæ•°",
          value: `${n} äºº`,
          sub: "CSVã«å«ã¾ã‚Œã‚‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¯¾è±¡"
        },
        {
          label: "ç·å¿œæ´ãƒã‚¤ãƒ³ãƒˆ",
          value: totalSupport.toLocaleString(),
          sub: "å…¨ã‚¿ãƒ¬ãƒ³ãƒˆåˆè¨ˆ"
        },
        {
          label: "å¹³å‡å¿œæ´ãƒã‚¤ãƒ³ãƒˆ / äºº",
          value: avgSupport.toFixed(1),
          sub: "ã‚¿ãƒ¬ãƒ³ãƒˆ1äººã‚ãŸã‚Š"
        },
        {
          label: "å¹³å‡ã‚³ãƒ¡ãƒ³ãƒˆ /30åˆ†",
          value: avgComments.toFixed(1),
          sub: "äº‹å‹™æ‰€å…¨ä½“ã®å¹³å‡"
        },
        {
          label: "å¹³å‡è¦–è´è€…æ•°",
          value: avgViewers.toFixed(1),
          sub: "äº‹å‹™æ‰€å…¨ä½“ã®å¹³å‡"
        },
        {
          label: "ç·é…ä¿¡æ™‚é–“",
          value: `${totalHours.toFixed(1)} h`,
          sub: `å¹³å‡ ${avgMinutes.toFixed(1)} min / äºº`
        }
      ];

      kpis.forEach((k) => {
        const card = document.createElement("div");
        card.className = "kpi-card";
        card.innerHTML = `
          <div class="kpi-label">${k.label}</div>
          <div class="kpi-value">${k.value}</div>
          <div class="kpi-sub">${k.sub}</div>
        `;
        orgSummaryKpi.appendChild(card);
      });

      // ã‚¢ãƒ©ãƒ¼ãƒˆç”Ÿæˆ
      const alerts = [];

      if (zeroSupportCount > 0) {
        alerts.push(`å¿œæ´ãƒã‚¤ãƒ³ãƒˆãŒ 0 ã®ã‚¿ãƒ¬ãƒ³ãƒˆãŒ <b>${zeroSupportCount}äºº</b> ã„ã¾ã™ã€‚åˆé…ä¿¡ã‚µãƒãƒ¼ãƒˆã‚„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`);
      }

      // é…ä¿¡æ™‚é–“ã¯é•·ã„ã®ã«ãƒã‚¤ãƒ³ãƒˆãŒä½ã„ã‚¿ãƒ¬ãƒ³ãƒˆ
      const hardworking = rankingData.filter((t) => {
        const m = Number(t.totalMinutes || 0);
        const s = Number(t.supportPoints || 0);
        return m > avgMinutes * 1.5 && s < avgSupport * 0.5;
      }).slice(0, 5);

      if (hardworking.length > 0) {
        const names = hardworking.map(t => t.displayName || t.userId).join(" / ");
        alerts.push(`é…ä¿¡æ™‚é–“ã¯é•·ã„ã®ã«å¿œæ´ãƒã‚¤ãƒ³ãƒˆãŒä¼¸ã³ã¦ã„ãªã„ã‚¿ãƒ¬ãƒ³ãƒˆï¼š<b>${names}</b>ã€‚ä¼ç”»å†…å®¹ã‚„ã‚µãƒ ãƒãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚`);
      }

      // è¦–è´è€…ã¯å¤šã„ã®ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒå°‘ãªã„ã‚¿ãƒ¬ãƒ³ãƒˆï¼ˆã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆä½ã‚ï¼‰
      const lowEngage = rankingData.filter((t) => {
        const c = Number(t.commentsPer30 || 0);
        const v = Number(t.avgViewers    || 0);
        return v > avgViewers * 1.2 && c < avgComments * 0.6;
      }).slice(0, 5);

      if (lowEngage.length > 0) {
        const names = lowEngage.map(t => t.displayName || t.userId).join(" / ");
        alerts.push(`è¦–è´è€…æ•°ã¯é«˜ã„ã®ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒå°‘ãªã„ã‚¿ãƒ¬ãƒ³ãƒˆï¼š<b>${names}</b>ã€‚å‘¼ã³ã‹ã‘ã‚„ä¼ç”»æ§‹æˆã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿ƒã™ã¨ã€ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãŒä¼¸ã³ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
      }

      if (alerts.length === 0) {
        orgAlertList.innerHTML =
          '<li>ç‰¹ã«é¡•è‘—ãªã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å…¨ä½“çš„ã«ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„çŠ¶æ…‹ã§ã™ã€‚</li>';
      } else {
        alerts.forEach((msg) => {
          const li = document.createElement("li");
          li.innerHTML = msg;
          orgAlertList.appendChild(li);
        });
      }
    }

    // ===== ã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ãƒ“ãƒ¥ãƒ¼ =====
    function populateTalentSelect() {
      talentSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰1äººé¸æŠã—ã¦ãã ã•ã„";
      talentSelect.appendChild(placeholder);

      if (!Array.isArray(rankingData) || rankingData.length === 0) return;

      rankingData.forEach((t, idx) => {
        const opt = document.createElement("option");
        opt.value = t.userId || "";
        const name = t.displayName || t.name || t.userId || "ä¸æ˜ãªã‚¿ãƒ¬ãƒ³ãƒˆ";
        opt.textContent = `#${idx + 1} ${name} / ${Number(t.supportPoints || 0).toLocaleString()} Pt`;
        talentSelect.appendChild(opt);
      });
    }

    talentSelect.addEventListener("change", () => {
      const uid = talentSelect.value;
      renderTalentDetail(uid);
    });

    function renderTalentDetail(userId) {
      if (!userId) {
        talentDetailPanel.innerHTML =
          "ã‚¿ãƒ¬ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        return;
      }
      if (!Array.isArray(rankingData) || rankingData.length === 0) {
        talentDetailPanel.innerHTML =
          "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ã‚¿ãƒ¬ãƒ³ãƒˆè©³ç´°ã‚’è¡¨ç¤ºã§ãã¾ã›ã‚“ã€‚";
        return;
      }

      const tIndex = rankingData.findIndex(t => t.userId === userId);
      if (tIndex === -1) {
        talentDetailPanel.innerHTML =
          "é¸æŠã—ãŸã‚¿ãƒ¬ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        return;
      }

      const t = rankingData[tIndex];

      const support   = Number(t.supportPoints || 0);
      const comments  = Number(t.commentsPer30 || 0);
      const minutes   = Number(t.totalMinutes || 0);
      const avgView   = Number(t.avgViewers || 0);
      const badges    = Number(t.badges || 0);
      const diamonds  = Number(t.diamonds || 0);

      // å…¨ä½“ã® max / å¹³å‡ ã‚’è¨ˆç®—
      let maxSupport = 1, maxComments = 1, maxViewers = 1, maxMinutes = 1;
      let avgSupport = 0, avgComments = 0, avgViewers = 0;
      rankingData.forEach((x) => {
        const s = Number(x.supportPoints || 0);
        const c = Number(x.commentsPer30 || 0);
        const v = Number(x.avgViewers    || 0);
        const m = Number(x.totalMinutes  || 0);
        maxSupport  = Math.max(maxSupport, s);
        maxComments = Math.max(maxComments, c);
        maxViewers  = Math.max(maxViewers, v);
        maxMinutes  = Math.max(maxMinutes, m);
        avgSupport += s;
        avgComments+= c;
        avgViewers += v;
      });
      const n = rankingData.length || 1;
      avgSupport /= n;
      avgComments/= n;
      avgViewers /= n;

      const supportPctOfMax  = Math.round((support  / maxSupport ) * 100);
      const commentsPctOfMax = Math.round((comments / maxComments) * 100);
      const viewersPctOfMax  = Math.round((avgView  / maxViewers ) * 100);
      const minutesPctOfMax  = Math.round((minutes  / maxMinutes) * 100);

      const rank = tIndex + 1;
      const name = t.displayName || t.name || t.userId || "ä¸æ˜ãªã‚¿ãƒ¬ãƒ³ãƒˆ";

      const engagementType = (() => {
        if (support > avgSupport * 1.5 && comments > avgComments * 1.2) {
          return "ğŸ”¥ ã‚³ã‚¢ãƒ•ã‚¡ãƒ³ã‚‚å¤šãã€ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ´»ç™ºãªã€Œã‚¨ãƒ¼ã‚¹å€™è£œã€ã‚¿ã‚¤ãƒ—ã§ã™ã€‚";
        }
        if (avgView > avgViewers * 1.3 && comments < avgComments * 0.7) {
          return "ğŸ‘€ è¦–è´ã¯å¤šã„ã‚‚ã®ã®ã€ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚„ã‚„å°‘ãªã‚ãªã€Œé™ã‹ãªè¦–è´è€…ã€ã‚¿ã‚¤ãƒ—ã§ã™ã€‚";
        }
        if (minutes > maxMinutes * 0.7 && support < avgSupport * 0.7) {
          return "ğŸ’ª é…ä¿¡æ™‚é–“ã¯é•·ã„ã®ã§ã€ä¼ç”»ã‚„å‘ŠçŸ¥ã‚’å·¥å¤«ã™ã‚Œã°ä¼¸ã³ã—ã‚ãŒå¤§ãã„ã‚¿ã‚¤ãƒ—ã§ã™ã€‚";
        }
        return "ğŸ“¡ ãƒãƒ©ãƒ³ã‚¹å‹ã€‚ä¼ç”»ãƒ»ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ»ã‚³ãƒ©ãƒœæ¬¡ç¬¬ã§ã¾ã ã¾ã ä¼¸ã°ã›ã‚‹ãƒã‚¸ã‚·ãƒ§ãƒ³ã§ã™ã€‚";
      })();

      talentDetailPanel.innerHTML = `
        <div class="talent-detail-header">
          <div>
            <div class="talent-detail-name">${name}</div>
            <div class="talent-detail-id">User ID: ${t.userId || "-"} ï½œ æ‰€å±ãƒ¬ãƒ¼ãƒ™ãƒ«: ${t.label || "StarLittleLuna"}</div>
          </div>
          <div class="talent-detail-badges">
            ãƒ©ãƒ³ã‚­ãƒ³ã‚°: <b>#${rank}</b><br>
            ãƒãƒƒã‚¸: <b>${badges}</b> / æœˆæœ«ãƒ€ã‚¤ãƒ¤: <b>${diamonds}</b>
          </div>
        </div>

        <div class="talent-detail-grid">
          <div class="talent-detail-item">
            <div class="talent-detail-item-title">å¿œæ´ãƒã‚¤ãƒ³ãƒˆ</div>
            <div class="talent-detail-item-main">${support.toLocaleString()} Pt</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${supportPctOfMax}%;"></div>
            </div>
            <div class="talent-detail-item-sub">
              äº‹å‹™æ‰€å†…æœ€å¤§å€¤ã«å¯¾ã—ã¦ <b>${supportPctOfMax}%</b>ï¼ˆå¹³å‡ ${avgSupport.toFixed(1)} Ptï¼‰
            </div>
          </div>

          <div class="talent-detail-item">
            <div class="talent-detail-item-title">ã‚³ãƒ¡ãƒ³ãƒˆ / 30åˆ†</div>
            <div class="talent-detail-item-main">${comments.toFixed(1)}</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${commentsPctOfMax}%;"></div>
            </div>
            <div class="talent-detail-item-sub">
              äº‹å‹™æ‰€å†…æœ€å¤§å€¤ã«å¯¾ã—ã¦ <b>${commentsPctOfMax}%</b>ï¼ˆå¹³å‡ ${avgComments.toFixed(1)}ï¼‰
            </div>
          </div>

          <div class="talent-detail-item">
            <div class="talent-detail-item-title">å¹³å‡è¦–è´è€…æ•°</div>
            <div class="talent-detail-item-main">${avgView.toFixed(1)} äºº</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${viewersPctOfMax}%;"></div>
            </div>
            <div class="talent-detail-item-sub">
              äº‹å‹™æ‰€å†…æœ€å¤§å€¤ã«å¯¾ã—ã¦ <b>${viewersPctOfMax}%</b>ï¼ˆå¹³å‡ ${avgViewers.toFixed(1)} äººï¼‰
            </div>
          </div>

          <div class="talent-detail-item">
            <div class="talent-detail-item-title">ç·é…ä¿¡æ™‚é–“</div>
            <div class="talent-detail-item-main">${minutes} åˆ†</div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${minutesPctOfMax}%;"></div>
            </div>
            <div class="talent-detail-item-sub">
              äº‹å‹™æ‰€å†…æœ€å¤§å€¤ã«å¯¾ã—ã¦ <b>${minutesPctOfMax}%</b>
            </div>
          </div>
        </div>

        <div style="margin-top:8px; font-size:12px;">
          <b>ç°¡æ˜“ã‚¿ã‚¤ãƒ—è¨ºæ–­ï¼š</b>${engagementType}
        </div>
      `;
    }

    // ===== AIåˆ†æ =====
    aiAnalyzeBtn.addEventListener("click", async () => {
      if (!APPS_SCRIPT_URL) {
        setMsg(aiMsg, "APPS_SCRIPT_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
        return;
      }
      try {
        setMsg(aiMsg, "AIãŒåˆ†æä¸­ã§ã™â€¦");
        aiAnalyzeBtn.disabled = true;
        aiResult.textContent = "";

        const res  = await fetch(APPS_SCRIPT_URL + "?mode=ai");
        const text = await res.text();

        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          console.error("AI JSON parse error:", text);
          setMsg(aiMsg, "AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
          aiResult.textContent = text.slice(0, 500);
          return;
        }

        if (json.status !== "ok") {
          setMsg(aiMsg, "AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: " + (json.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), "error");
          aiResult.textContent = json.aiText || "AIå´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
          return;
        }

        setMsg(aiMsg, "AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚", "success");
        aiResult.textContent = json.aiText || "AIã‹ã‚‰ã®ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã—ãŸã€‚";
      } catch (e) {
        console.error("AI analyze error:", e);
        setMsg(aiMsg, "AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      } finally {
        aiAnalyzeBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
