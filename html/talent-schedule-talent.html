<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - マイスケジュール（タレント）</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.95)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 18px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff8ff, #b0d9ff);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 14px rgba(154,123,255,0.45);
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-main {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    .user-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .btn-sm {
      padding: 4px 10px;
      font-size: 11px;
    }

    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--danger);
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }
    .error-banner.visible { display: block; }

    .success-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--success);
      background: #e6f4ea;
      border: 1px solid #c8e6c9;
      margin-top: 4px;
    }
    .success-banner.visible { display: block; }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar input {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      font-size: 12px;
    }

    .card {
      background: var(--sl-card);
      border-radius: 22px;
      padding: 14px 16px 16px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 24px rgba(186,199,255,0.45);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .new-schedule-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px 10px;
      margin-bottom: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .field label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .field input,
    .field select,
    .field textarea {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      font-size: 12px;
      background: #ffffff;
    }

    .field textarea {
      border-radius: 10px;
      min-height: 50px;
      resize: vertical;
    }

    .new-schedule-footer {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--sl-muted);
    }

    .list-header {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 1.1fr 0.7fr 0.7fr;
      gap: 8px;
      font-size: 11px;
      color: var(--sl-muted);
      padding: 4px 6px 6px;
      border-bottom: 1px solid #edf0ff;
    }

    .event-list {
      margin-top: 4px;
    }

    .event-row {
      border-radius: 14px;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: #fdfdff;
      border: 1px solid #f0f1ff;
      transition: background 0.12s, box-shadow 0.12s, transform 0.08s;
    }

    .event-row.unread-manager {
      border-color: #ffc4ce;
      background: #fff5f7;
    }

    .event-row:hover {
      background: #f8f5ff;
      box-shadow: 0 4px 10px rgba(183,188,228,0.40);
      transform: translateY(-1px);
    }

    .event-main {
      display: grid;
      grid-template-columns: 1.3fr 1.3fr 1.1fr 0.7fr 0.7fr;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }

    .event-title {
      font-weight: 600;
    }

    .event-date {
      font-size: 12px;
    }

    .event-type-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #e0e4ff;
      background: #f7f7ff;
      gap: 4px;
    }

    .event-type-stream { border-color:#c0e8cf; background:#e8f8ee; color:#0f9d58;}
    .event-type-record { border-color:#ffe0b3; background:#fff5e6; color:#f57c00;}
    .event-type-meeting { border-color:#cfd8ff; background:#edf3ff; color:#3f51b5;}
    .event-type-off { border-color:#e0e0e0; background:#f5f5f5; color:#757575;}

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #ffffffaa;
      color: #555;
    }

    .detail-panel {
      margin-top: 8px;
      border-radius: 14px;
      padding: 8px 10px 10px;
      background: #f7f5ff;
      border: 1px dashed #d8cef7;
      display: none;
      font-size: 12px;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px 10px;
    }

    .detail-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .detail-field label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .detail-field input,
    .detail-field select,
    .detail-field textarea {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      font-size: 12px;
      background: #ffffff;
    }

    .detail-field textarea {
      border-radius: 10px;
      min-height: 60px;
      resize: vertical;
    }

    .detail-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .detail-info {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .empty-state {
      padding: 16px 4px 6px;
      text-align: center;
      font-size: 13px;
      color: var(--sl-muted);
    }

    @media (max-width: 820px) {
      .page { padding: 16px 12px 24px; }
      .top-bar { flex-direction: column; align-items: flex-start; }
      .user-block { align-items:flex-start; }
      .new-schedule-grid { grid-template-columns: repeat(2,minmax(0,1fr)); }
      .list-header,
      .event-main {
        grid-template-columns: 1.5fr 1.3fr 1.1fr 0.8fr;
      }
      .col-type { display:none; }
    }

    @media (max-width: 600px) {
      .list-header { display:none; }
      .event-main {
        grid-template-columns: 1.6fr 1.2fr 1.1fr;
      }
      .col-title, .col-type { display:none; }
      .detail-grid {
        grid-template-columns: repeat(2,minmax(0,1fr));
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <div class="brand-logo">
            <!-- ロゴ画像はパスを環境に合わせて変更 -->
            <img src="../assets/sll-logo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-main">Star Little Luna</div>
            <div class="brand-text-sub">My Schedule</div>
          </div>
        </div>
        <div class="tag">TALENT / SCHEDULE</div>
        <div class="page-title">マイスケジュール</div>
        <div class="page-subtitle">
          あなた自身の配信・収録・面談・オフなどの予定を登録・編集できます。<br />
          マネージャーと共有される公式スケジュールです。
        </div>
      </div>

      <div class="user-block">
        <div>
          <button class="btn btn-sm" id="back-dashboard-btn">ダッシュボード</button>
          <button class="btn btn-sm" id="logout-btn">ログアウト</button>
        </div>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">Talent</div>
            <div class="user-role" id="user-role">タレント</div>
          </div>
        </div>
      </div>
    </header>

    <div id="error-banner" class="error-banner"></div>
    <div id="success-banner" class="success-banner"></div>
    <!-- 通知バナー（マネージャーからの新規スケジュール） -->
    <div id="notify-banner" class="success-banner"></div>

    <!-- 月フィルタ -->
    <section class="toolbar">
      <div class="toolbar-group">
        <span style="font-size:12px;color:var(--sl-muted);">表示する月:</span>
        <input id="month-filter" type="month" />
      </div>
      <div style="font-size:11px;color:var(--sl-muted);">
        日付・時間・タイトルを必ず入力してください。
      </div>
    </section>

    <!-- 新規スケジュール -->
    <section class="card" style="margin-top:4px;">
      <div class="card-title">新しい予定を追加</div>
      <div class="new-schedule-grid">
        <div class="field">
          <label for="new-date">日付</label>
          <input id="new-date" type="date" />
        </div>
        <div class="field">
          <label for="new-start">開始時刻</label>
          <input id="new-start" type="time" />
        </div>
        <div class="field">
          <label for="new-end">終了時刻</label>
          <input id="new-end" type="time" />
        </div>
        <div class="field">
          <label for="new-type">種別</label>
          <select id="new-type">
            <option value="stream">配信</option>
            <option value="recording">収録</option>
            <option value="meeting">面談 / MTG</option>
            <option value="off">オフ</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div class="field" style="grid-column:1 / -1;">
          <label for="new-title">タイトル / 内容</label>
          <input id="new-title" type="text" placeholder="例: YouTube配信『○○コラボ』" />
        </div>
        <div class="field" style="grid-column:1 / -1;">
          <label for="new-memo">メモ（任意）</label>
          <textarea id="new-memo" placeholder="URL / 相手先 / 注意点など"></textarea>
        </div>
      </div>
      <div class="new-schedule-footer">
        <span id="new-loading-text"></span>
        <button class="btn btn-primary btn-sm" id="create-event-btn">
          スケジュールを追加
        </button>
      </div>
    </section>

    <!-- 一覧 -->
    <section class="card" style="margin-top:10px;">
      <div class="card-title">登録済みスケジュール</div>
      <div class="list-header">
        <div>日付</div>
        <div>時間</div>
        <div class="col-type">種別</div>
        <div class="col-title">タイトル</div>
        <div>操作</div>
      </div>
      <div id="event-list" class="event-list"></div>
      <div id="empty-state" class="empty-state" style="display:none;">
        まだスケジュールが登録されていません。
      </div>
    </section>
  </div>

  <!-- Firebase & ロジック -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      query,
      orderBy,
      onSnapshot,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ==== Firebase 初期化 ====
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==== DOM ====
    const errorBanner = document.getElementById("error-banner");
    const successBanner = document.getElementById("success-banner");
    const notifyBanner = document.getElementById("notify-banner");
    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");

    const logoutBtn = document.getElementById("logout-btn");
    const backDashboardBtn = document.getElementById("back-dashboard-btn");

    const monthFilter = document.getElementById("month-filter");
    const newDateInput = document.getElementById("new-date");
    const newStartInput = document.getElementById("new-start");
    const newEndInput = document.getElementById("new-end");
    const newTypeSelect = document.getElementById("new-type");
    const newTitleInput = document.getElementById("new-title");
    const newMemoInput = document.getElementById("new-memo");
    const newLoadingText = document.getElementById("new-loading-text");
    const createEventBtn = document.getElementById("create-event-btn");

    const eventListEl = document.getElementById("event-list");
    const emptyStateEl = document.getElementById("empty-state");

    // ==== 共通関数 ====
    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }
    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }
    function showSuccess(msg) {
      successBanner.textContent = msg;
      successBanner.classList.add("visible");
      setTimeout(() => {
        successBanner.classList.remove("visible");
      }, 2500);
    }

    function typeLabel(type) {
      switch (type) {
        case "stream": return "配信";
        case "recording": return "収録";
        case "meeting": return "面談 / MTG";
        case "off": return "オフ";
        default: return "その他";
      }
    }

    function typeClass(type) {
      switch (type) {
        case "stream": return "event-type-pill event-type-stream";
        case "recording": return "event-type-pill event-type-record";
        case "meeting": return "event-type-pill event-type-meeting";
        case "off": return "event-type-pill event-type-off";
        default: return "event-type-pill";
      }
    }

    function setDefaultMonth() {
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
      monthFilter.value = ym;
    }

    // ==== ナビ ====
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    backDashboardBtn.addEventListener("click", () => {
      window.location.href = "./dashboard.html";
    });

    // ==== 状態 ====
    let currentTalentId = null;
    let eventsUnsub = null;
    let currentEvents = [];

    // ==== ログイン確認 ====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          return;
        }
        const data = snap.data();

        const roleType = data.roleType || "talent";
        if (roleType !== "talent") {
          showError("このページはタレント専用です。");
          setTimeout(() => { window.location.href = "./dashboard.html"; }, 1500);
          return;
        }

        const displayName = data.displayName || user.displayName || "No Name";
        const talentId = data.talentId;
        if (!talentId) {
          showError("タレントIDが紐づいていません。マネージャーに連絡してください。");
          return;
        }

        currentTalentId = talentId;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = "タレントアカウント";

        // デフォルトで今月をセット
        setDefaultMonth();

        subscribeEvents();
      } catch (err) {
        console.error(err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
      }
    });

    monthFilter.addEventListener("change", () => {
      renderEvents();
    });

    // ==== スケジュール購読 ====
    function subscribeEvents() {
      if (!currentTalentId) return;

      if (eventsUnsub) {
        eventsUnsub();
        eventsUnsub = null;
      }
      currentEvents = [];
      renderEvents();

      const eventsRef = collection(db, "talentSchedules", currentTalentId, "events");
      const eventsQuery = query(eventsRef, orderBy("date"), orderBy("startTime"));

      eventsUnsub = onSnapshot(
        eventsQuery,
        (snapshot) => {
          currentEvents = snapshot.docs.map((d) => ({
            id: d.id,
            data: d.data(),
          }));

          // マネージャーから追加された未読件数
          const unreadForTalent = currentEvents.filter(({ data }) =>
            data.createdBy === "manager" && data.readByTalent === false
          ).length;

          if (unreadForTalent > 0) {
            notifyBanner.textContent =
              `マネージャーから新しいスケジュールが ${unreadForTalent} 件追加されています。`;
            notifyBanner.classList.add("visible");
          } else {
            notifyBanner.classList.remove("visible");
          }

          renderEvents();
        },
        (err) => {
          console.error(err);
          showError("スケジュールの取得中にエラーが発生しました。");
        }
      );
    }

    // ==== 新規スケジュール追加 ====
    createEventBtn.addEventListener("click", async () => {
      hideError();
      if (!currentTalentId) {
        showError("タレントIDが設定されていません。");
        return;
      }

      const date = newDateInput.value;
      const startTime = newStartInput.value;
      const endTime = newEndInput.value;
      const type = newTypeSelect.value || "other";
      const title = newTitleInput.value.trim();
      const memo = newMemoInput.value.trim();

      if (!date || !startTime || !endTime || !title) {
        showError("日付・時間・タイトルは必須です。");
        return;
      }

      createEventBtn.disabled = true;
      newLoadingText.textContent = "登録中…";

      try {
        const eventsRef = collection(db, "talentSchedules", currentTalentId, "events");
        await addDoc(eventsRef, {
          date,
          startTime,
          endTime,
          type,
          title,
          memo: memo || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          createdBy: "talent",       // タレントが作成
          readByTalent: true,        // 自分は即既読
          readByManager: false       // マネージャー側で未読として扱う
        });

        newTitleInput.value = "";
        newMemoInput.value = "";
        newLoadingText.textContent = "";
      } catch (err) {
        console.error(err);
        showError("スケジュール登録中にエラーが発生しました。");
        newLoadingText.textContent = "";
      } finally {
        createEventBtn.disabled = false;
      }
    });

    // ==== 一覧描画 ====
    function renderEvents() {
      if (!currentTalentId) {
        eventListEl.innerHTML = "";
        emptyStateEl.style.display = "block";
        emptyStateEl.textContent = "タレント情報が読み込まれていません。";
        return;
      }

      if (!currentEvents || currentEvents.length === 0) {
        eventListEl.innerHTML = "";
        emptyStateEl.style.display = "block";
        emptyStateEl.textContent = "まだスケジュールが登録されていません。";
        return;
      }

      const month = monthFilter.value; // "YYYY-MM"
      const filtered = currentEvents.filter(({ data }) => {
        if (!month) return true;
        return (data.date || "").startsWith(month);
      });

      if (filtered.length === 0) {
        eventListEl.innerHTML = "";
        emptyStateEl.style.display = "block";
        emptyStateEl.textContent = "この月にはスケジュールがありません。";
        return;
      }

      emptyStateEl.style.display = "none";

      let html = "";
      for (const { id, data } of filtered) {
        const date = data.date || "";
        const start = data.startTime || "";
        const end = data.endTime || "";
        const type = data.type || "other";
        const title = data.title || "";
        const memo = data.memo || "";
        const createdBy = data.createdBy || "talent";
        const readByTalent = data.readByTalent !== undefined ? data.readByTalent : true;

        const updatedAtText =
          data.updatedAt && data.updatedAt.toDate
            ? data.updatedAt.toDate().toLocaleString("ja-JP")
            : "-";

        const isManagerEvent = createdBy === "manager";
        const isUnreadFromManager = isManagerEvent && !readByTalent;

        const rowClass = isUnreadFromManager ? "event-row unread-manager" : "event-row";

        const sourceBadge = isManagerEvent
          ? `<span class="badge">from Manager</span>`
          : `<span class="badge">My Entry</span>`;

        html += `
          <div class="${rowClass}" data-id="${id}">
            <div class="event-main">
              <div class="event-date">${date}</div>
              <div>${start} 〜 ${end}</div>
              <div class="col-type">
                <span class="${typeClass(type)}">
                  ${typeLabel(type)}
                  ${sourceBadge}
                </span>
              </div>
              <div class="col-title">
                <div class="event-title">${title.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>
              </div>
              <div style="text-align:right;">
                <button type="button" class="btn btn-sm event-toggle" data-id="${id}">
                  詳細
                </button>
              </div>
            </div>

            <div class="detail-panel" id="detail-${id}">
              <div class="detail-grid">
                <div class="detail-field">
                  <label>日付</label>
                  <input type="date" id="date-${id}" value="${date}" />
                </div>
                <div class="detail-field">
                  <label>開始時刻</label>
                  <input type="time" id="start-${id}" value="${start}" />
                </div>
                <div class="detail-field">
                  <label>終了時刻</label>
                  <input type="time" id="end-${id}" value="${end}" />
                </div>
                <div class="detail-field">
                  <label>種別</label>
                  <select id="type-${id}">
                    ${renderTypeOptions(type)}
                  </select>
                </div>
                <div class="detail-field" style="grid-column:1 / -1;">
                  <label>タイトル / 内容</label>
                  <input type="text" id="title-${id}" value="${title.replace(/"/g,"&quot;")}" />
                </div>
                <div class="detail-field" style="grid-column:1 / -1;">
                  <label>メモ</label>
                  <textarea id="memo-${id}">${memo.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea>
                </div>
              </div>
              <div class="detail-footer">
                <div class="detail-info">最終更新: ${updatedAtText}</div>
                <div style="display:flex;gap:6px;">
                  <button type="button" class="btn btn-sm event-delete" data-id="${id}">
                    削除
                  </button>
                  <button type="button" class="btn btn-sm event-save" data-id="${id}">
                    保存
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      eventListEl.innerHTML = html;

      document.querySelectorAll(".event-toggle").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          toggleDetail(id);
        });
      });

      document.querySelectorAll(".event-save").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          saveEvent(id);
        });
      });

      document.querySelectorAll(".event-delete").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          deleteEvent(id);
        });
      });
    }

    function renderTypeOptions(selected) {
      const types = [
        { value: "stream", label: "配信" },
        { value: "recording", label: "収録" },
        { value: "meeting", label: "面談 / MTG" },
        { value: "off", label: "オフ" },
        { value: "other", label: "その他" },
      ];
      return types
        .map((t) => {
          const sel = t.value === selected ? "selected" : "";
          return `<option value="${t.value}" ${sel}>${t.label}</option>`;
        })
        .join("");
    }

    async function markAsReadIfNeeded(id) {
      // マネージャー作成 & 未読なら既読にする
      const target = currentEvents.find((ev) => ev.id === id);
      if (!target || !currentTalentId) return;

      const data = target.data;
      if (data.createdBy === "manager" && data.readByTalent === false) {
        try {
          const ref = doc(db, "talentSchedules", currentTalentId, "events", id);
          await updateDoc(ref, {
            readByTalent: true,
            updatedAt: serverTimestamp(),
          });
        } catch (err) {
          console.error("failed to update readByTalent:", err);
        }
      }
    }

    function toggleDetail(id) {
      const panel = document.getElementById(`detail-${id}`);
      if (!panel) return;
      const visible = panel.style.display === "block";
      document.querySelectorAll(".detail-panel").forEach((p) => {
        p.style.display = "none";
      });
      panel.style.display = visible ? "none" : "block";

      // 詳細を開いたタイミングで「既読」にする
      if (!visible) {
        markAsReadIfNeeded(id);
      }
    }

    // ==== 保存 / 削除 ====
    async function saveEvent(eventId) {
      hideError();
      if (!currentTalentId) return;

      const dateEl = document.getElementById(`date-${eventId}`);
      const startEl = document.getElementById(`start-${eventId}`);
      const endEl = document.getElementById(`end-${eventId}`);
      const typeEl = document.getElementById(`type-${eventId}`);
      const titleEl = document.getElementById(`title-${eventId}`);
      const memoEl = document.getElementById(`memo-${eventId}`);

      const date = dateEl.value;
      const startTime = startEl.value;
      const endTime = endEl.value;
      const type = typeEl.value || "other";
      const title = titleEl.value.trim();
      const memo = memoEl.value.trim();

      if (!date || !startTime || !endTime || !title) {
        showError("日付・時間・タイトルは必須です。");
        return;
      }

      try {
        const ref = doc(db, "talentSchedules", currentTalentId, "events", eventId);
        await updateDoc(ref, {
          date,
          startTime,
          endTime,
          type,
          title,
          memo: memo || null,
          updatedAt: serverTimestamp(),
        });
        showSuccess("スケジュールを保存しました。");
      } catch (err) {
        console.error(err);
        showError("スケジュール保存中にエラーが発生しました。");
      }
    }

    async function deleteEvent(eventId) {
      hideError();
      if (!currentTalentId) return;

      const ok = window.confirm("このスケジュールを削除しますか？");
      if (!ok) return;

      try {
        const ref = doc(db, "talentSchedules", currentTalentId, "events", eventId);
        await deleteDoc(ref);
        showSuccess("スケジュールを削除しました。");
      } catch (err) {
        console.error(err);
        showError("スケジュール削除中にエラーが発生しました。");
      }
    }
  </script>
</body>
</html>
