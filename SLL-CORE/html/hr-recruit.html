<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - 採用管理</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-primary-soft: #f6ebff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.97)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ヘッダー */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 90px;
      height: 90px;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* ユーザー＆ボタン */
    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .btn-secondary {
      background: #f7f5ff;
    }

    /* バナー */
    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #e63946;
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible {
      display: block;
    }

    .info-banner {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--sl-muted);
      background: #f6f2ff;
      border: 1px solid #e1d7ff;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    .loading-text {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* レイアウト */
    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 960px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
      .brand-logo {
        width: 80px;
        height: 80px;
      }
    }

    .card {
      background: var(--sl-card);
      border-radius: 18px;
      padding: 14px 16px 16px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 25px rgba(186,199,255,0.4);
      margin-top: 4px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 11px;
      color: var(--sl-muted);
      margin-bottom: 8px;
    }

    /* フォーム */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .form-grid-full {
      grid-template-columns: 1fr;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--sl-border);
      outline: none;
      background: #ffffff;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 1px rgba(195,130,255,0.45);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row-full {
      grid-column: 1 / -1;
    }

    .hint {
      font-size: 10px;
      color: var(--sl-muted);
    }

    .form-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .form-status {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 4px;
    }

    /* ステータス＆カウンタ */
    .status-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e0e0ff;
      background: #f7f7ff;
      color: var(--sl-primary);
    }

    .status-chip.open {
      background: #e6f7ec;
      border-color: #b5e3c7;
      color: #1f7a3f;
    }

    .status-chip.draft {
      background: #fff7e6;
      border-color: #ffe2b5;
      color: #b57400;
    }

    .status-chip.closed {
      background: #f0f0f5;
      border-color: #d3d3e0;
      color: #777;
    }

    .counter-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .counter-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f7f7ff;
      border: 1px solid #e1d7ff;
      color: var(--sl-primary);
    }

    /* テーブル */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f5f4ff;
    }

    th, td {
      padding: 7px 8px;
      border-bottom: 1px solid #eaecf5;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      color: var(--sl-muted);
      font-weight: 500;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.08s;
    }

    tbody tr:hover {
      background: #f7f7ff;
    }

    .nowrap {
      white-space: nowrap;
    }

    .small-muted {
      font-size: 10px;
      color: var(--sl-muted);
    }

    .filter-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .filter-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .filter-select {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
    }

    .no-data {
      font-size: 12px;
      color: var(--sl-muted);
      padding: 10px 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <div class="brand-logo">
            <img src="../assets/slllogo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-sub">HR / Recruit Center</div>
          </div>
        </div>
        <div class="tag">HR / Recruit</div>
        <div class="page-title">採用管理・求人一覧</div>
        <div class="page-subtitle">
          求人票の作成・管理と、採用ポジションの状況を一覧で確認します。
        </div>
      </div>

      <div class="user-block">
        <button class="btn" id="back-hr-dashboard-btn">人事メニュー</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <!-- バナー -->
    <div id="error-banner" class="error-banner"></div>
    <div class="info-banner">
      <span id="role-info-text">
        ログイン情報を確認しています…
      </span>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading-text">
      Firebase Auth / Firestore から求人データを読み込んでいます…
    </div>

    <!-- 本体 -->
    <section id="content-section" style="display:none;">
      <div class="layout-grid">
        <!-- 左：新規求人作成 -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title">新規求人を作成</div>
              <div class="card-sub">
                社内向けの求人情報を作成します。必要に応じて外部募集媒体とも連携する前提のマスタです。
              </div>
            </div>
            <span class="status-chip">Recruit Master</span>
          </div>

          <form id="create-form" autocomplete="off">
            <div class="form-grid">
              <div class="form-group form-row-full">
                <label class="form-label" for="job-title">
                  求人タイトル <span style="color:var(--danger);">*</span>
                </label>
                <input id="job-title" type="text" class="form-input"
                       placeholder="例：VTuberタレントマネージャー（正社員）" required />
              </div>

              <div class="form-group">
                <label class="form-label" for="job-dept">配属部署</label>
                <input id="job-dept" type="text" class="form-input"
                       placeholder="例：プロダクション部／人事部" />
              </div>

              <div class="form-group">
                <label class="form-label" for="job-type">雇用形態</label>
                <select id="job-type" class="form-select">
                  <option value="full-time">正社員</option>
                  <option value="contract">契約社員</option>
                  <option value="part-time">アルバイト・パート</option>
                  <option value="intern">インターン</option>
                  <option value="outsourcing">業務委託</option>
                  <option value="other">その他</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="job-location">勤務地</label>
                <input id="job-location" type="text" class="form-input"
                       placeholder="例：渋谷区道玄坂（ハイブリッド可）" />
              </div>

              <div class="form-group">
                <label class="form-label" for="job-status">募集ステータス</label>
                <select id="job-status" class="form-select">
                  <option value="open">募集中</option>
                  <option value="draft">下書き</option>
                  <option value="closed">クローズ</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="job-slots">募集人数</label>
                <input id="job-slots" type="number" class="form-input" min="1"
                       placeholder="例：2" />
              </div>

              <div class="form-group">
                <label class="form-label" for="job-start-date">掲載開始日（任意）</label>
                <input id="job-start-date" type="text" class="form-input"
                       placeholder="例：2025-04-01" />
              </div>

              <div class="form-group">
                <label class="form-label" for="job-end-date">掲載終了日（任意）</label>
                <input id="job-end-date" type="text" class="form-input"
                       placeholder="例：2025-06-30" />
              </div>

              <div class="form-group form-row-full">
                <label class="form-label" for="job-notes">メモ・ポイント</label>
                <textarea id="job-notes" class="form-textarea"
                          placeholder="業務内容の概要や、採用背景、必須条件など簡単なメモを書いておけます。"></textarea>
                <div class="hint">
                  詳細な求人票の項目（業務内容・必須条件・歓迎条件など）は、将来的に別画面（求人詳細）で拡張していく想定です。
                </div>
              </div>
            </div>

            <div class="form-footer">
              <button type="reset" class="btn btn-secondary">クリア</button>
              <button type="submit" class="btn btn-primary" id="create-btn">
                求人を登録する
              </button>
            </div>
            <div class="form-status" id="create-status">
              必要事項を入力して「求人を登録する」を押してください。
            </div>
          </form>
        </div>

        <!-- 右：求人一覧 -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title">求人一覧</div>
              <div class="card-sub">
                Firestore 上の <code>recruitJobs</code> コレクションをリアルタイムに一覧表示します。
                行をクリックすると求人詳細画面（hr-recruit-detail.html）に遷移する想定です。
              </div>
            </div>
          </div>

          <div class="filter-row">
            <div class="filter-group">
              <span class="filter-label">ステータスフィルタ：</span>
              <select id="status-filter" class="filter-select">
                <option value="all">すべて</option>
                <option value="open">募集中</option>
                <option value="draft">下書き</option>
                <option value="closed">クローズ</option>
              </select>
            </div>
            <div class="counter-row">
              <div class="counter-pill" id="counter-total">全件: 0</div>
              <div class="counter-pill" id="counter-open">募集中: 0</div>
              <div class="counter-pill" id="counter-draft">下書き: 0</div>
              <div class="counter-pill" id="counter-closed">クローズ: 0</div>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>求人タイトル</th>
                  <th>部署</th>
                  <th>雇用形態</th>
                  <th>ステータス</th>
                  <th>勤務地</th>
                  <th>募集人数</th>
                  <th>掲載期間</th>
                  <th>作成日時</th>
                </tr>
              </thead>
              <tbody id="jobs-tbody">
                <!-- rows -->
              </tbody>
            </table>
          </div>
          <div class="no-data" id="no-data" style="display:none;">
            現在、求人は登録されていません。
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase / Auth / Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const errorBanner = document.getElementById("error-banner");
    const roleInfoText = document.getElementById("role-info-text");
    const loadingEl = document.getElementById("loading");
    const contentSection = document.getElementById("content-section");

    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");

    const logoutBtn = document.getElementById("logout-btn");
    const backHrDashboardBtn = document.getElementById("back-hr-dashboard-btn");

    const createForm = document.getElementById("create-form");
    const createBtn = document.getElementById("create-btn");
    const createStatus = document.getElementById("create-status");

    const jobTitleInput = document.getElementById("job-title");
    const jobDeptInput = document.getElementById("job-dept");
    const jobTypeSelect = document.getElementById("job-type");
    const jobLocationInput = document.getElementById("job-location");
    const jobStatusSelect = document.getElementById("job-status");
    const jobSlotsInput = document.getElementById("job-slots");
    const jobStartDateInput = document.getElementById("job-start-date");
    const jobEndDateInput = document.getElementById("job-end-date");
    const jobNotesInput = document.getElementById("job-notes");

    const statusFilterSelect = document.getElementById("status-filter");
    const jobsTbody = document.getElementById("jobs-tbody");
    const noDataEl = document.getElementById("no-data");

    const counterTotal = document.getElementById("counter-total");
    const counterOpen = document.getElementById("counter-open");
    const counterDraft = document.getElementById("counter-draft");
    const counterClosed = document.getElementById("counter-closed");

    let currentUserUid = null;
    let currentUserName = null;
    let currentUserRoleType = null;
    let currentUserIsManager = false;
    let currentUserIsAdmin = false;

    let allJobs = [];

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }

    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    function applyAccessControl(roleType, isManager, isAdmin) {
      // Admin / 役員 / マネージャー以外はアクセス不可
      if (roleType === "executive" || isAdmin || isManager) {
        return true;
      }
      roleInfoText.textContent =
        "このページは採用管理画面です。Admin / 役員 / マネージャー以外はアクセスできません。人事メニューへ戻ります。";
      setTimeout(() => {
        window.location.href = "./admin-hr.html";
      }, 2000);
      return false;
    }

    function formatTimestamp(ts) {
      if (!ts) return "";
      try {
        const d = ts.toDate();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      } catch {
        return "";
      }
    }

    function statusClass(status) {
      if (status === "open") return "open";
      if (status === "draft") return "draft";
      if (status === "closed") return "closed";
      return "";
    }

    // ナビゲーション
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    backHrDashboardBtn.addEventListener("click", () => {
      window.location.href = "./admin-hr.html";
    });

    // 求人一覧描画
    function renderJobs() {
      const filter = statusFilterSelect.value || "all";
      jobsTbody.innerHTML = "";

      let filtered = allJobs;
      if (filter !== "all") {
        filtered = allJobs.filter(j => (j.status || "draft") === filter);
      }

      // カウンタ計算
      const total = allJobs.length;
      const openCount = allJobs.filter(j => (j.status || "draft") === "open").length;
      const draftCount = allJobs.filter(j => (j.status || "draft") === "draft").length;
      const closedCount = allJobs.filter(j => (j.status || "draft") === "closed").length;

      counterTotal.textContent = `全件: ${total}`;
      counterOpen.textContent = `募集中: ${openCount}`;
      counterDraft.textContent = `下書き: ${draftCount}`;
      counterClosed.textContent = `クローズ: ${closedCount}`;

      if (filtered.length === 0) {
        noDataEl.style.display = "block";
        return;
      }
      noDataEl.style.display = "none";

      for (const job of filtered) {
        const tr = document.createElement("tr");
        tr.dataset.id = job.id;

        const periodText = (job.startDate || job.endDate)
          ? `${job.startDate || "未設定"} 〜 ${job.endDate || "未設定"}`
          : "";

        tr.innerHTML = `
          <td class="nowrap">${job.title || "-"}</td>
          <td>${job.dept || "-"}</td>
          <td>${job.employmentTypeLabel || "-"}</td>
          <td>
            <span class="status-chip ${statusClass(job.status)}">
              ${job.statusLabel || "-"}
            </span>
          </td>
          <td>${job.location || "-"}</td>
          <td>${job.slotsText || "-"}</td>
          <td>${periodText || "-"}</td>
          <td>${job.createdAtStr || "-"}</td>
        `;

        tr.addEventListener("click", () => {
          // 将来の詳細画面用
          window.location.href = `./hr-recruit-detail.html?id=${job.id}`;
        });

        jobsTbody.appendChild(tr);
      }
    }

    statusFilterSelect.addEventListener("change", () => {
      renderJobs();
    });

    function mapEmploymentTypeLabel(value) {
      switch (value) {
        case "full-time": return "正社員";
        case "contract": return "契約社員";
        case "part-time": return "アルバイト・パート";
        case "intern": return "インターン";
        case "outsourcing": return "業務委託";
        case "other": return "その他";
        default: return "-";
      }
    }

    function mapStatusLabel(value) {
      switch (value) {
        case "open": return "募集中";
        case "draft": return "下書き";
        case "closed": return "クローズ";
        default: return "-";
      }
    }

    // Firestore リアルタイム購読
    function subscribeJobs() {
      const colRef = collection(db, "recruitJobs");
      const qJobs = query(colRef, orderBy("createdAt", "desc"));

      onSnapshot(qJobs, (snapshot) => {
        const items = [];
        snapshot.forEach((docSnap) => {
          const d = docSnap.data();
          const status = d.status || "draft";
          const employmentType = d.employmentType || "full-time";
          const createdAtStr = formatTimestamp(d.createdAt);

          const slots = d.slots;
          let slotsText = "-";
          if (slots != null && !Number.isNaN(slots)) {
            slotsText = `${slots}名`;
          }

          items.push({
            id: docSnap.id,
            title: d.title || "",
            dept: d.dept || "",
            employmentType: employmentType,
            employmentTypeLabel: mapEmploymentTypeLabel(employmentType),
            status: status,
            statusLabel: mapStatusLabel(status),
            location: d.location || "",
            slots: slots,
            slotsText: slotsText,
            startDate: d.startDate || "",
            endDate: d.endDate || "",
            createdAtStr,
          });
        });

        allJobs = items;
        renderJobs();
      }, (err) => {
        console.error("onSnapshot recruitJobs error:", err);
        showError("求人データの取得中にエラーが発生しました。");
      });
    }

    // 新規求人作成
    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();

      const title = jobTitleInput.value.trim();
      if (!title) {
        showError("求人タイトルは必須です。");
        createStatus.textContent = "求人タイトルを入力してください。";
        return;
      }

      const dept = jobDeptInput.value.trim();
      const employmentType = jobTypeSelect.value || "full-time";
      const location = jobLocationInput.value.trim();
      const status = jobStatusSelect.value || "draft";
      const slotsRaw = jobSlotsInput.value.trim();
      const startDate = jobStartDateInput.value.trim();
      const endDate = jobEndDateInput.value.trim();
      const notes = jobNotesInput.value.trim();

      let slots = null;
      if (slotsRaw) {
        const n = parseInt(slotsRaw, 10);
        if (!Number.isNaN(n)) {
          slots = n;
        }
      }

      createBtn.disabled = true;
      createBtn.textContent = "登録中…";
      createStatus.textContent = "求人データを登録しています…";

      try {
        const payload = {
          title,
          dept,
          employmentType,
          location,
          status,
          slots,
          startDate,
          endDate,
          notes,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          createdBy: currentUserUid,
          createdByName: currentUserName || "",
        };

        await addDoc(collection(db, "recruitJobs"), payload);

        createStatus.textContent = "求人を登録しました。";
        createBtn.disabled = false;
        createBtn.textContent = "求人を登録する";
        createForm.reset();
        // 雇用形態・ステータスは初期値に戻す
        jobTypeSelect.value = "full-time";
        jobStatusSelect.value = "open";

      } catch (err) {
        console.error("addDoc recruitJobs error:", err);
        showError("求人の登録中にエラーが発生しました。");
        createStatus.textContent = "エラーが発生しました。入力内容を確認して再度お試しください。";
        createBtn.disabled = false;
        createBtn.textContent = "求人を登録する";
      }
    });

    // Auth 監視
    onAuthStateChanged(auth, async (user) => {
      hideError();

      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          loadingEl.textContent = "ユーザーデータが見つかりませんでした。";
          return;
        }

        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        currentUserUid = user.uid;
        currentUserName = displayName;
        currentUserRoleType = roleType;
        currentUserIsManager = isManager;
        currentUserIsAdmin = isAdmin;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        roleInfoText.innerHTML = `
          <div class="badge-pill">roleType: <strong>${roleType}</strong></div>
          ${isManager ? '<div class="badge-pill">マネージャー権限</div>' : ""}
          ${isAdmin ? '<div class="badge-pill">Admin権限</div>' : ""}
          <br />
          このページでは、求人マスタ（recruitJobs）を作成・一覧管理します。
          将来的に応募情報（applications）や面接フローとも連携する想定です。
        `;

        const allowed = applyAccessControl(roleType, isManager, isAdmin);
        if (!allowed) return;

        loadingEl.style.display = "none";
        contentSection.style.display = "block";

        // 新規作成時の初期値
        jobTypeSelect.value = "full-time";
        jobStatusSelect.value = "open";

        // Firestore 購読開始
        subscribeJobs();

      } catch (err) {
        console.error("init error:", err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
        loadingEl.textContent =
          "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    });
  </script>
</body>
</html>
