<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna - ç®¡ç†ç”¨ãƒšãƒ¼ã‚¸</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      background: #f4f6ff;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    h2 {
      margin-top: 28px;
      padding-left: 8px;
      border-left: 5px solid #8a9dff;
      font-size: 16px;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px 16px;
      margin-top: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 8px;
    }
    input, textarea, select {
      width: 100%;
      padding: 6px 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #d0d4ea;
      font-size: 13px;
      box-sizing: border-box;
      background: #fafbff;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    button {
      margin-top: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #8a9dff, #c382ff);
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.secondary {
      background: #e1e4ff;
      color: #333;
      margin-right: 6px;
    }
    .msg {
      font-size: 12px;
      margin-top: 4px;
      color: #555;
    }
    .error { color: #d32f2f; }
    .success { color: #0f9d58; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e3f0;
      text-align: left;
    }
    th {
      background: #f2f3ff;
      font-weight: 600;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .small { font-size: 12px; color: #666; }
    .row-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .inline-select, .inline-input {
      padding: 2px 4px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid #d0d4ea;
    }
    .inline-btn {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      background: #c382ff;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>ğŸ›° Star Little Luna - ã‚¹ã‚¿ãƒƒãƒ• / å½¹å“¡ãƒšãƒ¼ã‚¸</h1>
      <div class="small" id="staffInfo">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­...</div>
    </div>
    <button id="logoutBtn" class="secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <!-- â‘  é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ -->
  <h2>â‘  é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆç®¡ç†</h2>
  <div class="section">
    <div class="small">ã‚¿ãƒ¬ãƒ³ãƒˆã‹ã‚‰ã®é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ã§ã™ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ãƒ¡ãƒ¢ã‚’æ›´æ–°ã§ãã¾ã™ã€‚</div>
    <table>
      <thead>
        <tr>
          <th>ã‚¿ãƒ¬ãƒ³ãƒˆ</th>
          <th>å¸Œæœ›æ—¥æ™‚</th>
          <th>ç†ç”±</th>
          <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th>ãƒ¡ãƒ¢</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="meetingTableBody">
        <tr><td colspan="6" class="small">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
    <div id="meetingMsg" class="msg"></div>
  </div>

  <!-- â‘¡ å‹¤æ€  -->
  <h2>â‘¡ è‡ªåˆ†ã®å‹¤æ€ ï¼ˆå‡ºå‹¤ãƒ»é€€å‹¤ï¼‰</h2>
  <div class="section">
    <button id="startWorkBtn">å‡ºå‹¤</button>
    <button id="endWorkBtn" class="secondary">é€€å‹¤</button>
    <div id="attendanceMsg" class="msg"></div>
    <div id="attendanceToday" class="msg"></div>
  </div>

  <!-- â‘¢ ã‚·ãƒ•ãƒˆ -->
  <h2>â‘¢ è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆç®¡ç†</h2>
  <div class="section">
    <div class="small">è‡ªåˆ†ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’ç™»éŒ²ã§ãã¾ã™ã€‚</div>

    <label>æ—¥ä»˜</label>
    <input type="date" id="shiftDate">

    <label>é–‹å§‹æ™‚åˆ»</label>
    <input type="time" id="shiftStart">

    <label>çµ‚äº†æ™‚åˆ»</label>
    <input type="time" id="shiftEnd">

    <button id="addShiftBtn">ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²</button>
    <div id="shiftMsg" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th>æ—¥ä»˜</th>
          <th>é–‹å§‹</th>
          <th>çµ‚äº†</th>
        </tr>
      </thead>
      <tbody id="shiftTableBody">
        <tr><td colspan="3" class="small">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      collection,
      serverTimestamp,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const staffInfoEl      = document.getElementById("staffInfo");
    const logoutBtn        = document.getElementById("logoutBtn");

    const meetingTableBody = document.getElementById("meetingTableBody");
    const meetingMsgEl     = document.getElementById("meetingMsg");

    const startWorkBtn     = document.getElementById("startWorkBtn");
    const endWorkBtn       = document.getElementById("endWorkBtn");
    const attendanceMsgEl  = document.getElementById("attendanceMsg");
    const attendanceTodayEl= document.getElementById("attendanceToday");

    const shiftDateEl      = document.getElementById("shiftDate");
    const shiftStartEl     = document.getElementById("shiftStart");
    const shiftEndEl       = document.getElementById("shiftEnd");
    const addShiftBtn      = document.getElementById("addShiftBtn");
    const shiftMsgEl       = document.getElementById("shiftMsg");
    const shiftTableBody   = document.getElementById("shiftTableBody");

    let currentUser = null;
    let meetingData = []; // {id, data}

    function setMsg(el, text, type = "") {
      el.textContent = text;
      el.className = "msg";
      if (type === "error")   el.classList.add("error");
      if (type === "success") el.classList.add("success");
    }

    // ==== ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ ====
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "login.html";
        return;
      }
      currentUser = user;
      staffInfoEl.textContent =
        `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || user.email || "ã‚¹ã‚¿ãƒƒãƒ•"}`;

      await loadTodayAttendance();
      await loadShifts();
      await loadMeetingRequests();
    });

    // ==== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ====
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      location.href = "login.html";
    });

    // ==== â‘  é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸€è¦§ ====
    async function loadMeetingRequests() {
      try {
        const snap = await getDocs(collection(db, "meetingRequests"));
        meetingData = [];
        snap.forEach(docSnap => {
          meetingData.push({ id: docSnap.id, data: docSnap.data() });
        });
        renderMeetingTable();
      } catch (e) {
        console.error(e);
        meetingTableBody.innerHTML =
          '<tr><td colspan="6" class="small">é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆèª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }

    function renderMeetingTable() {
      if (meetingData.length === 0) {
        meetingTableBody.innerHTML =
          '<tr><td colspan="6" class="small">é¢è«‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        return;
      }

      meetingTableBody.innerHTML = "";
      for (const { id, data } of meetingData) {
        const tr = document.createElement("tr");

        const tdTalent = document.createElement("td");
        tdTalent.textContent = data.talentName || data.uid || "-";

        const tdDate = document.createElement("td");
        tdDate.textContent = `${data.date || "-"} ${data.time || ""}`;

        const tdReason = document.createElement("td");
        tdReason.textContent = data.reason || "";

        const tdStatus = document.createElement("td");
        const select = document.createElement("select");
        select.className = "inline-select";
        ["pending","accepted","rejected"].forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent =
            s === "pending"  ? "ä¿ç•™" :
            s === "accepted" ? "æ‰¿èª" : "å´ä¸‹";
          if (data.status === s) opt.selected = true;
          select.appendChild(opt);
        });
        tdStatus.appendChild(select);

        const tdNote = document.createElement("td");
        const input = document.createElement("input");
        input.className = "inline-input";
        input.value = data.managerNote || "";
        tdNote.appendChild(input);

        const tdActions = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "inline-btn";
        btn.textContent = "ä¿å­˜";
        btn.addEventListener("click", async () => {
          try {
            await updateDoc(doc(db, "meetingRequests", id), {
              status: select.value,
              managerNote: input.value,
              updatedAt: serverTimestamp()
            });
            setMsg(meetingMsgEl, "æ›´æ–°ã—ã¾ã—ãŸã€‚", "success");
          } catch (e) {
            console.error(e);
            setMsg(meetingMsgEl, "æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
          }
        });
        tdActions.appendChild(btn);

        tr.appendChild(tdTalent);
        tr.appendChild(tdDate);
        tr.appendChild(tdReason);
        tr.appendChild(tdStatus);
        tr.appendChild(tdNote);
        tr.appendChild(tdActions);

        meetingTableBody.appendChild(tr);
      }
    }

    // ==== â‘¡ å‹¤æ€  ====
    async function loadTodayAttendance() {
      if (!currentUser) return;
      const today = new Date().toISOString().slice(0,10);
      try {
        const ref = doc(db, "attendance", currentUser.uid, "records", today);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          setMsg(attendanceTodayEl, `æœ¬æ—¥ã®å‹¤æ€ ï¼ˆ${today}ï¼‰ï¼šæœªç™»éŒ²`);
        } else {
          const d = snap.data();
          setMsg(
            attendanceTodayEl,
            `æœ¬æ—¥ã®å‹¤æ€ ï¼ˆ${today}ï¼‰ï¼šå‡ºå‹¤ ${d.start || "-"} / é€€å‹¤ ${d.end || "-"}`
          );
        }
      } catch (e) {
        console.error(e);
        setMsg(attendanceTodayEl, "å‹¤æ€ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    }

    startWorkBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const today = new Date().toISOString().slice(0,10);
      const now   = new Date().toLocaleTimeString("ja-JP", { hour12: false });
      try {
        await setDoc(
          doc(db, "attendance", currentUser.uid, "records", today),
          { start: now, updatedAt: serverTimestamp() },
          { merge: true }
        );
        setMsg(attendanceMsgEl, "å‡ºå‹¤ã‚’æ‰“åˆ»ã—ã¾ã—ãŸã€‚", "success");
        await loadTodayAttendance();
      } catch (e) {
        console.error(e);
        setMsg(attendanceMsgEl, "å‡ºå‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    endWorkBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const today = new Date().toISOString().slice(0,10);
      const now   = new Date().toLocaleTimeString("ja-JP", { hour12: false });
      try {
        await setDoc(
          doc(db, "attendance", currentUser.uid, "records", today),
          { end: now, updatedAt: serverTimestamp() },
          { merge: true }
        );
        setMsg(attendanceMsgEl, "é€€å‹¤ã‚’æ‰“åˆ»ã—ã¾ã—ãŸã€‚", "success");
        await loadTodayAttendance();
      } catch (e) {
        console.error(e);
        setMsg(attendanceMsgEl, "é€€å‹¤æ‰“åˆ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });

    // ==== â‘¢ ã‚·ãƒ•ãƒˆ ====
    async function loadShifts() {
      if (!currentUser) return;
      try {
        const snap = await getDocs(collection(db, "shifts", currentUser.uid, "items"));
        shiftTableBody.innerHTML = "";
        let count = 0;
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.date || "-"}</td>
            <td>${d.start || "-"}</td>
            <td>${d.end   || "-"}</td>
          `;
          shiftTableBody.appendChild(tr);
          count++;
        });
        if (count === 0) {
          shiftTableBody.innerHTML =
            '<tr><td colspan="3" class="small">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚·ãƒ•ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>';
        }
      } catch (e) {
        console.error(e);
        shiftTableBody.innerHTML =
          '<tr><td colspan="3" class="small">ã‚·ãƒ•ãƒˆèª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</td></tr>';
      }
    }

    addShiftBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const date  = shiftDateEl.value;
      const start = shiftStartEl.value;
      const end   = shiftEndEl.value;

      if (!date || !start || !end) {
        setMsg(shiftMsgEl, "æ—¥ä»˜ãƒ»é–‹å§‹ãƒ»çµ‚äº†ã®ã™ã¹ã¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "error");
        return;
      }

      try {
        await addDoc(collection(db, "shifts", currentUser.uid, "items"), {
          date,
          start,
          end,
          createdAt: serverTimestamp()
        });
        setMsg(shiftMsgEl, "ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚", "success");
        shiftDateEl.value = "";
        shiftStartEl.value = "";
        shiftEndEl.value = "";
        await loadShifts();
      } catch (e) {
        console.error(e);
        setMsg(shiftMsgEl, "ã‚·ãƒ•ãƒˆç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", "error");
      }
    });
  </script>
</body>
</html>
