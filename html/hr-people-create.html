<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - 人事アカウント新規作成</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-primary-soft: #f6ebff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.82), rgba(255,255,255,0.97)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 900px;
      margin: 0 auto;
      padding: 18px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ヘッダー */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 110px;
      height: 110px;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* ユーザー＆ボタン */
    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .btn-secondary {
      background: #f7f5ff;
    }

    .btn-danger {
      border: 1px solid #ffc4ce;
      background: #ffe8eb;
      color: #b21f2d;
    }

    /* バナー・インフォ */
    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #e63946;
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible {
      display: block;
    }

    .info-banner {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--sl-muted);
      background: #f6f2ff;
      border: 1px solid #e1d7ff;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    .loading-text {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* カード */
    .card {
      background: var(--sl-card);
      border-radius: 18px;
      padding: 14px 16px 16px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 25px rgba(186,199,255,0.4);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .card-sub {
      font-size: 11px;
      color: var(--sl-muted);
      margin-bottom: 10px;
    }

    /* フォーム */
    .form-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .form-section-caption {
      font-size: 11px;
      color: var(--sl-muted);
      margin-bottom: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    .form-grid-full {
      grid-template-columns: 1fr;
    }

    @media (max-width: 720px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .brand-logo {
        width: 90px;
        height: 90px;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--sl-border);
      outline: none;
      background: #ffffff;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 1px rgba(195,130,255,0.45);
    }

    .form-textarea {
      min-height: 90px;
      resize: vertical;
    }

    .hint {
      font-size: 10px;
      color: var(--sl-muted);
    }

    .form-row-full {
      grid-column: 1 / -1;
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .form-status {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 6px;
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e3d6ff;
      background: #f7f3ff;
      color: var(--sl-primary);
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <div class="brand-logo">
            <img src="../assets/slllogo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-sub">HR Management Center</div>
          </div>
        </div>
        <div class="tag">HR / People Create</div>
        <div class="page-title">人事アカウント新規登録</div>
        <div class="page-subtitle">
          ログインに必要なメールアドレス・初期パスワードを設定し、Firebase Auth アカウントと
          Firestore人事マスタを同時に作成します。（Admin / 役員専用）
        </div>
      </div>

      <div class="user-block">
        <button class="btn" id="back-list-btn">一覧に戻る</button>
        <button class="btn" id="back-hr-dashboard-btn">人事ダッシュボード</button>
        <button class="btn" id="back-admin-btn">Adminトップ</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <!-- バナー -->
    <div id="error-banner" class="error-banner"></div>
    <div class="info-banner">
      <span id="role-info-text">
        ログイン情報を確認しています…
      </span>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading-text">
      Firebase Auth / Firestore への接続を準備中です…
    </div>

    <!-- フォーム本体 -->
    <section id="form-section" style="display:none;">
      <div class="card">
        <div class="card-title">人事アカウント登録フォーム</div>
        <div class="card-sub">
          Authユーザー作成にはセカンダリFirebase Appを利用するため、現在ログイン中のAdminセッションは維持されます。
        </div>

        <form id="create-form" autocomplete="off">
          <!-- ログイン情報 -->
          <div class="form-section-title">① ログイン情報（必須）</div>
          <div class="form-section-caption">
            後で本人に共有するメールアドレスと初期パスワードです。
            初期パスワードは8文字以上を推奨します。
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="login-email">
                ログイン用メールアドレス <span style="color:var(--danger);">*</span>
              </label>
              <input id="login-email" type="email" class="form-input" required />
              <div class="hint">会社メール推奨：例）firstname.lastname@libertysync.com</div>
            </div>
            <div class="form-group">
              <label class="form-label" for="login-password">
                初期パスワード <span style="color:var(--danger);">*</span>
              </label>
              <div style="display:flex; gap:6px; align-items:center;">
                <input id="login-password" type="text" class="form-input" required />
                <button type="button" class="btn btn-secondary" id="gen-password-btn" style="white-space:nowrap;">
                  自動生成
                </button>
              </div>
              <div class="hint">英数字8文字以上。共有後は本人に変更してもらってください。</div>
            </div>
            <div class="form-group form-row-full">
              <label class="form-label" for="login-password-confirm">
                初期パスワード（確認） <span style="color:var(--danger);">*</span>
              </label>
              <input id="login-password-confirm" type="text" class="form-input" required />
              <div class="hint">確認のため、同じパスワードを再入力してください。</div>
            </div>
          </div>

          <!-- 基本情報 -->
          <div class="form-section-title">② 基本情報</div>
          <div class="form-section-caption">
            社内人事マスタとして必要な情報を入力します。
            <span class="pill-small">氏名は必須</span>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="displayName">
                氏名 <span style="color:var(--danger);">*</span>
              </label>
              <input id="displayName" type="text" class="form-input" required />
            </div>
            <div class="form-group">
              <label class="form-label" for="furigana">ふりがな</label>
              <input id="furigana" type="text" class="form-input" placeholder="にしざわ たいき など" />
            </div>

            <div class="form-group">
              <label class="form-label" for="roleType">roleType</label>
              <select id="roleType" class="form-select">
                <option value="staff">staff（社員）</option>
                <option value="executive">executive（役員）</option>
                <option value="talent">talent（タレント）</option>
              </select>
              <div class="hint">※HR画面では主に staff / executive を想定</div>
            </div>
            <div class="form-group">
              <label class="form-label">権限フラグ</label>
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                  <input id="isManager" type="checkbox" />
                  マネージャー
                </label>
                <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                  <input id="isAdmin" type="checkbox" />
                  Admin権限
                </label>
              </div>
            </div>
          </div>

          <!-- 組織情報 -->
          <div class="form-section-title">③ 組織情報</div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="dept">部署</label>
              <input id="dept" type="text" class="form-input" placeholder="例：経営本部" />
            </div>
            <div class="form-group">
              <label class="form-label" for="section">課 / チーム</label>
              <input id="section" type="text" class="form-input" placeholder="例：人事企画課" />
            </div>
            <div class="form-group">
              <label class="form-label" for="position">役職</label>
              <input id="position" type="text" class="form-input" placeholder="例：部長 / マネージャー / 担当" />
            </div>
            <div class="form-group">
              <label class="form-label" for="employmentType">雇用形態</label>
              <select id="employmentType" class="form-select">
                <option value="">未設定</option>
                <option value="fulltime">正社員</option>
                <option value="contract">契約社員</option>
                <option value="parttime">アルバイト</option>
                <option value="outsourcing">業務委託</option>
              </select>
            </div>
          </div>

          <!-- 連絡先など -->
          <div class="form-section-title">④ 連絡先・勤務情報</div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="phone">電話番号</label>
              <input id="phone" type="tel" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label" for="baseLocation">勤務地 / 拠点</label>
              <input id="baseLocation" type="text" class="form-input" placeholder="例：東京・道玄坂 HQ" />
            </div>
            <div class="form-group">
              <label class="form-label" for="status">ステータス</label>
              <select id="status" class="form-select">
                <option value="active">在籍（active）</option>
                <option value="on-leave">休職 / 産休</option>
                <option value="resigned">退職</option>
                <option value="">未設定</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="hireDate">入社日（YYYY-MM-DD）</label>
              <input id="hireDate" type="text" class="form-input" placeholder="例：2025-04-01" />
            </div>
          </div>

          <!-- 個人情報 -->
          <div class="form-section-title">⑤ 個人情報（任意）</div>
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="birthDate">生年月日（YYYY-MM-DD）</label>
              <input id="birthDate" type="text" class="form-input" />
            </div>
            <div class="form-group">
              <label class="form-label" for="address">住所</label>
              <input id="address" type="text" class="form-input" />
            </div>
          </div>
          <div class="form-group" style="margin-top:8px;">
            <label class="form-label" for="memo">人事メモ / 備考</label>
            <textarea id="memo" class="form-textarea" placeholder="評価・配属履歴・注意点など、社内で共有したい情報を記載"></textarea>
          </div>

          <div class="form-footer">
            <div class="form-status" id="form-status">
              必須項目を入力して「アカウント作成」を押してください。
            </div>
            <div style="display:flex; gap:8px;">
              <button type="button" class="btn" id="reset-btn">入力リセット</button>
              <button type="submit" class="btn btn-primary" id="submit-btn">
                アカウント作成
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </div>

  <!-- Firebase / Auth / Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase設定（共通）
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    // メインApp（管理者ログイン用）
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // セカンダリApp（新規ユーザー作成用）
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    // DOM
    const errorBanner = document.getElementById("error-banner");
    const roleInfoText = document.getElementById("role-info-text");
    const loadingEl = document.getElementById("loading");
    const formSection = document.getElementById("form-section");

    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");

    const logoutBtn = document.getElementById("logout-btn");
    const backListBtn = document.getElementById("back-list-btn");
    const backHrDashboardBtn = document.getElementById("back-hr-dashboard-btn");
    const backAdminBtn = document.getElementById("back-admin-btn");

    const createForm = document.getElementById("create-form");
    const formStatus = document.getElementById("form-status");
    const submitBtn = document.getElementById("submit-btn");
    const resetBtn = document.getElementById("reset-btn");
    const genPasswordBtn = document.getElementById("gen-password-btn");

    const loginEmail = document.getElementById("login-email");
    const loginPassword = document.getElementById("login-password");
    const loginPasswordConfirm = document.getElementById("login-password-confirm");

    const displayNameInput = document.getElementById("displayName");
    const furiganaInput = document.getElementById("furigana");
    const roleTypeSelect = document.getElementById("roleType");
    const isManagerCheck = document.getElementById("isManager");
    const isAdminCheck = document.getElementById("isAdmin");
    const deptInput = document.getElementById("dept");
    const sectionInput = document.getElementById("section");
    const positionInput = document.getElementById("position");
    const employmentTypeSelect = document.getElementById("employmentType");
    const phoneInput = document.getElementById("phone");
    const baseLocationInput = document.getElementById("baseLocation");
    const statusSelect = document.getElementById("status");
    const hireDateInput = document.getElementById("hireDate");
    const birthDateInput = document.getElementById("birthDate");
    const addressInput = document.getElementById("address");
    const memoInput = document.getElementById("memo");

    let currentAdminUid = null;
    let currentAdminName = null;

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }

    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    function applyAccessControl(isAdmin, roleType) {
      // Admin or executive 以外は画面に入れない
      if (!isAdmin && roleType !== "executive") {
        roleInfoText.textContent =
          "このページは人事アカウントを作成するための管理者専用画面です。Admin / 役員以外はアクセスできません。Adminトップへ戻ります。";
        setTimeout(() => {
          window.location.href = "./admin-dashboard.html";
        }, 2000);
        return false;
      }
      return true;
    }

    function generateRandomPassword(length = 10) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789!@#$%^&*";
      let result = "";
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function clearForm() {
      loginEmail.value = "";
      loginPassword.value = "";
      loginPasswordConfirm.value = "";
      displayNameInput.value = "";
      furiganaInput.value = "";
      roleTypeSelect.value = "staff";
      isManagerCheck.checked = false;
      isAdminCheck.checked = false;
      deptInput.value = "";
      sectionInput.value = "";
      positionInput.value = "";
      employmentTypeSelect.value = "";
      phoneInput.value = "";
      baseLocationInput.value = "";
      statusSelect.value = "active";
      hireDateInput.value = "";
      birthDateInput.value = "";
      addressInput.value = "";
      memoInput.value = "";
      formStatus.textContent = "必須項目を入力して「アカウント作成」を押してください。";
    }

    // ナビゲーション
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    backListBtn.addEventListener("click", () => {
      window.location.href = "./hr-people-list.html";
    });

    backHrDashboardBtn.addEventListener("click", () => {
      window.location.href = "./admin-hr.html";
    });

    backAdminBtn.addEventListener("click", () => {
      window.location.href = "./admin-dashboard.html";
    });

    resetBtn.addEventListener("click", () => {
      clearForm();
    });

    genPasswordBtn.addEventListener("click", () => {
      const pw = generateRandomPassword(12);
      loginPassword.value = pw;
      loginPasswordConfirm.value = pw;
      formStatus.textContent = "ランダムな初期パスワードを生成しました。";
    });

    // フォーム送信
    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();

      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      const passwordConfirm = loginPasswordConfirm.value.trim();
      const displayName = displayNameInput.value.trim();

      if (!email || !password || !passwordConfirm || !displayName) {
        showError("メールアドレス・初期パスワード・氏名は必須です。");
        formStatus.textContent = "必須項目が未入力です。";
        return;
      }
      if (password !== passwordConfirm) {
        showError("初期パスワードと確認用パスワードが一致しません。");
        formStatus.textContent = "パスワードが一致していません。";
        return;
      }
      if (password.length < 8) {
        showError("初期パスワードは8文字以上を推奨します。");
        formStatus.textContent = "パスワードが短すぎます。";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "作成中…";
      formStatus.textContent = "Firebase Authユーザーを作成しています…";

      try {
        // 1. セカンダリAppでAuthユーザー作成（管理者セッションを維持）
        const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
        const newUser = userCred.user;
        const uid = newUser.uid;

        // 2. Firestore に人事マスタ登録
        formStatus.textContent = "Firestore に人事マスタを作成しています…";

        const payload = {
          displayName,
          furigana: furiganaInput.value.trim() || "",
          roleType: roleTypeSelect.value,
          isManager: isManagerCheck.checked,
          isAdmin: isAdminCheck.checked,
          dept: deptInput.value.trim() || "",
          section: sectionInput.value.trim() || "",
          position: positionInput.value.trim() || "",
          employmentType: employmentTypeSelect.value || "",
          email,
          phone: phoneInput.value.trim() || "",
          baseLocation: baseLocationInput.value.trim() || "",
          status: statusSelect.value || "",
          hireDate: hireDateInput.value.trim() || "",
          birthDate: birthDateInput.value.trim() || "",
          address: addressInput.value.trim() || "",
          memo: memoInput.value.trim() || "",
          createdAt: serverTimestamp(),
          createdBy: currentAdminUid,
          createdByName: currentAdminName || "",
        };

        await setDoc(doc(db, "users", uid), payload, { merge: true });

        // 終了処理
        formStatus.textContent = "アカウント作成が完了しました。必要であれば、初期パスワードを本人に共有してください。";
        submitBtn.disabled = false;
        submitBtn.textContent = "アカウント作成";

        // セカンダリAuthからはログアウトしておく
        try {
          await signOut(secondaryAuth);
        } catch (errSignOut) {
          console.warn("secondaryAuth signOut error:", errSignOut);
        }

        // 入力を残すかどうかは好み。ここでは残しておくが、クリアしたければ clearForm() を呼ぶ。
        // clearForm();

      } catch (err) {
        console.error("create HR account error:", err);
        showError("アカウント作成中にエラーが発生しました。コンソールログも確認してください。");
        formStatus.textContent = "エラーが発生しました。入力内容を確認して、再度お試しください。";
        submitBtn.disabled = false;
        submitBtn.textContent = "アカウント作成";
      }
    });

    // Auth状態監視
    onAuthStateChanged(auth, async (user) => {
      hideError();

      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          loadingEl.textContent = "ユーザーデータが見つかりませんでした。";
          return;
        }

        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        currentAdminUid = user.uid;
        currentAdminName = displayName;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        roleInfoText.innerHTML = `
          <div class="badge-pill">roleType: <strong>${roleType}</strong></div>
          ${isManager ? '<div class="badge-pill">マネージャー権限</div>' : ""}
          ${isAdmin ? '<div class="badge-pill">Admin権限</div>' : ""}
          <br />
          このページでは、新しい役員・社員・タレントのログインアカウントと人事マスタを同時に作成できます。
        `;

        const allowed = applyAccessControl(isAdmin, roleType);
        if (!allowed) return;

        loadingEl.style.display = "none";
        formSection.style.display = "block";
        formStatus.textContent = "必須項目を入力して「アカウント作成」を押してください。";

      } catch (err) {
        console.error("init error:", err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
        loadingEl.textContent =
          "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    });
  </script>
</body>
</html>
