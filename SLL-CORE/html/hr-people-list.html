<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - 人事マスタ一覧</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-primary-soft: #f6ebff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.97)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ヘッダー */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 120px;
      height: 120px;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* ユーザー＆ボタン */
    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .btn-danger {
      border: 1px solid #ffc4ce;
      background: #ffe8eb;
      color: #b21f2d;
    }

    /* バナー・インフォ */
    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #e63946;
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible {
      display: block;
    }

    .info-banner {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--sl-muted);
      background: #f6f2ff;
      border: 1px solid #e1d7ff;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    .loading-text {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* メインレイアウト（一覧＋編集） */
    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.3fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    /* 一覧カード */
    .card {
      background: var(--sl-card);
      border-radius: 18px;
      padding: 12px 14px 14px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 25px rgba(186,199,255,0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .input {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      min-width: 140px;
      outline: none;
      background: #ffffff;
    }

    .input:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 1px rgba(195,130,255,0.45);
    }

    .select {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      min-width: 120px;
      outline: none;
      background: #ffffff;
    }

    .select:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 1px rgba(195,130,255,0.45);
    }

    .table-wrapper {
      width: 100%;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--sl-border);
      background: #fdfdff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 900px;
    }

    thead {
      background: #f1f3ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e6e8f4;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: var(--sl-muted);
      font-size: 11px;
    }

    tbody tr:nth-child(even) {
      background: #fafbff;
    }

    tbody tr:hover {
      background: #f4f2ff;
    }

    .pill-small {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid #e3d6ff;
      background: #f7f3ff;
      color: var(--sl-primary);
    }

    .pill-role-exec {
      border-color: #ffd1a3;
      background: #fff3e5;
      color: #e67e22;
    }

    .pill-role-staff {
      border-color: #c4f1d4;
      background: #e9fff0;
      color: #0f9d58;
    }

    .pill-role-manager {
      border-color: #ffc4ce;
      background: #ffe8eb;
      color: #b21f2d;
    }

    .pill-role-admin {
      border-color: #b3e5ff;
      background: #e3f5ff;
      color: #0277bd;
    }

    .count-text {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 4px;
    }

    /* 編集フォーム */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 10px;
      margin-top: 8px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .form-label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .form-input,
    .form-select,
    .form-textarea {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--sl-border);
      outline: none;
      background: #ffffff;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--sl-primary);
      box-shadow: 0 0 0 1px rgba(195,130,255,0.45);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row-full {
      grid-column: 1 / -1;
    }

    .form-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .form-status {
      font-size: 11px;
      color: var(--sl-muted);
      margin-top: 4px;
    }

    .highlight-id {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 11px;
      background: #f4f2ff;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #ddd9ff;
    }

    @media (max-width: 720px) {
      .brand-logo {
        width: 90px;
        height: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <div class="brand-logo">
            <img src="../assets/slllogo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-sub">HR Management Center</div>
          </div>
        </div>
        <div class="tag">HR / People Master</div>
        <div class="page-title">役員・社員マスタ一覧（編集可）</div>
        <div class="page-subtitle">
          役員・社員・マネージャー（非タレント）の全情報を一覧・検索・編集できます。
          個人情報を扱うため、Admin / 役員のみアクセス可能です。
        </div>
      </div>

      <div class="user-block">
        <button class="btn" id="back-hr-dashboard-btn">人事ダッシュボード</button>
        <button class="btn" id="back-admin-btn">Adminトップ</button>
        <button class="btn" id="go-management-btn">タレント管理</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <!-- バナー -->
    <div id="error-banner" class="error-banner"></div>
    <div class="info-banner">
      <span id="role-info-text">
        ログイン情報を確認しています…
      </span>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading-text">
      Firebase Auth / Firestore からユーザー一覧を取得中です…
    </div>

    <!-- メインエリア：一覧＋編集 -->
    <section id="main-section" style="display:none;">
      <div class="main-layout">
        <!-- 一覧 -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">人事マスタ一覧</div>
              <div class="card-sub">
                roleType が <strong>staff / executive</strong> のアカウントを表示しています
                （talent は除外）。
              </div>
            </div>
            <div class="toolbar">
              <input
                id="search-input"
                class="input"
                type="text"
                placeholder="氏名・部署・メールで検索"
              />
              <select id="role-filter" class="select">
                <option value="all">すべての役割</option>
                <option value="executive">役員のみ</option>
                <option value="staff">社員のみ</option>
                <option value="manager">マネージャーのみ</option>
                <option value="admin">Admin権限のみ</option>
              </select>
              <button class="btn" id="reload-btn">再読み込み</button>
              <button class="btn btn-primary" id="go-create-btn">新規人事登録</button>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>氏名</th>
                  <th>ふりがな</th>
                  <th>roleType</th>
                  <th>Mgr</th>
                  <th>Admin</th>
                  <th>部署</th>
                  <th>課 / チーム</th>
                  <th>役職</th>
                  <th>雇用形態</th>
                  <th>メール</th>
                  <th>電話番号</th>
                  <th>勤務地</th>
                  <th>入社日</th>
                  <th>ステータス</th>
                  <th>編集</th>
                </tr>
              </thead>
              <tbody id="people-tbody">
                <!-- JSで挿入 -->
              </tbody>
            </table>
          </div>
          <div class="count-text" id="count-text">
            0件表示中
          </div>
        </div>

        <!-- 編集フォーム -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">選択した人の詳細編集</div>
              <div class="card-sub">
                左の一覧から「編集」ボタンを押すと、このフォームに読み込まれます。
              </div>
            </div>
          </div>

          <div id="edit-meta" class="form-status">
            現在編集中のユーザー：<span id="edit-user-id" class="highlight-id">未選択</span>
          </div>

          <form id="edit-form" autocomplete="off">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="edit-displayName">氏名</label>
                <input id="edit-displayName" class="form-input" type="text" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-furigana">ふりがな</label>
                <input id="edit-furigana" class="form-input" type="text" />
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-roleType">roleType</label>
                <select id="edit-roleType" class="form-select">
                  <option value="staff">staff（社員）</option>
                  <option value="executive">executive（役員）</option>
                  <option value="talent">talent（タレント）</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">権限（フラグ）</label>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                    <input id="edit-isManager" type="checkbox" />
                    マネージャー
                  </label>
                  <label style="font-size:11px; display:flex; align-items:center; gap:4px;">
                    <input id="edit-isAdmin" type="checkbox" />
                    Admin権限
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-dept">部署</label>
                <input id="edit-dept" class="form-input" type="text" placeholder="例：経営本部" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-section">課 / チーム</label>
                <input id="edit-section" class="form-input" type="text" placeholder="例：戦略企画課" />
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-position">役職</label>
                <input id="edit-position" class="form-input" type="text" placeholder="例：部長 / マネージャー" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-employmentType">雇用形態</label>
                <select id="edit-employmentType" class="form-select">
                  <option value="">未設定</option>
                  <option value="fulltime">正社員</option>
                  <option value="contract">契約社員</option>
                  <option value="parttime">アルバイト</option>
                  <option value="outsourcing">業務委託</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-email">メールアドレス</label>
                <input id="edit-email" class="form-input" type="email" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-phone">電話番号</label>
                <input id="edit-phone" class="form-input" type="tel" />
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-baseLocation">勤務地 / 拠点</label>
                <input id="edit-baseLocation" class="form-input" type="text" placeholder="例：東京・道玄坂 HQ" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-status">ステータス</label>
                <select id="edit-status" class="form-select">
                  <option value="active">在籍（active）</option>
                  <option value="on-leave">休職 / 産休</option>
                  <option value="resigned">退職</option>
                  <option value="">未設定</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="edit-hireDate">入社日（YYYY-MM-DD）</label>
                <input id="edit-hireDate" class="form-input" type="text" placeholder="例：2025-04-01" />
              </div>
              <div class="form-group">
                <label class="form-label" for="edit-birthDate">生年月日（YYYY-MM-DD）</label>
                <input id="edit-birthDate" class="form-input" type="text" />
              </div>

              <div class="form-group form-row-full">
                <label class="form-label" for="edit-address">住所</label>
                <input id="edit-address" class="form-input" type="text" />
              </div>

              <div class="form-group form-row-full">
                <label class="form-label" for="edit-memo">メモ（人事メモ / 備考）</label>
                <textarea id="edit-memo" class="form-textarea"></textarea>
              </div>
            </div>

            <div class="form-footer">
              <button type="button" class="btn" id="reset-form-btn">選択解除</button>
              <button type="submit" class="btn btn-primary" id="save-btn" disabled>変更を保存</button>
            </div>
            <div class="form-status" id="form-status-text">
              編集するユーザーを選択してください。
            </div>
          </form>
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase / Auth / Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase設定（そのまま）
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const errorBanner = document.getElementById("error-banner");
    const roleInfoText = document.getElementById("role-info-text");
    const loadingEl = document.getElementById("loading");
    const mainSection = document.getElementById("main-section");

    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");

    const logoutBtn = document.getElementById("logout-btn");
    const goManagementBtn = document.getElementById("go-management-btn");
    const backAdminBtn = document.getElementById("back-admin-btn");
    const backHrDashboardBtn = document.getElementById("back-hr-dashboard-btn");

    const searchInput = document.getElementById("search-input");
    const roleFilter = document.getElementById("role-filter");
    const reloadBtn = document.getElementById("reload-btn");
    const goCreateBtn = document.getElementById("go-create-btn");
    const peopleTbody = document.getElementById("people-tbody");
    const countText = document.getElementById("count-text");

    // 編集フォーム
    const editForm = document.getElementById("edit-form");
    const editUserIdSpan = document.getElementById("edit-user-id");
    const formStatusText = document.getElementById("form-status-text");
    const resetFormBtn = document.getElementById("reset-form-btn");
    const saveBtn = document.getElementById("save-btn");

    const editDisplayName = document.getElementById("edit-displayName");
    const editFurigana = document.getElementById("edit-furigana");
    const editRoleType = document.getElementById("edit-roleType");
    const editIsManager = document.getElementById("edit-isManager");
    const editIsAdmin = document.getElementById("edit-isAdmin");
    const editDept = document.getElementById("edit-dept");
    const editSection = document.getElementById("edit-section");
    const editPosition = document.getElementById("edit-position");
    const editEmploymentType = document.getElementById("edit-employmentType");
    const editEmail = document.getElementById("edit-email");
    const editPhone = document.getElementById("edit-phone");
    const editBaseLocation = document.getElementById("edit-baseLocation");
    const editStatus = document.getElementById("edit-status");
    const editHireDate = document.getElementById("edit-hireDate");
    const editBirthDate = document.getElementById("edit-birthDate");
    const editAddress = document.getElementById("edit-address");
    const editMemo = document.getElementById("edit-memo");

    let allUsers = [];      // Firestoreから取得した全 users（talent除外）
    let filteredUsers = []; // フィルタ適用後
    let currentEditingId = null;

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }

    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    function applyAccessControl(isAdmin, roleType) {
      // Admin or executive 以外は閲覧禁止
      if (!isAdmin && roleType !== "executive") {
        roleInfoText.textContent =
          "このページは人事マスタ（個人情報）を扱うため、管理者専用です。Admin / 役員以外はアクセスできません。Adminトップへ戻ります。";
        setTimeout(() => {
          window.location.href = "./admin-dashboard.html";
        }, 2000);
        return false;
      }
      return true;
    }

    function userMatchesSearch(u, text) {
      if (!text) return true;
      const q = text.toLowerCase();
      const fields = [
        u.displayName,
        u.furigana,
        u.dept,
        u.section,
        u.position,
        u.email,
        u.phone,
        u.baseLocation
      ];
      return fields.some(v => (v || "").toLowerCase().includes(q));
    }

    function userMatchesRoleFilter(u, filterValue) {
      if (filterValue === "all") return true;
      if (filterValue === "executive") return u.roleType === "executive";
      if (filterValue === "staff") return u.roleType === "staff";
      if (filterValue === "manager") return !!u.isManager;
      if (filterValue === "admin") return !!u.isAdmin;
      return true;
    }

    function applyFilters() {
      const searchText = searchInput.value.trim();
      const filterValue = roleFilter.value;
      filteredUsers = allUsers.filter(u =>
        userMatchesSearch(u, searchText) && userMatchesRoleFilter(u, filterValue)
      );
      renderTable();
    }

    function renderTable() {
      peopleTbody.innerHTML = "";
      filteredUsers.forEach(u => {
        const tr = document.createElement("tr");

        // 氏名
        const tdName = document.createElement("td");
        tdName.textContent = u.displayName || "No Name";
        tr.appendChild(tdName);

        // ふりがな
        const tdFuri = document.createElement("td");
        tdFuri.textContent = u.furigana || "";
        tr.appendChild(tdFuri);

        // roleType + pill
        const tdRole = document.createElement("td");
        const pillRole = document.createElement("span");
        pillRole.className = "pill-small";
        if (u.roleType === "executive") {
          pillRole.classList.add("pill-role-exec");
          pillRole.textContent = "executive";
        } else if (u.roleType === "staff") {
          pillRole.classList.add("pill-role-staff");
          pillRole.textContent = "staff";
        } else if (u.roleType === "talent") {
          pillRole.textContent = "talent";
        } else {
          pillRole.textContent = u.roleType || "未設定";
        }
        tdRole.appendChild(pillRole);
        tr.appendChild(tdRole);

        // isManager
        const tdMgr = document.createElement("td");
        if (u.isManager) {
          const pillMgr = document.createElement("span");
          pillMgr.className = "pill-small pill-role-manager";
          pillMgr.textContent = "Mgr";
          tdMgr.appendChild(pillMgr);
        } else {
          tdMgr.textContent = "-";
        }
        tr.appendChild(tdMgr);

        // isAdmin
        const tdAdmin = document.createElement("td");
        if (u.isAdmin) {
          const pillAdm = document.createElement("span");
          pillAdm.className = "pill-small pill-role-admin";
          pillAdm.textContent = "Admin";
          tdAdmin.appendChild(pillAdm);
        } else {
          tdAdmin.textContent = "-";
        }
        tr.appendChild(tdAdmin);

        // 部署
        const tdDept = document.createElement("td");
        tdDept.textContent = u.dept || "";
        tr.appendChild(tdDept);

        // 課 / チーム
        const tdSection = document.createElement("td");
        tdSection.textContent = u.section || "";
        tr.appendChild(tdSection);

        // 役職
        const tdPos = document.createElement("td");
        tdPos.textContent = u.position || "";
        tr.appendChild(tdPos);

        // 雇用形態
        const tdEmpType = document.createElement("td");
        tdEmpType.textContent = u.employmentType || "";
        tr.appendChild(tdEmpType);

        // メール
        const tdEmail = document.createElement("td");
        tdEmail.textContent = u.email || "";
        tr.appendChild(tdEmail);

        // 電話
        const tdPhone = document.createElement("td");
        tdPhone.textContent = u.phone || "";
        tr.appendChild(tdPhone);

        // 勤務地
        const tdBase = document.createElement("td");
        tdBase.textContent = u.baseLocation || "";
        tr.appendChild(tdBase);

        // 入社日
        const tdHire = document.createElement("td");
        tdHire.textContent = u.hireDate || "";
        tr.appendChild(tdHire);

        // ステータス
        const tdStatus = document.createElement("td");
        tdStatus.textContent = u.status || "";
        tr.appendChild(tdStatus);

        // 編集ボタン
        const tdEdit = document.createElement("td");
        const btnEdit = document.createElement("button");
        btnEdit.type = "button";
        btnEdit.className = "btn";
        btnEdit.textContent = "編集";
        btnEdit.style.fontSize = "10px";
        btnEdit.dataset.uid = u.id;
        btnEdit.addEventListener("click", () => {
          loadUserToForm(u.id);
        });
        tdEdit.appendChild(btnEdit);
        tr.appendChild(tdEdit);

        peopleTbody.appendChild(tr);
      });

      countText.textContent = `${filteredUsers.length}件表示中`;
    }

    function clearForm() {
      currentEditingId = null;
      editUserIdSpan.textContent = "未選択";
      editDisplayName.value = "";
      editFurigana.value = "";
      editRoleType.value = "staff";
      editIsManager.checked = false;
      editIsAdmin.checked = false;
      editDept.value = "";
      editSection.value = "";
      editPosition.value = "";
      editEmploymentType.value = "";
      editEmail.value = "";
      editPhone.value = "";
      editBaseLocation.value = "";
      editStatus.value = "active";
      editHireDate.value = "";
      editBirthDate.value = "";
      editAddress.value = "";
      editMemo.value = "";
      formStatusText.textContent = "編集するユーザーを選択してください。";
      saveBtn.disabled = true;
    }

    function loadUserToForm(uid) {
      const u = allUsers.find(x => x.id === uid);
      if (!u) return;

      currentEditingId = uid;
      editUserIdSpan.textContent = uid;

      editDisplayName.value = u.displayName || "";
      editFurigana.value = u.furigana || "";
      editRoleType.value = u.roleType || "staff";
      editIsManager.checked = !!u.isManager;
      editIsAdmin.checked = !!u.isAdmin;
      editDept.value = u.dept || "";
      editSection.value = u.section || "";
      editPosition.value = u.position || "";
      editEmploymentType.value = u.employmentType || "";
      editEmail.value = u.email || "";
      editPhone.value = u.phone || "";
      editBaseLocation.value = u.baseLocation || "";
      editStatus.value = u.status || "active";
      editHireDate.value = u.hireDate || "";
      editBirthDate.value = u.birthDate || "";
      editAddress.value = u.address || "";
      editMemo.value = u.memo || "";

      formStatusText.textContent = "編集内容を変更して「変更を保存」を押してください。";
      saveBtn.disabled = false;
    }

    async function loadUsersFromFirestore() {
      loadingEl.style.display = "block";
      mainSection.style.display = "none";
      hideError();

      try {
        const usersRef = collection(db, "users");
        const snap = await getDocs(usersRef);
        allUsers = [];
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const roleType = d.roleType || "staff";
          // タレントは除外（タレント系画面で扱う）
          if (roleType === "talent") return;

          allUsers.push({
            id: docSnap.id,
            displayName: d.displayName || d.name || "",
            furigana: d.furigana || d.furiganaName || "",
            roleType,
            isManager: !!d.isManager,
            isAdmin: !!d.isAdmin,
            dept: d.dept || d.department || "",
            section: d.section || d.team || "",
            position: d.position || d.title || "",
            employmentType: d.employmentType || "",
            email: d.email || "",
            phone: d.phone || d.phoneNumber || "",
            baseLocation: d.baseLocation || d.base || "",
            status: d.status || "",
            hireDate: d.hireDate || "",
            birthDate: d.birthDate || "",
            address: d.address || "",
            memo: d.memo || d.note || ""
          });
        });

        filteredUsers = allUsers.slice();
        renderTable();
        loadingEl.style.display = "none";
        mainSection.style.display = "block";
      } catch (err) {
        console.error("loadUsersFromFirestore error:", err);
        showError("ユーザー一覧の取得中にエラーが発生しました。");
        loadingEl.textContent =
          "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    }

    // ログアウト
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    // 他画面遷移
    goManagementBtn.addEventListener("click", () => {
      window.location.href = "./management-menu.html";
    });
    backAdminBtn.addEventListener("click", () => {
      window.location.href = "./admin-dashboard.html";
    });
    backHrDashboardBtn.addEventListener("click", () => {
      window.location.href = "./admin-hr.html";
    });
    goCreateBtn.addEventListener("click", () => {
      window.location.href = "./hr-people-create.html";
    });

    // 検索・フィルタ
    searchInput.addEventListener("input", () => {
      applyFilters();
    });
    roleFilter.addEventListener("change", () => {
      applyFilters();
    });
    reloadBtn.addEventListener("click", () => {
      clearForm();
      loadUsersFromFirestore();
    });

    // フォームリセット
    resetFormBtn.addEventListener("click", () => {
      clearForm();
    });

    // 保存
    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();

      if (!currentEditingId) {
        formStatusText.textContent = "編集するユーザーが選択されていません。";
        return;
      }

      saveBtn.disabled = true;
      formStatusText.textContent = "保存中です…";

      try {
        const payload = {
          displayName: editDisplayName.value.trim(),
          furigana: editFurigana.value.trim(),
          roleType: editRoleType.value,
          isManager: editIsManager.checked,
          isAdmin: editIsAdmin.checked,
          dept: editDept.value.trim(),
          section: editSection.value.trim(),
          position: editPosition.value.trim(),
          employmentType: editEmploymentType.value,
          email: editEmail.value.trim(),
          phone: editPhone.value.trim(),
          baseLocation: editBaseLocation.value.trim(),
          status: editStatus.value,
          hireDate: editHireDate.value.trim(),
          birthDate: editBirthDate.value.trim(),
          address: editAddress.value.trim(),
          memo: editMemo.value.trim()
        };

        const userRef = doc(db, "users", currentEditingId);
        await updateDoc(userRef, payload);

        // ローカルデータを更新
        const idx = allUsers.findIndex(u => u.id === currentEditingId);
        if (idx >= 0) {
          allUsers[idx] = { id: currentEditingId, ...payload };
        }

        applyFilters(); // 再描画
        formStatusText.textContent = "保存しました。";
        saveBtn.disabled = false;
      } catch (err) {
        console.error("updateDoc error:", err);
        showError("保存中にエラーが発生しました。");
        formStatusText.textContent = "保存中にエラーが発生しました。";
        saveBtn.disabled = false;
      }
    });

    // Auth 状態監視
    onAuthStateChanged(auth, async (user) => {
      hideError();

      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          loadingEl.textContent = "ユーザーデータが見つかりませんでした。";
          return;
        }

        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        roleInfoText.innerHTML = `
          <div class="badge-pill">roleType: <strong>${roleType}</strong></div>
          ${isManager ? '<div class="badge-pill">マネージャー権限</div>' : ""}
          ${isAdmin ? '<div class="badge-pill">Admin権限</div>' : ""}
          <br />
          このページでは、役員・社員・マネージャーの人事マスタ（個人情報）を閲覧・編集できます。
        `;

        // アクセス制御
        const allowed = applyAccessControl(isAdmin, roleType);
        if (!allowed) return;

        // 一覧ロード
        await loadUsersFromFirestore();
        clearForm();

      } catch (err) {
        console.error(err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
        loadingEl.textContent =
          "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    });
  </script>
</body>
</html>
