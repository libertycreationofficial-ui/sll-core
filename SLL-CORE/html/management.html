<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - Management</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-primary-soft: #f6ebff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.95)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    /* コンテナ */
    .page {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* ヘッダー */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 150px;
      height: 150px;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-main {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #e63946;
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible {
      display: block;
    }

    .info-banner {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--sl-muted);
      background: #f6f2ff;
      border: 1px solid #e1d7ff;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    /* メニューカード */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      body {
        padding: 0 6px;
      }
      .page {
        padding: 16px 10px 20px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
      .top-bar {
        align-items: flex-start;
        flex-direction: column;
      }
    }

    .menu-card {
      background: var(--sl-card);
      border-radius: 20px;
      padding: 14px 14px 16px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 25px rgba(186,199,255,0.4);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 136px;
      cursor: pointer;
      text-decoration: none;
      color: var(--sl-text);
      transition: transform 0.08s ease-out, box-shadow 0.1s ease-out, border-color 0.1s;
    }

    .menu-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(186,199,255,0.5);
      border-color: var(--sl-primary-soft);
    }

    .menu-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .menu-title {
      font-size: 14px;
      font-weight: 600;
    }

    .menu-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      white-space: nowrap;
    }

    .menu-desc {
      font-size: 12px;
      color: var(--sl-muted);
      line-height: 1.5;
    }

    .menu-footer {
      margin-top: 10px;
      font-size: 11px;
      color: var(--sl-primary);
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
    }

    .menu-card[data-visible="false"] {
      display: none;
    }

    .loading-text {
      font-size: 12px;
      color: var(--sl-muted);
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <!-- ★ ロゴPNG（パスは環境に合わせて変更） -->
          <div class="brand-logo">
            <img src="../assets/slllogo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-sub">Talent Management Center</div>
          </div>
        </div>
        <div class="tag">Management View</div>
        <div class="page-title">タレント運営・マネジメントメニュー</div>
        <div class="page-subtitle">
          タレントの登録・マスタ管理・分析・スケジュール・面談など、運営に必要な機能への入口です。
        </div>
      </div>

      <div class="user-block">
        <button class="btn" id="back-dashboard-btn">ダッシュボードに戻る</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <!-- エラー・インフォ -->
    <div id="error-banner" class="error-banner"></div>
    <div id="info-banner" class="info-banner">
      <span id="role-info-text">
        ログイン情報を読み込んでいます…
      </span>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading-text">
      ユーザー情報と権限を読み込んでいます…
    </div>

    <!-- メニュー一覧 -->
    <section id="menu-grid" class="grid" style="display:none;">
      <!-- 1. タレントマスタ一覧 -->
      <a href="talents-list.html"
         class="menu-card"
         data-key="talent-list"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">タレントマスタ一覧</div>
            <div class="menu-tag">Master</div>
          </div>
          <div class="menu-desc">
            所属タレントの基本情報・ステータス・担当マネージャーなどを一覧・検索します。
            個別詳細画面への入口にもなります。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 2. タレント登録フォーム（Firebase Auth自動作成） -->
      <a href="talent-create.html"
         class="menu-card"
         data-key="talent-create"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">タレント登録フォーム</div>
            <div class="menu-tag">New Talent</div>
          </div>
          <div class="menu-desc">
            メールアドレスと初期パスワードを設定し、Firebase Auth アカウントと
            タレントマスタを同時に作成します。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 3. タレントデータ＆分析 -->
      <a href="./talent-analytics.html"
         class="menu-card"
         data-key="talent-analytics"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">タレントデータ＆分析</div>
            <div class="menu-tag">Analytics</div>
          </div>
          <div class="menu-desc">
            CSVファイルの取り込みやYouTube指標の集計から、
            登録者・再生数・同接などのパフォーマンスを可視化・分析します。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 4. タレントリアルタイムデータ -->
      <a href="./talent-realtime.html"
         class="menu-card"
         data-key="talent-realtime"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">タレントリアルタイムデータ</div>
            <div class="menu-tag">Live Monitor</div>
          </div>
          <div class="menu-desc">
            配信中タレントの同時接続数やチャンネル登録者数、
            X／Instagramのフォロワーなどのリアルタイム状況を確認します。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 5. スケジュール設定（タレント別） -->
      <a href="./talent-schedule.html"
         class="menu-card"
         data-key="talent-schedule"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">スケジュール設定（タレント別）</div>
            <div class="menu-tag">Schedule</div>
          </div>
          <div class="menu-desc">
            タレントごとの配信予定・収録・打合せ・オフ日などをカレンダー形式で管理します。
            タレント側画面とも連携します。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 6. 面談系の機能 -->
      <a href="meeting-manage.html"
         class="menu-card"
         data-key="talent-meetings"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">面談管理（リクエスト＆履歴）</div>
            <div class="menu-tag">Meetings</div>
          </div>
          <div class="menu-desc">
            タレントからの面談予約リクエストの確認・日時確定・面談履歴の記録など、
            マネジメント面談のハブとなる機能です。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>

      <!-- 7. その他（メモ・タグ管理など拡張用） -->
      <a href="./talent-extra.html"
         class="menu-card"
         data-key="talent-extra"
         data-visible-for="staff,executive">
        <div>
          <div class="menu-title-row">
            <div class="menu-title">その他（メモ・タグ管理 他）</div>
            <div class="menu-tag">Extra</div>
          </div>
          <div class="menu-desc">
            タレントメモ、タグ付け、アラート設定、案件管理など、
            拡張的なマネジメント機能をまとめていくエリアです。
          </div>
        </div>
        <div class="menu-footer">
          開く →
        </div>
      </a>
    </section>
  </div>

  <!-- Firebase / Auth / Firestore -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Your web app's Firebase configuration (そのまま使用)
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const errorBanner = document.getElementById("error-banner");
    const infoBanner = document.getElementById("info-banner");
    const roleInfoText = document.getElementById("role-info-text");
    const loadingEl = document.getElementById("loading");
    const menuGrid = document.getElementById("menu-grid");
    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");
    const logoutBtn = document.getElementById("logout-btn");
    const backDashboardBtn = document.getElementById("back-dashboard-btn");
    const menuCards = document.querySelectorAll(".menu-card");

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }

    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    function applyMenuVisibilityForManagement(roleType, isManager, isAdmin) {
      // タレントは管理画面NG → ダッシュボードに戻す
      if (roleType === "talent") {
        roleInfoText.textContent =
          "このページはタレントアカウントからは利用できません。ダッシュボードへ戻ります。";
        setTimeout(() => {
          window.location.href = "./dashboard.html";
        }, 1500);
        menuGrid.style.display = "none";
        return;
      }

      // staff / executive の場合にメニュー表示制御
      menuCards.forEach(card => {
        const visibleFor = (card.dataset.visibleFor || "").split(",").map(v => v.trim()).filter(Boolean);
        let visible = false;

        // 管理者・役員は全部見られる
        if (roleType === "executive" || isAdmin || isManager) {
          visible = true;
        } else if (roleType && visibleFor.includes(roleType)) {
          visible = true;
        }

        card.dataset.visible = visible ? "true" : "false";
        card.style.display = visible ? "flex" : "none";
      });

      menuGrid.style.display = "grid";
    }

    // ログアウト
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    // ダッシュボードに戻る
    backDashboardBtn.addEventListener("click", () => {
      // パスはプロジェクト構成に合わせて変更してOK
      window.location.href = "./dashboard.html";
    });

    // Auth 状態監視
    onAuthStateChanged(auth, async (user) => {
      hideError();

      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          loadingEl.textContent = "ユーザーデータが見つかりませんでした。";
          return;
        }

        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        roleInfoText.innerHTML = `
          <div class="badge-pill">roleType: <strong>${roleType}</strong></div>
          ${isManager ? '<div class="badge-pill">マネージャー権限</div>' : ""}
          ${isAdmin ? '<div class="badge-pill">Admin権限</div>' : ""}
          <br />
          このページでは、タレントの登録・マスタ管理・分析・スケジュール・面談などの
          マネジメント機能にアクセスできます。
        `;

        loadingEl.style.display = "none";

        // メニュー表示制御
        applyMenuVisibilityForManagement(roleType, isManager, isAdmin);

      } catch (err) {
        console.error(err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
        loadingEl.textContent = "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    });
  </script>
</body>
</html>
