<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Star Little Luna CORE - Admin Dashboard</title>
  <style>
    :root {
      --sl-bg: #f9fbff;
      --sl-gradient-from: #f5ddff;
      --sl-gradient-to: #cbe8ff;
      --sl-primary: #c382ff;
      --sl-primary-soft: #f6ebff;
      --sl-accent: #ff8ad8;
      --sl-text: #2f3244;
      --sl-muted: #8f93a8;
      --sl-card: #ffffff;
      --sl-border: #e4e6f3;
      --sl-chip-bg: #f7f7ff;
      --danger: #e63946;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Hiragino Sans", "Yu Gothic", sans-serif;
      min-height: 100vh;
      display: flex;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.97)),
        linear-gradient(135deg, var(--sl-gradient-from), var(--sl-gradient-to));
      color: var(--sl-text);
    }

    .page {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* ヘッダー */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .brand-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 150px;
      height: 150px;
      align-items: center;
      justify-content: center;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .tag {
      font-size: 11px;
      color: var(--sl-muted);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      margin-top: 4px;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--sl-muted);
    }

    .user-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-pill {
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--sl-chip-bg);
      border: 1px solid var(--sl-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #ffffff, #9fd4ff);
    }

    .user-name {
      font-weight: 600;
    }

    .user-role {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .btn {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--sl-border);
      background: #ffffff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.1s, box-shadow 0.1s, transform 0.08s;
    }

    .btn:hover {
      background: #f7f5ff;
      box-shadow: 0 4px 10px rgba(183, 188, 228, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--sl-primary), var(--sl-accent));
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(196,129,255,0.6);
    }

    .btn-primary:hover {
      box-shadow: 0 10px 22px rgba(196,129,255,0.7);
    }

    .error-banner {
      display: none;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: #e63946;
      background: #ffe8eb;
      border: 1px solid #ffc4ce;
    }

    .error-banner.visible {
      display: block;
    }

    .info-banner {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      color: var(--sl-muted);
      background: #f6f2ff;
      border: 1px solid #e1d7ff;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      margin-right: 6px;
      margin-top: 4px;
    }

    .loading-text {
      font-size: 12px;
      color: var(--sl-muted);
    }

    /* KPI 行 */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 1024px) {
      .kpi-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      body {
        padding: 0 6px;
      }
      .page {
        padding: 16px 10px 20px;
      }
      .top-bar {
        align-items: flex-start;
        flex-direction: column;
      }
      .kpi-row {
        grid-template-columns: 1fr;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .kpi-card {
      background: var(--sl-card);
      border-radius: 18px;
      padding: 12px 14px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 8px 18px rgba(186,199,255,0.4);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 700;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--sl-muted);
    }

    .kpi-pill {
      align-self: flex-start;
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #e3d6ff;
      background: #f7f3ff;
      color: var(--sl-primary);
    }

    /* メニューカード */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 8px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .menu-card {
      background: var(--sl-card);
      border-radius: 20px;
      padding: 14px 14px 16px;
      border: 1px solid var(--sl-border);
      box-shadow: 0 10px 25px rgba(186,199,255,0.4);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 136px;
      cursor: pointer;
      text-decoration: none;
      color: var(--sl-text);
      transition: transform 0.08s ease-out, box-shadow 0.1s ease-out, border-color 0.1s;
    }

    .menu-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 32px rgba(186,199,255,0.5);
      border-color: var(--sl-primary-soft);
    }

    .menu-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .menu-title {
      font-size: 14px;
      font-weight: 600;
    }

    .menu-tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f7f3ff;
      border: 1px solid #e3d6ff;
      color: var(--sl-primary);
      white-space: nowrap;
    }

    .menu-desc {
      font-size: 12px;
      color: var(--sl-muted);
      line-height: 1.5;
    }

    .menu-footer {
      margin-top: 10px;
      font-size: 11px;
      color: var(--sl-primary);
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 4px;
    }

    .menu-card[data-visible="false"] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- ヘッダー -->
    <header class="top-bar">
      <div>
        <div class="brand-block">
          <div class="brand-logo">
            <!-- ロゴパスは環境に合わせて調整 -->
            <img src="../assets/slllogo.png" alt="Star Little Luna Logo" />
          </div>
          <div>
            <div class="brand-text-sub">Company Management Center</div>
          </div>
        </div>
        <div class="tag">Admin View</div>
        <div class="page-title">会社管理ダッシュボード（Admin）</div>
        <div class="page-subtitle">
          財務・労務・人事・取引先・文書管理など、Star Little Luna社の“会社そのもの”を管理する中枢画面です。
        </div>
      </div>

      <div class="user-block">
        <button class="btn" id="go-management-btn">ダッシュボード</button>
        <div class="user-pill" id="user-pill" style="visibility:hidden;">
          <div class="user-avatar"></div>
          <div>
            <div class="user-name" id="user-name">ユーザー</div>
            <div class="user-role" id="user-role">role</div>
          </div>
        </div>
        <button class="btn" id="logout-btn">ログアウト</button>
      </div>
    </header>

    <!-- エラー・インフォ -->
    <div id="error-banner" class="error-banner"></div>
    <div id="info-banner" class="info-banner">
      <span id="role-info-text">
        ログイン情報とダッシュボードサマリーを読み込んでいます…
      </span>
    </div>

    <!-- ローディング -->
    <div id="loading" class="loading-text">
      Firebase Auth / Firestore からデータを取得中です…
    </div>

    <!-- KPI 行 -->
    <section id="kpi-section" style="display:none;">
      <div class="kpi-row">
        <!-- 今月の売上 -->
        <div class="kpi-card">
          <div class="kpi-label">今月の総売上（税抜）</div>
          <div class="kpi-value" id="kpi-sales-month">-</div>
          <div class="kpi-sub" id="kpi-sales-month-sub">集計中…</div>
          <div class="kpi-pill">財務KPI</div>
        </div>

        <!-- 未入金件数 -->
        <div class="kpi-card">
          <div class="kpi-label">未入金請求書</div>
          <div class="kpi-value" id="kpi-invoices-pending">-</div>
          <div class="kpi-sub" id="kpi-invoices-pending-sub">件</div>
          <div class="kpi-pill">入金管理</div>
        </div>

        <!-- タレント数 -->
        <div class="kpi-card">
          <div class="kpi-label">所属タレント数</div>
          <div class="kpi-value" id="kpi-talent-count">-</div>
          <div class="kpi-sub" id="kpi-talent-count-sub">Activeタレント</div>
          <div class="kpi-pill">Talent</div>
        </div>

        <!-- 社員・役員数 -->
        <div class="kpi-card">
          <div class="kpi-label">役員・社員（マネージャー含）</div>
          <div class="kpi-value" id="kpi-staff-count">-</div>
          <div class="kpi-sub" id="kpi-staff-count-sub">うち Admin 権限： - 名</div>
          <div class="kpi-pill">HR</div>
        </div>
      </div>
    </section>

    <!-- メニュー一覧 -->
    <section id="menu-section" style="display:none;">
      <div class="section-title">会社管理メニュー</div>
      <div class="grid" id="menu-grid">
        <!-- 1. 財務管理 -->
        <a href="./admin-finance.html"
           class="menu-card"
           data-key="admin-finance"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">財務管理（会計・請求・支払）</div>
              <div class="menu-tag">Finance</div>
            </div>
            <div class="menu-desc">
              売上・経費・請求書・入金・支払・発注書・支払明細書など、
              会社のお金の流れを一元管理します。freee会計連携を想定。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>

        <!-- 2. 労務管理 -->
        <a href="./admin-labor.html"
           class="menu-card"
           data-key="admin-labor"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">労務管理（給与・勤怠・契約）</div>
              <div class="menu-tag">Labor</div>
            </div>
            <div class="menu-desc">
              社員・マネージャー・アルバイトの勤怠、給与明細、全銀データ出力、
              社会保険・源泉徴収などを管理します。freee労務を参考に設計。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>

        <!-- 3. 人事管理 -->
        <a href="./admin-hr.html"
           class="menu-card"
           data-key="admin-hr"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">人事管理（役員・社員・マネージャー）</div>
              <div class="menu-tag">HR</div>
            </div>
            <div class="menu-desc">
              役員・社員・マネージャーの人事情報、評価履歴、契約状況、
              組織図などを管理します。採用・退職・異動の履歴もここから。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>

        <!-- 4. 取引先・発注管理 -->
        <a href="./admin-vendors.html"
           class="menu-card"
           data-key="admin-vendors"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">取引先・発注管理</div>
              <div class="menu-tag">Vendors</div>
            </div>
            <div class="menu-desc">
              取引先マスタ、発注書作成、振込リスト、支払予定管理など、
              対社外パートナーとのやり取りを集約します。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>

        <!-- 5. 文書・議事録管理 -->
        <a href="./admin-docs.html"
           class="menu-card"
           data-key="admin-docs"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">申請書・議事録・社内文書</div>
              <div class="menu-tag">Documents</div>
            </div>
            <div class="menu-desc">
              稟議書、経費申請書、出張申請、取締役会議事録、面談議事録など、
              会社の公式文書をテンプレート化し、PDFで一元管理します。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>

        <!-- 6. システム管理 -->
        <a href="./admin-system.html"
           class="menu-card"
           data-key="admin-system"
           data-visible-for="admin,executive">
          <div>
            <div class="menu-title-row">
              <div class="menu-title">システム管理（権限・ログ・設定）</div>
              <div class="menu-tag">System</div>
            </div>
            <div class="menu-desc">
              アカウント権限、監査ログ、バックアップ設定、各種マスタ設定など、
              SLL-CORE 全体のシステム設定を行うエリアです。
            </div>
          </div>
          <div class="menu-footer">
            開く →
          </div>
        </a>
      </div>
    </section>
  </div>

  <!-- Firebase / Auth / Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---- Firebase設定（そのまま使用）----
    const firebaseConfig = {
      apiKey: "AIzaSyAtCdoQIc-WjKp_Jl1DpAPxHOSByE3mjNM",
      authDomain: "lss-core-9ad4b.firebaseapp.com",
      projectId: "lss-core-9ad4b",
      storageBucket: "lss-core-9ad4b.firebasestorage.app",
      messagingSenderId: "783909822598",
      appId: "1:783909822598:web:7a7b7c5dd52e31fd01b107",
      measurementId: "G-CSDMWDJN3S"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const errorBanner = document.getElementById("error-banner");
    const infoBanner = document.getElementById("info-banner");
    const roleInfoText = document.getElementById("role-info-text");
    const loadingEl = document.getElementById("loading");
    const userPill = document.getElementById("user-pill");
    const userNameEl = document.getElementById("user-name");
    const userRoleEl = document.getElementById("user-role");
    const logoutBtn = document.getElementById("logout-btn");
    const goManagementBtn = document.getElementById("go-management-btn");

    const kpiSection = document.getElementById("kpi-section");
    const menuSection = document.getElementById("menu-section");
    const menuGrid = document.getElementById("menu-grid");
    const menuCards = document.querySelectorAll(".menu-card");

    const kpiSalesMonth = document.getElementById("kpi-sales-month");
    const kpiSalesMonthSub = document.getElementById("kpi-sales-month-sub");
    const kpiInvoicesPending = document.getElementById("kpi-invoices-pending");
    const kpiInvoicesPendingSub = document.getElementById("kpi-invoices-pending-sub");
    const kpiTalentCount = document.getElementById("kpi-talent-count");
    const kpiTalentCountSub = document.getElementById("kpi-talent-count-sub");
    const kpiStaffCount = document.getElementById("kpi-staff-count");
    const kpiStaffCountSub = document.getElementById("kpi-staff-count-sub");

    function showError(msg) {
      errorBanner.textContent = msg;
      errorBanner.classList.add("visible");
    }

    function hideError() {
      errorBanner.textContent = "";
      errorBanner.classList.remove("visible");
    }

    function roleLabelJa(roleType, isManager, isAdmin) {
      if (roleType === "talent") return "タレントアカウント";
      if (roleType === "staff") {
        if (isManager && isAdmin) return "管理職（Admin権限あり）";
        if (isManager) return "マネージャー / 社員";
        if (isAdmin) return "社員（Admin権限あり）";
        return "社員アカウント";
      }
      if (roleType === "executive") {
        if (isAdmin) return "役員 / 社長（Admin）";
        return "役員アカウント";
      }
      return "未設定アカウント";
    }

    function applyMenuVisibilityForAdmin(isAdmin, roleType) {
      // Admin or executive 以外はこの画面へのアクセス不可にしてもOK
      if (!isAdmin && roleType !== "executive") {
        roleInfoText.textContent =
          "このページは管理者専用です。ダッシュボードへ戻ります。";
        setTimeout(() => {
          window.location.href = "./dashboard.html";
        }, 1500);
        return;
      }

      // Admin / executive → 全メニュー表示（将来必要なら細かく制御）
      menuCards.forEach(card => {
        card.dataset.visible = "true";
        card.style.display = "flex";
      });

      kpiSection.style.display = "block";
      menuSection.style.display = "block";
    }

    // Adminサマリー読み込み
    async function loadDashboardSummary() {
      try {
        // ▼ 1. adminSummary コレクションから単一ドキュメントを読む想定
        //    例: adminSummary/dashboard にバッチ処理 or Cloud Functions で集計値を書き込んでおく
        const summaryRef = doc(db, "adminSummary", "dashboard");
        const summarySnap = await getDoc(summaryRef);

        if (summarySnap.exists()) {
          const s = summarySnap.data();
          const totalSalesMonth = s.totalSalesMonth ?? 0;          // number
          const monthLabel = s.monthLabel ?? "今月";              // "2025-12" 等
          const pendingInvoices = s.pendingInvoices ?? 0;         // number
          const talentCount = s.talentCount ?? 0;                 // number
          const staffCount = s.staffCount ?? 0;                   // number
          const adminCount = s.adminCount ?? 0;                   // number

          // 今月の売上
          kpiSalesMonth.textContent = totalSalesMonth.toLocaleString("ja-JP", {
            style: "currency",
            currency: "JPY",
            maximumFractionDigits: 0
          });
          kpiSalesMonthSub.textContent = `${monthLabel} 時点の概算値`;

          // 未入金請求書
          kpiInvoicesPending.textContent = pendingInvoices.toString();
          kpiInvoicesPendingSub.textContent = `${pendingInvoices} 件`;

          // タレント数
          kpiTalentCount.textContent = talentCount.toString();
          kpiTalentCountSub.textContent = `Activeタレント ${talentCount} 名`;

          // スタッフ数
          kpiStaffCount.textContent = staffCount.toString();
          kpiStaffCountSub.textContent = `うち Admin 権限：${adminCount} 名`;
        } else {
          // ▼ adminSummary がまだ用意されていないときのフォールバック（Firestoreを直接集計）
          await fallbackSummaryFromCollections();
        }
      } catch (err) {
        console.error("loadDashboardSummary error:", err);
        // 失敗した場合もフォールバック
        await fallbackSummaryFromCollections();
      }
    }

    // コレクションから簡易フォールバック集計
    async function fallbackSummaryFromCollections() {
      try {
        // talents コレクションから Active数
        try {
          const talentsRef = collection(db, "talents");
          const qTalents = query(talentsRef, where("status", "==", "active"));
          const talentsSnap = await getDocs(qTalents);
          kpiTalentCount.textContent = talentsSnap.size.toString();
          kpiTalentCountSub.textContent = `Activeタレント ${talentsSnap.size} 名`;
        } catch (e) {
          console.warn("talents collection fallback error:", e);
          kpiTalentCount.textContent = "-";
          kpiTalentCountSub.textContent = "talents コレクション未設定";
        }

        // users コレクションから staff / executive 数 と Admin 権限数
        try {
          const usersRef = collection(db, "users");
          const usersSnap = await getDocs(usersRef);
          let staffCount = 0;
          let adminCount = 0;
          usersSnap.forEach(docSnap => {
            const d = docSnap.data();
            const roleType = d.roleType;
            if (roleType === "staff" || roleType === "executive") {
              staffCount += 1;
            }
            if (d.isAdmin) {
              adminCount += 1;
            }
          });
          kpiStaffCount.textContent = staffCount.toString();
          kpiStaffCountSub.textContent = `うち Admin 権限：${adminCount} 名`;
        } catch (e) {
          console.warn("users collection fallback error:", e);
          kpiStaffCount.textContent = "-";
          kpiStaffCountSub.textContent = "users コレクション未設定";
        }

        // 売上 & 未入金はここではダミー（将来 collections: sales, invoices を作成）
        kpiSalesMonth.textContent = "-";
        kpiSalesMonthSub.textContent = "adminSummary または sales コレクション未設定";

        kpiInvoicesPending.textContent = "-";
        kpiInvoicesPendingSub.textContent = "invoices コレクション未設定";
      } catch (err) {
        console.error("fallbackSummaryFromCollections fatal:", err);
      }
    }

    // ログアウト
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "../login.html";
    });

    // タレント管理メニューへ
    goManagementBtn.addEventListener("click", () => {
      // すでにある management メニューに合わせてパスを調整
      window.location.href = "dashboard.html";
    });

    // Auth 状態監視
    onAuthStateChanged(auth, async (user) => {
      hideError();

      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError("ユーザー情報が登録されていません。管理者にお問い合わせください。");
          loadingEl.textContent = "ユーザーデータが見つかりませんでした。";
          return;
        }

        const data = snap.data();
        const displayName = data.displayName || user.displayName || "No Name";
        const roleType = data.roleType || "staff";
        const isManager = !!data.isManager;
        const isAdmin = !!data.isAdmin;

        userPill.style.visibility = "visible";
        userNameEl.textContent = displayName;
        userRoleEl.textContent = roleLabelJa(roleType, isManager, isAdmin);

        roleInfoText.innerHTML = `
          <div class="badge-pill">roleType: <strong>${roleType}</strong></div>
          ${isManager ? '<div class="badge-pill">マネージャー権限</div>' : ""}
          ${isAdmin ? '<div class="badge-pill">Admin権限</div>' : ""}
          <br />
          このページでは、Star Little Luna社の財務・労務・人事・取引先・社内文書など、
          “会社管理” のすべてにアクセスできます。
        `;

        loadingEl.style.display = "none";

        // 権限に応じてメニュー表示
        applyMenuVisibilityForAdmin(isAdmin, roleType);

        // ダッシュボードサマリーをロード
        await loadDashboardSummary();

      } catch (err) {
        console.error(err);
        showError("ユーザー情報の取得中にエラーが発生しました。");
        loadingEl.textContent =
          "エラーが発生しました。再読み込みしても改善しない場合は管理者に連絡してください。";
      }
    });
  </script>
</body>
</html>
